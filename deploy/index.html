<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#18181b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="The Lab - Spray Wall Climbing App for tracking problems, sends, and connecting with climbers">
  <title>The Lab - Spray Wall App</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§—</text></svg>">

  <!-- External Dependencies -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" onerror="console.error('Failed to load React')"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" onerror="console.error('Failed to load ReactDOM')"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" onerror="console.error('Failed to load Babel')"></script>
  <script>
    window.onerror = function(msg, url, line, col, error) {
      document.body.innerHTML = '<div style="padding:20px;color:red;font-family:monospace;"><h2>JavaScript Error:</h2><pre>' + msg + '\nLine: ' + line + '\nColumn: ' + col + '</pre></div>';
      return false;
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="root"></div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyARyfdAZU1YXgQ92-WgE3LQw3c9Ca3x_QU",
      authDomain: "the-lab-app-true.firebaseapp.com",
      projectId: "the-lab-app-true",
      storageBucket: "the-lab-app-true.firebasestorage.app",
      messagingSenderId: "201733314203",
      appId: "1:201733314203:web:51fe50077229dd4ca2d83e",
      measurementId: "G-V0FWNXB121"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    // Admin emails - these users have full admin access
    const ADMIN_EMAILS = ['alexanderbwittenberg@gmail.com'];

    // Firestore-backed storage layer (shared across all users)
    const storage = {
      get: async (key) => {
        try {
          // Check if this is user-specific data that should stay local
          if (key.startsWith('current-user') || key === 'user-id') {
            const value = localStorage.getItem(key);
            return value ? { value } : null;
          }

          const doc = await db.collection('data').doc(key).get();
          if (doc.exists) {
            return { value: doc.data().value };
          }
          return null;
        } catch (e) {
          console.error('Firestore get error:', e);
          // Fallback to localStorage
          const value = localStorage.getItem(key);
          return value ? { value } : null;
        }
      },
      set: async (key, value) => {
        try {
          // Keep user-specific data local
          if (key.startsWith('current-user') || key === 'user-id') {
            localStorage.setItem(key, value);
            return;
          }

          await db.collection('data').doc(key).set({ value, updatedAt: new Date().toISOString() });
        } catch (e) {
          console.error('Firestore set error:', e);
          // Fallback to localStorage
          localStorage.setItem(key, value);
        }
      },
      delete: async (key) => {
        try {
          if (key.startsWith('current-user') || key === 'user-id') {
            localStorage.removeItem(key);
            return;
          }
          await db.collection('data').doc(key).delete();
        } catch (e) {
          console.error('Firestore delete error:', e);
          localStorage.removeItem(key);
        }
      },
      list: async (prefix) => {
        try {
          // For listing, we need to query Firestore
          const snapshot = await db.collection('data').get();
          const keys = [];
          snapshot.forEach(doc => {
            if (doc.id.startsWith(prefix)) {
              keys.push(doc.id);
            }
          });
          return { keys };
        } catch (e) {
          console.error('Firestore list error:', e);
          // Fallback to localStorage
          const keys = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(prefix)) {
              keys.push(key);
            }
          }
          return { keys };
        }
      }
    };

    // Make storage available globally
    window.storage = storage;
    window.db = db;
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // Lucide icons
    const Icon = ({ name, size = 24, className = '' }) => {
      const iconRef = useRef(null);
      useEffect(() => {
        if (iconRef.current && lucide[name]) {
          iconRef.current.innerHTML = '';
          const svg = lucide.createElement(lucide[name]);
          svg.setAttribute('width', size);
          svg.setAttribute('height', size);
          if (className) {
            className.split(' ').forEach(c => {
              if (c) svg.classList.add(c);
            });
          }
          iconRef.current.appendChild(svg);
        }
      }, [name, size, className]);
      return <span ref={iconRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
    };

    const SprayWallApp = () => {
      const [activeTab, setActiveTab] = useState('archive');
      const [problems, setProblems] = useState([]);
      const [drafts, setDrafts] = useState([]);
      const [viewDrafts, setViewDrafts] = useState(false);
      const [viewingDraft, setViewingDraft] = useState(null);
      const [holds, setHolds] = useState([]);
      const [wallImage, setWallImage] = useState(null);
      const [imageScale, setImageScale] = useState(1);
      const [imagePosition, setImagePosition] = useState({ x: 0, y: 0 });
      const [isDragging, setIsDragging] = useState(false);
      const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
      const [currentHoldType, setCurrentHoldType] = useState('start');
      const [isPanning, setIsPanning] = useState(false);
      const longPressTimer = useRef(null);
      const longPressTriggered = useRef(false);
      const [problemName, setProblemName] = useState('');
      const [problemGrade, setProblemGrade] = useState('V2');
      const [setterName, setSetterName] = useState('');
      const [sortBy, setSortBy] = useState('newest');
      const [filterGradeMin, setFilterGradeMin] = useState('V0');
      const [filterGradeMax, setFilterGradeMax] = useState('V14');
      const [searchTerm, setSearchTerm] = useState('');
      const [userSends, setUserSends] = useState([]);
      const [currentUserId, setCurrentUserId] = useState(null);
      const [currentUserName, setCurrentUserName] = useState('');
      const [allUsers, setAllUsers] = useState([]);
      const [friends, setFriends] = useState([]);
      const [climbFilter, setClimbFilter] = useState('all');
      const [showWelcomeModal, setShowWelcomeModal] = useState(false);
      const [welcomeName, setWelcomeName] = useState('');
      const [friendSearch, setFriendSearch] = useState('');

      // Auth state
      const [authUser, setAuthUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);
      const [isAdmin, setIsAdmin] = useState(false);
      const [showLoginModal, setShowLoginModal] = useState(false);
      const [bannedUsers, setBannedUsers] = useState([]);
      const [featuredProblems, setFeaturedProblems] = useState([]);

      // New state for enhanced features
      const [selectedProblem, setSelectedProblem] = useState(null);
      const [showHolds, setShowHolds] = useState(true);
      const [detailZoom, setDetailZoom] = useState(1);
      const [detailPosition, setDetailPosition] = useState({ x: 0, y: 0 });
      const [detailDragging, setDetailDragging] = useState(false);
      const [detailDragStart, setDetailDragStart] = useState({ x: 0, y: 0 });
      const [comments, setComments] = useState({});
      const [newComment, setNewComment] = useState('');
      const [isSpoiler, setIsSpoiler] = useState(false);
      const [attempts, setAttempts] = useState({});
      const [holdHistory, setHoldHistory] = useState([]);
      const [holdFuture, setHoldFuture] = useState([]);
      const [showHoldNumbers, setShowHoldNumbers] = useState(false);
      const [problemTags, setProblemTags] = useState([]);
      const [filterTags, setFilterTags] = useState([]);
      const [gradeSuggestions, setGradeSuggestions] = useState({});
      const [notifications, setNotifications] = useState([]);
      const [showNotifications, setShowNotifications] = useState(false);
      const [isOnline, setIsOnline] = useState(navigator.onLine);
      const [offlineQueue, setOfflineQueue] = useState([]);
      const [activeSession, setActiveSession] = useState(null);
      const [sessionProblems, setSessionProblems] = useState([]);
      const [editingProblem, setEditingProblem] = useState(null);
      const [editingDraftId, setEditingDraftId] = useState(null);
      const [profilePicture, setProfilePicture] = useState(null);
      const [wallSection, setWallSection] = useState('');
      const [userRatings, setUserRatings] = useState({});
      const [projects, setProjects] = useState([]);
      const [personalNotes, setPersonalNotes] = useState({});
      const [sessionHistory, setSessionHistory] = useState([]);
      const [showSendModal, setShowSendModal] = useState(false);
      const [sendModalProblem, setSendModalProblem] = useState(null);
      const [sendModalRating, setSendModalRating] = useState(0);
      const [sendModalGrade, setSendModalGrade] = useState('');
      const [sendModalNotes, setSendModalNotes] = useState('');
      const [sendModalAttempts, setSendModalAttempts] = useState(1);
      const [editingSend, setEditingSend] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [isSaving, setIsSaving] = useState(false);
      const [activityFeed, setActivityFeed] = useState([]);
      const [videoBeta, setVideoBeta] = useState({});
      const [viewingProfile, setViewingProfile] = useState(null);
      const [circuits, setCircuits] = useState([]);
      const [showCircuitModal, setShowCircuitModal] = useState(false);
      const [editingCircuit, setEditingCircuit] = useState(null);
      const [newCircuitName, setNewCircuitName] = useState('');
      const [addToCircuitProblem, setAddToCircuitProblem] = useState(null);
      const [activeCircuit, setActiveCircuit] = useState(null);
      const [cameFromCircuit, setCameFromCircuit] = useState(null);
      const [problemListSource, setProblemListSource] = useState('archive'); // 'archive' or 'logbook'
      const [showRatingDetails, setShowRatingDetails] = useState(false);
      const [showSendsDetails, setShowSendsDetails] = useState(false);
      const [navigationHistory, setNavigationHistory] = useState([]);

      const touchStartRef = useRef(null);
      const detailSwipeStartRef = useRef(null);
      const lastTouchDistance = useRef(null);
      const detailImageRef = useRef(null);

      const grades = ['V0', 'V1', 'V2', 'V3', 'V4', 'V5', 'V6', 'V7', 'V8', 'V9', 'V10', 'V11', 'V12', 'V13', 'V14'];
      const availableTags = ['crimpy', 'sloper', 'powerful', 'technical', 'compression', 'dynamic', 'static', 'overhang', 'slab', 'vertical', 'roof', 'pinchy', 'endurance', 'replica'];

      // Achievement definitions
      const achievementDefs = [
        { id: 'first_send', name: 'First Send', icon: 'Trophy', description: 'Log your first send', check: (sends) => sends.length >= 1 },
        { id: 'send_10', name: 'Getting Started', icon: 'TrendingUp', description: 'Log 10 sends', check: (sends) => sends.length >= 10 },
        { id: 'send_50', name: 'Crusher', icon: 'Flame', description: 'Log 50 sends', check: (sends) => sends.length >= 50 },
        { id: 'send_100', name: 'Century Club', icon: 'Award', description: 'Log 100 sends', check: (sends) => sends.length >= 100 },
        { id: 'first_flash', name: 'Flash!', icon: 'Zap', description: 'Flash your first problem', check: (sends) => sends.some(s => s.isFlash) },
        { id: 'flash_10', name: 'Flash Master', icon: 'Star', description: 'Flash 10 problems', check: (sends) => sends.filter(s => s.isFlash).length >= 10 },
        { id: 'v3_club', name: 'V3 Club', icon: 'Mountain', description: 'Send a V3 or harder', check: (sends, grades) => sends.some(s => grades.indexOf(s.grade) >= 3) },
        { id: 'v5_club', name: 'V5 Club', icon: 'Mountain', description: 'Send a V5 or harder', check: (sends, grades) => sends.some(s => grades.indexOf(s.grade) >= 5) },
        { id: 'v7_club', name: 'V7 Club', icon: 'Mountain', description: 'Send a V7 or harder', check: (sends, grades) => sends.some(s => grades.indexOf(s.grade) >= 7) },
        { id: 'v10_club', name: 'Double Digits', icon: 'Crown', description: 'Send a V10 or harder', check: (sends, grades) => sends.some(s => grades.indexOf(s.grade) >= 10) },
        { id: 'first_setter', name: 'Route Setter', icon: 'Edit3', description: 'Set your first problem', check: (sends, grades, problemsSet) => problemsSet >= 1 },
        { id: 'setter_10', name: 'Prolific Setter', icon: 'Layers', description: 'Set 10 problems', check: (sends, grades, problemsSet) => problemsSet >= 10 },
        { id: 'beta_giver', name: 'Beta Giver', icon: 'MessageCircle', description: 'Leave 5 comments', check: (sends, grades, problemsSet, comments) => comments >= 5 },
        { id: 'social', name: 'Social Climber', icon: 'Users', description: 'Add 3 friends', check: (sends, grades, problemsSet, comments, friendCount) => friendCount >= 3 },
        { id: 'variety', name: 'Well Rounded', icon: 'PieChart', description: 'Send problems across 5+ different grades', check: (sends) => new Set(sends.map(s => s.grade)).size >= 5 },
      ];

      // Calculate earned achievements
      const getEarnedAchievements = () => {
        const problemsSet = problems.filter(p => p.setterId === currentUserId).length;
        const totalComments = Object.values(comments).flat().filter(c => c.userId === currentUserId).length;
        return achievementDefs.filter(a => a.check(userSends, grades, problemsSet, totalComments, friends.length));
      };

      // Online/offline detection
      useEffect(() => {
        const handleOnline = () => setIsOnline(true);
        const handleOffline = () => setIsOnline(false);
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);
        return () => {
          window.removeEventListener('online', handleOnline);
          window.removeEventListener('offline', handleOffline);
        };
      }, []);

      // Firebase Auth listener
      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (user) => {
          setAuthLoading(true);
          if (user) {
            setAuthUser(user);
            setIsAdmin(ADMIN_EMAILS.includes(user.email));

            // Check if user exists in our system, if not create them
            const existingUser = allUsers.find(u => u.email === user.email);
            if (existingUser) {
              setCurrentUserId(existingUser.id);
              setCurrentUserName(existingUser.name);
              localStorage.setItem('user-id', existingUser.id);
              localStorage.setItem('current-user-name', existingUser.name);
            } else {
              // Create new user from Google auth
              const newUserId = user.uid;
              const newUserName = user.displayName || user.email.split('@')[0];
              setCurrentUserId(newUserId);
              setCurrentUserName(newUserName);
              localStorage.setItem('user-id', newUserId);
              localStorage.setItem('current-user-name', newUserName);

              // Add to all users
              const newUser = {
                id: newUserId,
                name: newUserName,
                email: user.email,
                photoURL: user.photoURL,
                joinedAt: new Date().toISOString(),
                totalSends: 0,
                highestGrade: null
              };
              const updatedUsers = [...allUsers, newUser];
              setAllUsers(updatedUsers);
              await window.storage.set('all-users', JSON.stringify(updatedUsers));
            }
          } else {
            setAuthUser(null);
            setIsAdmin(false);
            // Clear local user data when signed out
            setCurrentUserId(null);
            setCurrentUserName('');
          }
          setAuthLoading(false);
        });
        return () => unsubscribe();
      }, [allUsers]);

      // Load banned users and featured problems
      useEffect(() => {
        const loadAdminData = async () => {
          try {
            const bannedResult = await window.storage.get('banned-users');
            if (bannedResult) setBannedUsers(JSON.parse(bannedResult.value));

            const featuredResult = await window.storage.get('featured-problems');
            if (featuredResult) setFeaturedProblems(JSON.parse(featuredResult.value));
          } catch (e) {
            console.log('No admin data yet');
          }
        };
        loadAdminData();
      }, []);

      // Auth functions
      const signInWithGoogle = async () => {
        try {
          await auth.signInWithPopup(googleProvider);
          setShowLoginModal(false);
        } catch (error) {
          console.error('Sign in error:', error);
          alert('Failed to sign in. Please try again.');
        }
      };

      const signOut = async () => {
        try {
          await auth.signOut();
          localStorage.removeItem('user-id');
          localStorage.removeItem('current-user-name');
        } catch (error) {
          console.error('Sign out error:', error);
        }
      };

      // Admin functions
      const banUser = async (userId) => {
        if (!isAdmin) return;
        const updated = [...bannedUsers, userId];
        setBannedUsers(updated);
        await window.storage.set('banned-users', JSON.stringify(updated));
      };

      const unbanUser = async (userId) => {
        if (!isAdmin) return;
        const updated = bannedUsers.filter(id => id !== userId);
        setBannedUsers(updated);
        await window.storage.set('banned-users', JSON.stringify(updated));
      };

      const featureProblem = async (problemId) => {
        if (!isAdmin) return;
        const updated = featuredProblems.includes(problemId)
          ? featuredProblems.filter(id => id !== problemId)
          : [...featuredProblems, problemId];
        setFeaturedProblems(updated);
        await window.storage.set('featured-problems', JSON.stringify(updated));
      };

      const deleteProblemAsAdmin = async (problemId) => {
        if (!isAdmin) return;
        if (!confirm('Are you sure you want to delete this problem? This cannot be undone.')) return;

        await window.storage.delete(`problem:${problemId}`);
        setProblems(problems.filter(p => p.id !== problemId));
        setSelectedProblem(null);
        setActiveTab('archive');
      };

      const deleteCommentAsAdmin = async (problemId, commentIndex) => {
        if (!isAdmin) return;
        const problemComments = comments[problemId] || [];
        const updated = problemComments.filter((_, idx) => idx !== commentIndex);
        const newComments = { ...comments, [problemId]: updated };
        setComments(newComments);
        await window.storage.set('all-comments', JSON.stringify(newComments));
      };

      // Admin merge users function
      const mergeUsers = async (oldUserId, newUserId) => {
        if (!isAdmin) return;
        if (!confirm(`Merge user ${oldUserId} into ${newUserId}? This will transfer all sends, problems, comments, and friends.`)) return;

        try {
          // 1. Transfer sends
          const oldSendsResult = await window.storage.get(`sends:${oldUserId}`);
          const newSendsResult = await window.storage.get(`sends:${newUserId}`);
          const oldSends = oldSendsResult ? JSON.parse(oldSendsResult.value) : [];
          const newSends = newSendsResult ? JSON.parse(newSendsResult.value) : [];
          const mergedSends = [...newSends, ...oldSends.map(s => ({ ...s, userId: newUserId }))];
          await window.storage.set(`sends:${newUserId}`, JSON.stringify(mergedSends));
          await window.storage.delete(`sends:${oldUserId}`);

          // 2. Update problems setterId
          const updatedProblems = problems.map(p => {
            if (p.setterId === oldUserId) {
              return { ...p, setterId: newUserId };
            }
            return p;
          });
          for (const p of updatedProblems) {
            if (p.setterId === newUserId) {
              await window.storage.set(`problem:${p.id}`, JSON.stringify(p));
            }
          }
          setProblems(updatedProblems);

          // 3. Update comments
          const updatedComments = { ...comments };
          for (const problemId in updatedComments) {
            updatedComments[problemId] = updatedComments[problemId].map(c => {
              if (c.userId === oldUserId) {
                return { ...c, userId: newUserId };
              }
              return c;
            });
          }
          setComments(updatedComments);
          await window.storage.set('all-comments', JSON.stringify(updatedComments));

          // 4. Update activity feed
          const feedResult = await window.storage.get('activity-feed');
          if (feedResult) {
            const feed = JSON.parse(feedResult.value);
            const updatedFeed = feed.map(a => {
              if (a.userId === oldUserId) {
                return { ...a, userId: newUserId };
              }
              return a;
            });
            await window.storage.set('activity-feed', JSON.stringify(updatedFeed));
            setActivityFeed(updatedFeed);
          }

          // 5. Transfer friends
          const oldFriendsResult = await window.storage.get(`friends:${oldUserId}`);
          const newFriendsResult = await window.storage.get(`friends:${newUserId}`);
          const oldFriends = oldFriendsResult ? JSON.parse(oldFriendsResult.value) : [];
          const newFriends = newFriendsResult ? JSON.parse(newFriendsResult.value) : [];
          const mergedFriends = [...new Set([...newFriends, ...oldFriends])];
          await window.storage.set(`friends:${newUserId}`, JSON.stringify(mergedFriends));
          await window.storage.delete(`friends:${oldUserId}`);

          // 6. Update all-users list (remove old user, keep new)
          const updatedUsers = allUsers.filter(u => u.id !== oldUserId);
          setAllUsers(updatedUsers);
          await window.storage.set('all-users', JSON.stringify(updatedUsers));

          // 7. Update ratings in problems
          for (const p of updatedProblems) {
            if (p.ratings && p.ratings.length > 0) {
              const updatedRatings = p.ratings.map(r => {
                if (typeof r === 'object' && r.userId === oldUserId) {
                  return { ...r, userId: newUserId };
                }
                return r;
              });
              const updatedProblem = { ...p, ratings: updatedRatings };
              await window.storage.set(`problem:${p.id}`, JSON.stringify(updatedProblem));
            }
          }

          alert(`Successfully merged user ${oldUserId} into ${newUserId}`);
        } catch (error) {
          console.error('Error merging users:', error);
          alert('Error merging users. Check console for details.');
        }
      };

      // Load problems from storage on mount
      useEffect(() => {
        const loadProblems = async () => {
          try {
            const result = await window.storage.list('problem:');
            if (result && result.keys) {
              const loadedProblems = await Promise.all(
                result.keys.map(async (key) => {
                  const data = await window.storage.get(key);
                  if (!data) return null;
                  const problem = JSON.parse(data.value);
                  // Ensure ratings fields are properly initialized
                  const ratings = problem.ratings || [];
                  // Calculate average handling both old format (numbers) and new format (objects with rating)
                  const ratingValues = ratings.map(r => typeof r === 'object' ? r.rating : r);
                  return {
                    ...problem,
                    ratings: ratings,
                    averageRating: problem.averageRating || (ratingValues.length > 0
                      ? ratingValues.reduce((a, b) => a + b, 0) / ratingValues.length
                      : 0),
                    sends: problem.sends || 0
                  };
                })
              );
              setProblems(loadedProblems.filter(p => p !== null));
            }
          } catch (error) {
            console.log('No saved problems yet');
          }
        };
        loadProblems();
      }, []);

      // Handle share link URL parameter
      useEffect(() => {
        if (problems.length > 0) {
          const urlParams = new URLSearchParams(window.location.search);
          const problemId = urlParams.get('problem');
          if (problemId) {
            const problem = problems.find(p => p.id === parseInt(problemId));
            if (problem) {
              setSelectedProblem(problem);
              setActiveTab('detail');
            }
          }
        }
      }, [problems]);

      // Scroll to image when navigating to detail view
      useEffect(() => {
        if (activeTab === 'detail') {
          // Scroll to top of page when viewing problem detail
          setTimeout(() => {
            window.scrollTo(0, 0);
          }, 50);
        }
      }, [activeTab, selectedProblem]);

      // Load drafts from storage
      useEffect(() => {
        const loadDrafts = async () => {
          try {
            const result = await window.storage.list('draft:');
            if (result && result.keys) {
              const loadedDrafts = await Promise.all(
                result.keys.map(async (key) => {
                  const data = await window.storage.get(key);
                  return data ? JSON.parse(data.value) : null;
                })
              );
              setDrafts(loadedDrafts.filter(d => d !== null));
            }
          } catch (error) {
            console.log('No saved drafts yet');
          }
        };
        loadDrafts();
      }, []);

      // Load user sends from storage (user-specific)
      useEffect(() => {
        const loadUserSends = async () => {
          if (!currentUserId) return;
          try {
            const result = await window.storage.get(`sends:${currentUserId}`);
            if (result) {
              setUserSends(JSON.parse(result.value));
            }
          } catch (error) {
            console.log('No user sends yet');
          }
        };
        loadUserSends();
      }, [currentUserId]);

      // Initialize current user
      useEffect(() => {
        const initUser = async () => {
          try {
            const userResult = await window.storage.get('current-user');
            if (userResult) {
              const user = JSON.parse(userResult.value);
              setCurrentUserId(user.id);
              setCurrentUserName(user.name);
              // Show welcome modal if user never set a real name
              if (!user.name || user.name === 'Climber' || user.name.trim() === '') {
                setShowWelcomeModal(true);
              }
            } else {
              // New user - show welcome modal
              const newUserId = `user_${Date.now()}`;
              setCurrentUserId(newUserId);
              setShowWelcomeModal(true);
            }
          } catch (error) {
            console.error('Error initializing user:', error);
          }
        };
        initUser();
      }, []);

      // Load all users on mount
      useEffect(() => {
        const loadAllUsers = async () => {
          try {
            const usersResult = await window.storage.get('all-users');
            if (usersResult) {
              setAllUsers(JSON.parse(usersResult.value));
            }
          } catch (error) {
            console.log('No users data yet');
          }
        };
        loadAllUsers();
      }, []);

      // Load friends when user is set
      useEffect(() => {
        const loadFriends = async () => {
          if (currentUserId) {
            try {
              const friendsResult = await window.storage.get(`friends:${currentUserId}`);
              if (friendsResult) {
                setFriends(JSON.parse(friendsResult.value));
              }
            } catch (error) {
              console.log('No friends data yet');
            }
          }
        };
        loadFriends();
      }, [currentUserId]);

      // Load comments
      useEffect(() => {
        const loadComments = async () => {
          try {
            const result = await window.storage.get('all-comments');
            if (result) {
              setComments(JSON.parse(result.value));
            }
          } catch (error) {
            console.log('No comments yet');
          }
        };
        loadComments();
      }, []);

      // Load attempts
      useEffect(() => {
        const loadAttempts = async () => {
          try {
            const result = await window.storage.get('user-attempts');
            if (result) {
              setAttempts(JSON.parse(result.value));
            }
          } catch (error) {
            console.log('No attempts yet');
          }
        };
        loadAttempts();
      }, []);

      // Reset detail view zoom when problem changes
      useEffect(() => {
        setDetailZoom(1);
        setDetailPosition({ x: 0, y: 0 });
      }, [selectedProblem?.id]);

      // Load grade suggestions
      useEffect(() => {
        const loadGradeSuggestions = async () => {
          try {
            const result = await window.storage.get('grade-suggestions');
            if (result) {
              setGradeSuggestions(JSON.parse(result.value));
            }
          } catch (error) {
            console.log('No grade suggestions yet');
          }
        };
        loadGradeSuggestions();
      }, []);

      // Load user ratings
      useEffect(() => {
        const loadUserRatings = async () => {
          try {
            const result = await window.storage.get(`user-ratings:${currentUserId}`);
            if (result) {
              setUserRatings(JSON.parse(result.value));
            }
          } catch (error) {
            console.log('No user ratings yet');
          }
        };
        if (currentUserId) loadUserRatings();
      }, [currentUserId]);

      // Load notifications
      useEffect(() => {
        const loadNotifications = async () => {
          try {
            const result = await window.storage.get(`notifications:${currentUserId}`);
            if (result) {
              setNotifications(JSON.parse(result.value));
            }
          } catch (error) {
            console.log('No notifications yet');
          }
        };
        if (currentUserId) loadNotifications();
      }, [currentUserId]);

      // Load profile picture
      useEffect(() => {
        const loadProfilePicture = async () => {
          try {
            const result = await window.storage.get(`profile-picture:${currentUserId}`);
            if (result) {
              setProfilePicture(result.value);
            }
          } catch (error) {
            console.log('No profile picture yet');
          }
        };
        if (currentUserId) loadProfilePicture();
      }, [currentUserId]);

      // Load active session
      useEffect(() => {
        const loadSession = async () => {
          try {
            const result = await window.storage.get(`active-session:${currentUserId}`);
            if (result) {
              const session = JSON.parse(result.value);
              setActiveSession(session);
              setSessionProblems(session.problems || []);
            }
          } catch (error) {
            console.log('No active session');
          }
        };
        if (currentUserId) loadSession();
      }, [currentUserId]);

      // Load projects
      useEffect(() => {
        const loadProjects = async () => {
          try {
            const result = await window.storage.get(`projects:${currentUserId}`);
            if (result) {
              setProjects(JSON.parse(result.value));
            }
          } catch (error) {
            console.log('No projects yet');
          }
        };
        if (currentUserId) loadProjects();
      }, [currentUserId]);

      // Load circuits
      useEffect(() => {
        const loadCircuits = async () => {
          try {
            const result = await window.storage.get(`circuits:${currentUserId}`);
            if (result) {
              setCircuits(JSON.parse(result.value));
            }
          } catch (error) {
            console.log('No circuits yet');
          }
        };
        if (currentUserId) loadCircuits();
      }, [currentUserId]);

      // Load personal notes
      useEffect(() => {
        const loadPersonalNotes = async () => {
          try {
            const result = await window.storage.get(`personal-notes:${currentUserId}`);
            if (result) {
              setPersonalNotes(JSON.parse(result.value));
            }
          } catch (error) {
            console.log('No personal notes yet');
          }
        };
        if (currentUserId) loadPersonalNotes();
      }, [currentUserId]);

      // Load session history
      useEffect(() => {
        const loadSessionHistory = async () => {
          try {
            const result = await window.storage.get(`session-history:${currentUserId}`);
            if (result) {
              setSessionHistory(JSON.parse(result.value));
            }
          } catch (error) {
            console.log('No session history yet');
          }
          setIsLoading(false);
        };
        if (currentUserId) {
          loadSessionHistory();
        } else {
          setIsLoading(false);
        }
      }, [currentUserId]);

      // Load activity feed and migrate missing data from user sends
      useEffect(() => {
        const loadActivityFeed = async () => {
          try {
            const result = await window.storage.get('activity-feed');
            if (result) {
              let feed = JSON.parse(result.value);

              // Migration: enrich send activities with grade/rating data from all users' sends
              const usersResult = await window.storage.get('all-users');
              if (usersResult) {
                const users = JSON.parse(usersResult.value);
                const allUserSends = [];

                // Load sends from all users
                for (const user of users) {
                  try {
                    const sendsResult = await window.storage.get(`sends:${user.id}`);
                    if (sendsResult) {
                      const sends = JSON.parse(sendsResult.value);
                      allUserSends.push(...sends.map(s => ({ ...s, userId: user.id })));
                    }
                  } catch (e) {
                    // Skip if no sends for this user
                  }
                }

                // Enrich activity feed entries with missing data
                let updated = false;
                feed = feed.map(activity => {
                  if (activity.type === 'send' && (!activity.suggestedGrade || activity.rating === undefined)) {
                    // Find matching send from user sends
                    const matchingSend = allUserSends.find(s =>
                      s.problemId === activity.problemId &&
                      s.userId === activity.userId &&
                      Math.abs(new Date(s.timestamp).getTime() - new Date(activity.timestamp).getTime()) < 60000
                    );
                    if (matchingSend) {
                      updated = true;
                      return {
                        ...activity,
                        suggestedGrade: activity.suggestedGrade || matchingSend.suggestedGrade || matchingSend.grade,
                        rating: activity.rating !== undefined ? activity.rating : (matchingSend.rating || 0)
                      };
                    }
                  }
                  return activity;
                });

                // Save updated feed if changes were made
                if (updated) {
                  await window.storage.set('activity-feed', JSON.stringify(feed));
                }
              }

              setActivityFeed(feed);
            }
          } catch (error) {
            console.log('No activity feed yet');
          }
        };
        loadActivityFeed();
      }, []);

      // Load video beta
      useEffect(() => {
        const loadVideoBeta = async () => {
          try {
            const result = await window.storage.get('video-beta');
            if (result) {
              setVideoBeta(JSON.parse(result.value));
            }
          } catch (error) {
            console.log('No video beta yet');
          }
        };
        loadVideoBeta();
      }, []);

      const handleImageClick = (e) => {
        // Don't place hold if we were panning/dragging
        if (isDragging || !wallImage || longPressTriggered.current) return;

        const rect = e.currentTarget.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;

        const newHold = {
          id: Date.now(),
          x: x,
          y: y,
          type: currentHoldType,
          order: holds.length + 1
        };

        setHoldHistory(prev => [...prev, holds]);
        setHoldFuture([]);
        setHolds([...holds, newHold]);
      };

      const removeHold = (holdId) => {
        setHoldHistory(prev => [...prev, holds]);
        setHoldFuture([]);
        setHolds(holds.filter(h => h.id !== holdId));
      };

      const changeHoldType = (holdId, newType) => {
        setHoldHistory(prev => [...prev, holds]);
        setHoldFuture([]);
        setHolds(holds.map(h => h.id === holdId ? { ...h, type: newType } : h));
      };

      const handleUndo = () => {
        if (holdHistory.length === 0) return;
        const previous = holdHistory[holdHistory.length - 1];
        setHoldHistory(prev => prev.slice(0, -1));
        setHoldFuture(prev => [holds, ...prev]);
        setHolds(previous);
      };

      const handleRedo = () => {
        if (holdFuture.length === 0) return;
        const next = holdFuture[0];
        setHoldFuture(prev => prev.slice(1));
        setHoldHistory(prev => [...prev, holds]);
        setHolds(next);
      };

      // Touch event handlers - tap to place, drag to pan, pinch to zoom
      const handleTouchStart = (e) => {
        e.preventDefault(); // Prevent default to avoid scroll/zoom conflicts
        if (e.touches.length === 1) {
          longPressTriggered.current = false;
          const touch = e.touches[0];
          touchStartRef.current = {
            x: touch.clientX,
            y: touch.clientY,
            time: Date.now(),
            moved: false
          };
        } else if (e.touches.length === 2) {
          // Two finger pinch zoom
          longPressTriggered.current = true;
          const distance = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
          );
          lastTouchDistance.current = distance;
        }
      };

      const handleTouchMove = (e) => {
        e.preventDefault();
        if (e.touches.length === 1 && touchStartRef.current) {
          const touch = e.touches[0];
          const moveDistance = Math.hypot(
            touch.clientX - touchStartRef.current.x,
            touch.clientY - touchStartRef.current.y
          );

          // If moved more than 8px, this is a pan gesture
          if (moveDistance > 8) {
            touchStartRef.current.moved = true;
            longPressTriggered.current = true;
            setIsPanning(true);

            // Calculate delta from last position
            const deltaX = touch.clientX - (touchStartRef.current.lastX || touchStartRef.current.x);
            const deltaY = touch.clientY - (touchStartRef.current.lastY || touchStartRef.current.y);

            setImagePosition(prev => ({
              x: prev.x + deltaX,
              y: prev.y + deltaY
            }));

            touchStartRef.current.lastX = touch.clientX;
            touchStartRef.current.lastY = touch.clientY;
          }
        } else if (e.touches.length === 2) {
          // Pinch to zoom
          const distance = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
          );
          if (lastTouchDistance.current) {
            const scale = distance / lastTouchDistance.current;
            setImageScale(prev => Math.max(0.5, Math.min(3, prev * scale)));
          }
          lastTouchDistance.current = distance;
        }
      };

      const handleTouchEnd = (e) => {
        if (e.touches.length === 0 && touchStartRef.current) {
          const timeDiff = Date.now() - touchStartRef.current.time;

          // Quick tap (< 250ms) and didn't move much = place hold
          if (timeDiff < 250 && !touchStartRef.current.moved && !longPressTriggered.current) {
            const container = e.currentTarget;

            // Find the overlay div (the one with position absolute that contains holds)
            // It's nested: container > transform wrapper > img + overlay
            const transformWrapper = container.querySelector('div');
            const overlay = transformWrapper?.querySelector('div');

            if (overlay) {
              const overlayRect = overlay.getBoundingClientRect();

              // Get touch position relative to the overlay (which matches image size)
              const touchX = touchStartRef.current.x - overlayRect.left;
              const touchY = touchStartRef.current.y - overlayRect.top;

              // Convert to percentage
              const x = (touchX / overlayRect.width) * 100;
              const y = (touchY / overlayRect.height) * 100;

              // Only place if within bounds
              if (x >= 0 && x <= 100 && y >= 0 && y <= 100) {
                const newHold = {
                  id: Date.now(),
                  x: x,
                  y: y,
                  type: currentHoldType,
                  order: holds.length + 1
                };

                setHoldHistory(prev => [...prev, holds]);
                setHoldFuture([]);
                setHolds([...holds, newHold]);
              }
            }
          }
        }

        touchStartRef.current = null;
        lastTouchDistance.current = null;
        setIsPanning(false);

        // Reset after a short delay
        setTimeout(() => {
          longPressTriggered.current = false;
        }, 50);
      };

      const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (event) => {
            // Compress image to reduce localStorage usage
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const maxSize = 1200; // Max width/height
              let { width, height } = img;

              if (width > maxSize || height > maxSize) {
                if (width > height) {
                  height = (height / width) * maxSize;
                  width = maxSize;
                } else {
                  width = (width / height) * maxSize;
                  height = maxSize;
                }
              }

              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              // Convert to JPEG with 0.8 quality for smaller size
              const compressedImage = canvas.toDataURL('image/jpeg', 0.8);
              setWallImage(compressedImage);
              setImageScale(1);
              setImagePosition({ x: 0, y: 0 });
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      };

      const clearWallImage = () => {
        setWallImage(null);
        setHolds([]);
        setImageScale(1);
        setImagePosition({ x: 0, y: 0 });
      };

      const handleZoomIn = () => {
        setImageScale(prev => Math.min(prev + 0.2, 3));
      };

      const handleZoomOut = () => {
        setImageScale(prev => Math.max(prev - 0.2, 0.5));
      };

      const handleMouseDown = (e) => {
        if (e.button === 0) {
          longPressTriggered.current = false;
          setDragStart({ x: e.clientX, y: e.clientY });
          // Start long press timer (200ms for mouse)
          longPressTimer.current = setTimeout(() => {
            longPressTriggered.current = true;
            setIsDragging(true);
          }, 200);
        }
      };

      const handleMouseMove = (e) => {
        if (dragStart.x !== 0 || dragStart.y !== 0) {
          const moveDistance = Math.hypot(e.clientX - dragStart.x, e.clientY - dragStart.y);

          // If moved more than 5px, start dragging immediately
          if (moveDistance > 5 && !isDragging) {
            if (longPressTimer.current) {
              clearTimeout(longPressTimer.current);
              longPressTimer.current = null;
            }
            longPressTriggered.current = true;
            setIsDragging(true);
          }

          if (isDragging) {
            setImagePosition(prev => ({
              x: prev.x + (e.clientX - dragStart.x),
              y: prev.y + (e.clientY - dragStart.y)
            }));
            setDragStart({ x: e.clientX, y: e.clientY });
          }
        }
      };

      const handleMouseUp = () => {
        if (longPressTimer.current) {
          clearTimeout(longPressTimer.current);
          longPressTimer.current = null;
        }
        setIsDragging(false);
        setDragStart({ x: 0, y: 0 });
        // Reset after short delay
        setTimeout(() => {
          longPressTriggered.current = false;
        }, 50);
      };

      const handleWheel = (e) => {
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        setImageScale(prev => Math.max(0.5, Math.min(3, prev + delta)));
      };

      const saveProblem = async (isDraft = false) => {
        const startHolds = holds.filter(h => h.type === 'start');
        const finishHolds = holds.filter(h => h.type === 'finish');

        if (!problemName || holds.length < 2) {
          alert('Please add a name and select at least 2 holds');
          return;
        }

        if (!wallImage) {
          alert('Please upload a wall photo first');
          return;
        }

        if (startHolds.length === 0 || finishHolds.length === 0) {
          alert('Please mark at least one start hold (green) and one finish hold (red)');
          return;
        }

        // Use existing draft ID if editing, otherwise create new ID
        const problemId = editingDraftId || Date.now();
        const newProblem = {
          id: problemId,
          name: problemName,
          grade: problemGrade,
          setter: setterName || currentUserName,
          setterId: currentUserId,
          holds: holds,
          wallImage: wallImage,
          ratings: [],
          averageRating: 0,
          sends: 0,
          isDraft: isDraft,
          createdAt: new Date().toISOString(),
          tags: problemTags,
          wallSection: wallSection,
          isRetired: false
        };

        try {
          if (isDraft) {
            // If editing existing draft, delete the old one first
            if (editingDraftId) {
              await window.storage.delete(`draft:${editingDraftId}`);
              setDrafts(drafts.filter(d => d.id !== editingDraftId));
            }
            await window.storage.set(`draft:${newProblem.id}`, JSON.stringify(newProblem));
            setDrafts([newProblem, ...drafts.filter(d => d.id !== editingDraftId)]);
          } else {
            // If publishing an edited draft, delete the draft
            if (editingDraftId) {
              await window.storage.delete(`draft:${editingDraftId}`);
              setDrafts(drafts.filter(d => d.id !== editingDraftId));
            }
            await window.storage.set(`problem:${newProblem.id}`, JSON.stringify(newProblem));
            setProblems([newProblem, ...problems]);

            const updatedUsers = [...allUsers];
            const userIndex = updatedUsers.findIndex(u => u.id === currentUserId);
            if (userIndex !== -1) {
              updatedUsers[userIndex].problemsCreated = (updatedUsers[userIndex].problemsCreated || 0) + 1;
            } else {
              updatedUsers.push({
                id: currentUserId,
                name: currentUserName,
                problemsCreated: 1,
                totalSends: 0,
                highestGrade: 'V0'
              });
            }
            setAllUsers(updatedUsers);
            await window.storage.set('all-users', JSON.stringify(updatedUsers));
          }

          // Reset form
          setHolds([]);
          setWallImage(null);
          setProblemName('');
          setProblemGrade('V2');
          setSetterName('');
          setImageScale(1);
          setImagePosition({ x: 0, y: 0 });
          setProblemTags([]);
          setWallSection('');
          setHoldHistory([]);
          setHoldFuture([]);
          setEditingDraftId(null);
          setActiveTab('archive');
        } catch (error) {
          console.error('Error saving problem:', error);
          alert('Failed to save problem: ' + (error.message || 'Unknown error. Try using a smaller image.'));
        }
      };

      const rateProblem = async (problemId, rating) => {
        const problemIndex = problems.findIndex(p => p.id === problemId);
        if (problemIndex === -1) return;

        const currentUserRating = userRatings[problemId];
        const updatedProblem = { ...problems[problemIndex] };

        // Ensure ratings is an array (migrate from old format if needed)
        if (!Array.isArray(updatedProblem.ratings)) {
          updatedProblem.ratings = [];
        }

        // If user clicks the same rating, remove their rating (deselect)
        if (currentUserRating === rating) {
          // Remove user's rating from the problem by filtering out their userId
          updatedProblem.ratings = updatedProblem.ratings.filter(r => {
            // Handle both old format (just numbers) and new format (objects with userId)
            if (typeof r === 'object' && r.userId) {
              return r.userId !== currentUserId;
            }
            return true; // Keep old format ratings (can't identify who made them)
          });

          // Calculate average from the ratings
          const ratingValues = updatedProblem.ratings.map(r => typeof r === 'object' ? r.rating : r);
          updatedProblem.averageRating = ratingValues.length > 0
            ? ratingValues.reduce((a, b) => a + b, 0) / ratingValues.length
            : 0;

          // Remove from user ratings
          const newUserRatings = { ...userRatings };
          delete newUserRatings[problemId];
          setUserRatings(newUserRatings);

          try {
            await window.storage.set(`user-ratings:${currentUserId}`, JSON.stringify(newUserRatings));
          } catch (error) {
            console.error('Error saving user ratings:', error);
          }
        } else {
          // Update or add rating
          const existingIndex = updatedProblem.ratings.findIndex(r =>
            typeof r === 'object' && r.userId === currentUserId
          );

          if (existingIndex > -1) {
            // Update existing rating
            updatedProblem.ratings[existingIndex] = { userId: currentUserId, rating };
          } else {
            // Add new rating as object with userId
            updatedProblem.ratings.push({ userId: currentUserId, rating });
          }

          // Calculate average from the ratings
          const ratingValues = updatedProblem.ratings.map(r => typeof r === 'object' ? r.rating : r);
          updatedProblem.averageRating = ratingValues.length > 0
            ? ratingValues.reduce((a, b) => a + b, 0) / ratingValues.length
            : 0;

          // Save user's rating
          const newUserRatings = { ...userRatings, [problemId]: rating };
          setUserRatings(newUserRatings);

          try {
            await window.storage.set(`user-ratings:${currentUserId}`, JSON.stringify(newUserRatings));
          } catch (error) {
            console.error('Error saving user ratings:', error);
          }
        }

        try {
          await window.storage.set(`problem:${problemId}`, JSON.stringify(updatedProblem));
          const newProblems = [...problems];
          newProblems[problemIndex] = updatedProblem;
          setProblems(newProblems);
          if (selectedProblem?.id === problemId) {
            setSelectedProblem(updatedProblem);
          }
        } catch (error) {
          console.error('Error rating problem:', error);
        }
      };

      // Open send modal instead of logging directly
      const openSendModal = (problemId) => {
        const problem = problems.find(p => p.id === problemId);
        if (!problem) return;
        setSendModalProblem(problem);
        setSendModalGrade(problem.grade);
        setSendModalRating(userRatings[problemId] || 0);
        setSendModalNotes('');
        setSendModalAttempts(attempts[problemId]?.attempts || 1);
        setEditingSend(null);
        setShowSendModal(true);
      };

      // Open modal to edit an existing send
      const openEditSendModal = (send) => {
        const problem = problems.find(p => p.id === send.problemId);
        if (!problem) return;
        setSendModalProblem(problem);
        setSendModalGrade(send.suggestedGrade || send.grade);
        setSendModalRating(send.rating || 0);
        setSendModalNotes(send.notes || '');
        setSendModalAttempts(send.attempts || 1);
        setEditingSend(send);
        setShowSendModal(true);
      };

      // Delete a send from the logbook
      const deleteSend = async (send) => {
        if (!confirm(`Are you sure you want to delete this send of "${send.problemName}"?`)) return;

        const updatedSends = userSends.filter(s =>
          !(s.problemId === send.problemId && s.timestamp === send.timestamp)
        );
        setUserSends(updatedSends);
        await window.storage.set(`sends:${currentUserId}`, JSON.stringify(updatedSends));

        // Decrement the problem's send count
        const problemIndex = problems.findIndex(p => p.id === send.problemId);
        if (problemIndex !== -1) {
          const updatedProblem = { ...problems[problemIndex] };
          updatedProblem.sends = Math.max(0, (updatedProblem.sends || 1) - 1);
          const updatedProblems = [...problems];
          updatedProblems[problemIndex] = updatedProblem;
          setProblems(updatedProblems);
          await window.storage.set('problems', JSON.stringify(updatedProblems));
        }
      };

      // Confirm and log/update the send
      const confirmSend = async () => {
        if (!sendModalProblem) return;

        const problemId = sendModalProblem.id;

        // If editing an existing send
        if (editingSend) {
          const isFlash = sendModalAttempts <= 1;
          const updatedSends = userSends.map(s => {
            if (s.problemId === editingSend.problemId && s.timestamp === editingSend.timestamp) {
              return {
                ...s,
                suggestedGrade: sendModalGrade,
                rating: sendModalRating,
                notes: sendModalNotes,
                attempts: sendModalAttempts,
                isFlash
              };
            }
            return s;
          });
          setUserSends(updatedSends);
          await window.storage.set(`sends:${currentUserId}`, JSON.stringify(updatedSends));

          // Update rating if provided
          if (sendModalRating > 0) {
            await rateProblem(problemId, sendModalRating);
          }

          // Always record grade vote
          await suggestGrade(problemId, sendModalGrade);

          setShowSendModal(false);
          setSendModalProblem(null);
          setEditingSend(null);
          setActiveTab('logbook');
          return;
        }

        // New send
        await logSend(problemId, sendModalRating, sendModalGrade, sendModalNotes, sendModalAttempts);
        setShowSendModal(false);
        setSendModalProblem(null);
      };

      const logSend = async (problemId, rating = 0, suggestedGrade = null, notes = '', attemptCount = null) => {
        const problemIndex = problems.findIndex(p => p.id === problemId);
        if (problemIndex === -1) return;

        const updatedProblem = { ...problems[problemIndex] };
        updatedProblem.sends += 1;

        const problemAttempts = attempts[problemId] || { attempts: 0, notes: '', firstAttemptDate: null };
        const finalAttempts = attemptCount !== null ? attemptCount : (problemAttempts.attempts || 1);
        const isFlash = finalAttempts <= 1;

        const sendEntry = {
          problemId,
          problemName: updatedProblem.name,
          grade: updatedProblem.grade,
          suggestedGrade: suggestedGrade || updatedProblem.grade,
          rating,
          timestamp: new Date().toISOString(),
          userId: currentUserId,
          attempts: finalAttempts,
          isFlash,
          notes: notes || problemAttempts.notes
        };

        // Apply rating directly to updatedProblem (don't call rateProblem to avoid race condition)
        if (rating > 0) {
          if (!Array.isArray(updatedProblem.ratings)) {
            updatedProblem.ratings = [];
          }
          const existingIndex = updatedProblem.ratings.findIndex(r =>
            typeof r === 'object' && r.userId === currentUserId
          );
          if (existingIndex > -1) {
            updatedProblem.ratings[existingIndex] = { userId: currentUserId, rating };
          } else {
            updatedProblem.ratings.push({ userId: currentUserId, rating });
          }
          const ratingValues = updatedProblem.ratings.map(r => typeof r === 'object' ? r.rating : r);
          updatedProblem.averageRating = ratingValues.length > 0
            ? ratingValues.reduce((a, b) => a + b, 0) / ratingValues.length
            : 0;

          // Save user's rating
          const newUserRatings = { ...userRatings, [problemId]: rating };
          setUserRatings(newUserRatings);
          await window.storage.set(`user-ratings:${currentUserId}`, JSON.stringify(newUserRatings));
        }

        // Always record grade vote when sending (even if same as setter's grade)
        await suggestGrade(problemId, suggestedGrade || updatedProblem.grade);

        if (activeSession) {
          // Check for duplicate sends within 3 seconds to prevent double-clicks
          const now = new Date(sendEntry.timestamp).getTime();
          const isDuplicate = sessionProblems.some(p =>
            p.type === 'send' &&
            p.problemId === problemId &&
            Math.abs(new Date(p.timestamp).getTime() - now) < 3000
          );

          if (!isDuplicate) {
            const updatedSessionProblems = [...sessionProblems, { ...sendEntry, type: 'send' }];
            setSessionProblems(updatedSessionProblems);
            const updatedSession = { ...activeSession, problems: updatedSessionProblems };
            setActiveSession(updatedSession);
            await window.storage.set(`active-session:${currentUserId}`, JSON.stringify(updatedSession));
          }
        }

        if (updatedProblem.setterId && updatedProblem.setterId !== currentUserId) {
          addNotification(updatedProblem.setterId, {
            type: 'send',
            message: `${currentUserName} sent your problem "${updatedProblem.name}"!`,
            problemId,
            timestamp: new Date().toISOString()
          });
        }

        const updatedUserSends = [sendEntry, ...userSends];
        setUserSends(updatedUserSends);

        const updatedUsers = [...allUsers];
        const userIndex = updatedUsers.findIndex(u => u.id === currentUserId);

        const gradeIndex = grades.indexOf(updatedProblem.grade);
        const currentHighest = userIndex !== -1 ? grades.indexOf(updatedUsers[userIndex].highestGrade || 'V0') : 0;

        if (userIndex !== -1) {
          updatedUsers[userIndex].totalSends = (updatedUsers[userIndex].totalSends || 0) + 1;
          if (gradeIndex > currentHighest) {
            updatedUsers[userIndex].highestGrade = updatedProblem.grade;
          }
        } else {
          updatedUsers.push({
            id: currentUserId,
            name: currentUserName,
            problemsCreated: 0,
            totalSends: 1,
            highestGrade: updatedProblem.grade
          });
        }

        setAllUsers(updatedUsers);

        try {
          await window.storage.set(`problem:${problemId}`, JSON.stringify(updatedProblem));
          await window.storage.set(`sends:${currentUserId}`, JSON.stringify(updatedUserSends));
          await window.storage.set('all-users', JSON.stringify(updatedUsers));
          const newProblems = [...problems];
          newProblems[problemIndex] = updatedProblem;
          setProblems(newProblems);

          // Add to activity feed
          addActivity({
            type: 'send',
            problemId,
            problemName: updatedProblem.name,
            grade: updatedProblem.grade,
            suggestedGrade: suggestedGrade || updatedProblem.grade,
            rating: rating || 0,
            isFlash,
            message: isFlash ? `flashed "${updatedProblem.name}" (${updatedProblem.grade})` : `sent "${updatedProblem.name}" (${updatedProblem.grade})`
          });

          // Close detail view and go back to archive
          setSelectedProblem(null);
          setActiveTab('archive');
        } catch (error) {
          console.error('Error logging send:', error);
        }
      };

      const publishDraft = async (draftId) => {
        const draft = drafts.find(d => d.id === draftId);
        if (!draft) return;

        const publishedProblem = { ...draft, isDraft: false };

        try {
          await window.storage.delete(`draft:${draftId}`);
          setDrafts(drafts.filter(d => d.id !== draftId));

          await window.storage.set(`problem:${publishedProblem.id}`, JSON.stringify(publishedProblem));
          setProblems([publishedProblem, ...problems]);

          const updatedUsers = [...allUsers];
          const userIndex = updatedUsers.findIndex(u => u.id === currentUserId);
          if (userIndex !== -1) {
            updatedUsers[userIndex].problemsCreated = (updatedUsers[userIndex].problemsCreated || 0) + 1;
          } else {
            updatedUsers.push({
              id: currentUserId,
              name: currentUserName,
              problemsCreated: 1,
              totalSends: 0,
              highestGrade: 'V0'
            });
          }
          setAllUsers(updatedUsers);
          await window.storage.set('all-users', JSON.stringify(updatedUsers));

          // Add to activity feed
          addActivity({
            type: 'set',
            problemId: publishedProblem.id,
            problemName: publishedProblem.name,
            grade: publishedProblem.grade,
            message: `set a new problem "${publishedProblem.name}" (${publishedProblem.grade})`
          });
        } catch (error) {
          console.error('Error publishing draft:', error);
        }
      };

      const deleteDraft = async (draftId) => {
        try {
          await window.storage.delete(`draft:${draftId}`);
          setDrafts(drafts.filter(d => d.id !== draftId));
        } catch (error) {
          console.error('Error deleting draft:', error);
        }
      };

      const editDraft = (draftId) => {
        const draft = drafts.find(d => d.id === draftId);
        if (!draft) return;

        // Populate create form with draft data
        setProblemName(draft.name || '');
        setProblemGrade(draft.grade || 'V2');
        setSetterName(draft.setter || '');
        setWallSection(draft.wallSection || '');
        setProblemTags(draft.tags || []);
        setHolds(draft.holds || []);
        setWallImage(draft.wallImage || null);
        setImageScale(1);
        setImagePosition({ x: 0, y: 0 });
        setEditingDraftId(draftId);
        setActiveTab('create');
      };

      // Navigation history helper (defined early for use by other functions)
      const saveNavigationHistory = () => {
        const currentState = {
          tab: activeTab,
          selectedProblem: selectedProblem?.id,
          viewingProfile: viewingProfile?.id,
          activeCircuit: activeCircuit?.id,
          problemListSource: problemListSource
        };
        setNavigationHistory(prev => [...prev.slice(-10), currentState]);
      };

      // Navigate to a user's profile page
      const viewUserProfile = (user) => {
        if (!user) return;
        saveNavigationHistory();
        setViewingProfile(user);
        setActiveTab('profile');
      };

      const addFriend = async (friendId) => {
        if (friends.includes(friendId)) return;

        const updatedFriends = [...friends, friendId];
        setFriends(updatedFriends);

        try {
          await window.storage.set(`friends:${currentUserId}`, JSON.stringify(updatedFriends));

          // Send notification to the person being added
          await addNotification(friendId, {
            type: 'friend_added',
            message: `${currentUserName} added you as a friend!`,
            fromUserId: currentUserId,
            fromUserName: currentUserName,
            timestamp: new Date().toISOString()
          });
        } catch (error) {
          console.error('Error adding friend:', error);
        }
      };

      const removeFriend = async (friendId) => {
        const updatedFriends = friends.filter(id => id !== friendId);
        setFriends(updatedFriends);

        try {
          await window.storage.set(`friends:${currentUserId}`, JSON.stringify(updatedFriends));
        } catch (error) {
          console.error('Error removing friend:', error);
        }
      };

      // Activity feed function
      const addActivity = async (activity) => {
        const newActivity = {
          id: Date.now(),
          userId: currentUserId,
          userName: currentUserName,
          timestamp: new Date().toISOString(),
          ...activity
        };
        const updatedFeed = [newActivity, ...activityFeed].slice(0, 100); // Keep last 100 activities
        setActivityFeed(updatedFeed);
        try {
          await window.storage.set('activity-feed', JSON.stringify(updatedFeed));
        } catch (error) {
          console.error('Error saving activity:', error);
        }
      };

      // Video beta functions
      const addVideoBeta = async (problemId, videoData) => {
        const newVideo = {
          id: Date.now(),
          problemId,
          userId: currentUserId,
          userName: currentUserName,
          videoUrl: videoData,
          timestamp: new Date().toISOString()
        };
        const problemVideos = videoBeta[problemId] || [];
        const updatedVideoBeta = {
          ...videoBeta,
          [problemId]: [...problemVideos, newVideo]
        };
        setVideoBeta(updatedVideoBeta);
        try {
          await window.storage.set('video-beta', JSON.stringify(updatedVideoBeta));
          // Add to activity feed
          const problem = problems.find(p => p.id === problemId);
          addActivity({
            type: 'video',
            problemId,
            problemName: problem?.name || 'Unknown',
            message: `shared video beta for "${problem?.name}"`
          });
        } catch (error) {
          console.error('Error saving video beta:', error);
        }
      };

      const deleteVideoBeta = async (problemId, videoId) => {
        const problemVideos = videoBeta[problemId] || [];
        const updatedVideos = problemVideos.filter(v => v.id !== videoId);
        const updatedVideoBeta = {
          ...videoBeta,
          [problemId]: updatedVideos
        };
        setVideoBeta(updatedVideoBeta);
        try {
          await window.storage.set('video-beta', JSON.stringify(updatedVideoBeta));
        } catch (error) {
          console.error('Error deleting video:', error);
        }
      };

      const updateUserName = async (newName) => {
        setCurrentUserName(newName);
        const user = {
          id: currentUserId,
          name: newName,
          createdAt: new Date().toISOString()
        };

        try {
          await window.storage.set('current-user', JSON.stringify(user));

          const updatedUsers = allUsers.map(u =>
            u.id === currentUserId ? { ...u, name: newName } : u
          );
          setAllUsers(updatedUsers);
          await window.storage.set('all-users', JSON.stringify(updatedUsers));
        } catch (error) {
          console.error('Error updating name:', error);
        }
      };

      const completeWelcome = async () => {
        if (!welcomeName.trim()) return;

        const user = {
          id: currentUserId,
          name: welcomeName.trim(),
          createdAt: new Date().toISOString()
        };

        try {
          await window.storage.set('current-user', JSON.stringify(user));
          setCurrentUserName(welcomeName.trim());

          // Add to all users list
          const existingUser = allUsers.find(u => u.id === currentUserId);
          if (existingUser) {
            const updatedUsers = allUsers.map(u =>
              u.id === currentUserId ? { ...u, name: welcomeName.trim() } : u
            );
            setAllUsers(updatedUsers);
            await window.storage.set('all-users', JSON.stringify(updatedUsers));
          } else {
            const newUserEntry = {
              id: currentUserId,
              name: welcomeName.trim(),
              totalSends: 0,
              problemsCreated: 0,
              highestGrade: null
            };
            const updatedUsers = [...allUsers, newUserEntry];
            setAllUsers(updatedUsers);
            await window.storage.set('all-users', JSON.stringify(updatedUsers));
          }

          setShowWelcomeModal(false);
          setWelcomeName('');
        } catch (error) {
          console.error('Error completing welcome:', error);
        }
      };

      // Comment functions
      const addComment = async (problemId, commentText, isBetaSpoiler = false) => {
        const newCommentObj = {
          id: Date.now(),
          text: commentText,
          userId: currentUserId,
          userName: currentUserName,
          timestamp: new Date().toISOString(),
          isSpoiler: isBetaSpoiler,
          likes: []
        };

        const problemComments = comments[problemId] || [];
        const updatedComments = {
          ...comments,
          [problemId]: [...problemComments, newCommentObj]
        };

        setComments(updatedComments);
        setNewComment('');
        setIsSpoiler(false);

        try {
          await window.storage.set('all-comments', JSON.stringify(updatedComments));

          const problem = problems.find(p => p.id === problemId);
          if (problem && problem.setterId !== currentUserId) {
            addNotification(problem.setterId, {
              type: 'comment',
              message: `${currentUserName} commented on "${problem.name}"`,
              problemId,
              timestamp: new Date().toISOString()
            });
          }
        } catch (error) {
          console.error('Error adding comment:', error);
        }
      };

      const likeComment = async (problemId, commentId) => {
        const problemComments = comments[problemId] || [];
        const updatedProblemComments = problemComments.map(c => {
          if (c.id === commentId) {
            const likes = c.likes || [];
            if (likes.includes(currentUserId)) {
              return { ...c, likes: likes.filter(id => id !== currentUserId) };
            } else {
              return { ...c, likes: [...likes, currentUserId] };
            }
          }
          return c;
        });

        const updatedComments = { ...comments, [problemId]: updatedProblemComments };
        setComments(updatedComments);

        try {
          await window.storage.set('all-comments', JSON.stringify(updatedComments));
        } catch (error) {
          console.error('Error liking comment:', error);
        }
      };

      // Attempt tracking functions
      const logAttempt = async (problemId, notes = '') => {
        const currentAttempts = attempts[problemId] || { attempts: 0, notes: '', firstAttemptDate: null };
        const updatedAttempt = {
          attempts: currentAttempts.attempts + 1,
          notes: notes || currentAttempts.notes,
          firstAttemptDate: currentAttempts.firstAttemptDate || new Date().toISOString(),
          lastAttemptDate: new Date().toISOString()
        };

        const updatedAttempts = { ...attempts, [problemId]: updatedAttempt };
        setAttempts(updatedAttempts);

        if (activeSession) {
          const problem = problems.find(p => p.id === problemId);
          const attemptEntry = {
            problemId,
            problemName: problem?.name || 'Unknown',
            grade: problem?.grade || 'V?',
            timestamp: new Date().toISOString(),
            type: 'attempt'
          };
          const updatedSessionProblems = [...sessionProblems, attemptEntry];
          setSessionProblems(updatedSessionProblems);
          const updatedSession = { ...activeSession, problems: updatedSessionProblems };
          setActiveSession(updatedSession);
          await window.storage.set(`active-session:${currentUserId}`, JSON.stringify(updatedSession));
        }

        try {
          await window.storage.set('user-attempts', JSON.stringify(updatedAttempts));
        } catch (error) {
          console.error('Error logging attempt:', error);
        }
      };

      const updateAttemptNotes = async (problemId, notes) => {
        const currentAttempts = attempts[problemId] || { attempts: 0, notes: '', firstAttemptDate: null };
        const updatedAttempt = { ...currentAttempts, notes };
        const updatedAttempts = { ...attempts, [problemId]: updatedAttempt };
        setAttempts(updatedAttempts);

        try {
          await window.storage.set('user-attempts', JSON.stringify(updatedAttempts));
        } catch (error) {
          console.error('Error updating notes:', error);
        }
      };

      // Grade suggestion functions
      const suggestGrade = async (problemId, suggestedGrade) => {
        const currentSuggestions = gradeSuggestions[problemId] || [];
        const existingSuggestion = currentSuggestions.find(s => s.userId === currentUserId);

        let updatedProblemSuggestions;
        if (existingSuggestion) {
          updatedProblemSuggestions = currentSuggestions.map(s =>
            s.userId === currentUserId ? { ...s, grade: suggestedGrade } : s
          );
        } else {
          updatedProblemSuggestions = [...currentSuggestions, {
            userId: currentUserId,
            userName: currentUserName,
            grade: suggestedGrade,
            timestamp: new Date().toISOString()
          }];
        }

        const updatedSuggestions = { ...gradeSuggestions, [problemId]: updatedProblemSuggestions };
        setGradeSuggestions(updatedSuggestions);

        try {
          await window.storage.set('grade-suggestions', JSON.stringify(updatedSuggestions));
        } catch (error) {
          console.error('Error suggesting grade:', error);
        }
      };

      const getConsensusGrade = (problemId) => {
        const suggestions = gradeSuggestions[problemId] || [];
        if (suggestions.length === 0) return null;

        const gradeCounts = {};
        suggestions.forEach(s => {
          gradeCounts[s.grade] = (gradeCounts[s.grade] || 0) + 1;
        });

        let consensusGrade = null;
        let maxCount = 0;
        Object.entries(gradeCounts).forEach(([grade, count]) => {
          if (count > maxCount) {
            consensusGrade = grade;
            maxCount = count;
          }
        });

        return { grade: consensusGrade, count: maxCount, total: suggestions.length };
      };

      // Get the current list of problems based on source (archive or logbook)
      const getCurrentProblemList = () => {
        if (problemListSource === 'logbook') {
          // Get unique problems from user sends, maintaining order
          const seenIds = new Set();
          return userSends
            .map(send => problems.find(p => p.id === send.problemId))
            .filter(p => {
              if (!p || seenIds.has(p.id)) return false;
              seenIds.add(p.id);
              return true;
            });
        } else if (cameFromCircuit && activeCircuit) {
          // If viewing from a circuit, use circuit problems
          return activeCircuit.problemIds
            .map(id => problems.find(p => p.id === id))
            .filter(p => p);
        }
        // Default to archive (filtered problems)
        return getSortedAndFilteredProblems();
      };

      // Navigate to next/previous problem in the list
      const navigateProblem = (direction) => {
        const problemList = getCurrentProblemList();
        if (!selectedProblem || problemList.length === 0) return;

        const currentIndex = problemList.findIndex(p => p.id === selectedProblem.id);
        if (currentIndex === -1) return;

        let newIndex;
        if (direction === 'next') {
          newIndex = currentIndex + 1;
          if (newIndex >= problemList.length) return; // At end of list
        } else {
          newIndex = currentIndex - 1;
          if (newIndex < 0) return; // At beginning of list
        }

        setSelectedProblem(problemList[newIndex]);
        setDetailZoom(1);
        setDetailPosition({ x: 0, y: 0 });
      };

      // Check if navigation is possible
      const canNavigate = (direction) => {
        const problemList = getCurrentProblemList();
        if (!selectedProblem || problemList.length === 0) return false;

        const currentIndex = problemList.findIndex(p => p.id === selectedProblem.id);
        if (currentIndex === -1) return false;

        if (direction === 'next') {
          return currentIndex < problemList.length - 1;
        } else {
          return currentIndex > 0;
        }
      };

      // Navigate to problem detail with history tracking
      const viewProblemDetail = (problem, source = 'archive') => {
        if (!problem) return;
        saveNavigationHistory();
        setProblemListSource(source);
        setSelectedProblem(problem);
        setActiveTab('detail');
        window.scrollTo(0, 0);
      };

      const navigateTo = (tab, options = {}) => {
        saveNavigationHistory();
        setActiveTab(tab);
        if (options.problem) {
          setSelectedProblem(options.problem);
          setProblemListSource(options.source || 'archive');
        }
        if (options.profile) setViewingProfile(options.profile);
        if (options.circuit) setActiveCircuit(options.circuit);
      };

      // Go back in navigation history
      const navigateBack = () => {
        if (navigationHistory.length === 0) {
          // Default fallback behavior
          if (activeTab === 'detail') {
            setSelectedProblem(null);
            if (cameFromCircuit) {
              setActiveCircuit(cameFromCircuit);
              setCameFromCircuit(null);
              setActiveTab('user');
            } else if (problemListSource === 'logbook') {
              setActiveTab('logbook');
            } else if (problemListSource === 'leaderboard') {
              setActiveTab('leaderboard');
            } else {
              setActiveTab('archive');
            }
          } else if (viewingProfile) {
            setViewingProfile(null);
            setActiveTab('leaderboard');
          } else {
            setActiveTab('archive');
          }
          return;
        }

        const prevState = navigationHistory[navigationHistory.length - 1];
        setNavigationHistory(prev => prev.slice(0, -1));

        setActiveTab(prevState.tab);

        if (prevState.selectedProblem) {
          const problem = problems.find(p => p.id === prevState.selectedProblem);
          setSelectedProblem(problem || null);
        } else {
          setSelectedProblem(null);
        }

        if (prevState.viewingProfile) {
          const profile = allUsers.find(u => u.id === prevState.viewingProfile);
          setViewingProfile(profile || null);
        } else {
          setViewingProfile(null);
        }

        if (prevState.activeCircuit) {
          const circuit = circuits.find(c => c.id === prevState.activeCircuit);
          setActiveCircuit(circuit || null);
        } else {
          setActiveCircuit(null);
        }

        if (prevState.problemListSource) {
          setProblemListSource(prevState.problemListSource);
        }
      };

      // Notification functions
      const addNotification = async (userId, notification) => {
        try {
          const result = await window.storage.get(`notifications:${userId}`);
          const existingNotifications = result ? JSON.parse(result.value) : [];
          const updatedNotifications = [{ ...notification, id: Date.now(), read: false }, ...existingNotifications].slice(0, 50);
          await window.storage.set(`notifications:${userId}`, JSON.stringify(updatedNotifications));

          if (userId === currentUserId) {
            setNotifications(updatedNotifications);
          }
        } catch (error) {
          console.error('Error adding notification:', error);
        }
      };

      const markNotificationRead = async (notificationId) => {
        const updatedNotifications = notifications.map(n =>
          n.id === notificationId ? { ...n, read: true } : n
        );
        setNotifications(updatedNotifications);

        try {
          await window.storage.set(`notifications:${currentUserId}`, JSON.stringify(updatedNotifications));
        } catch (error) {
          console.error('Error marking notification read:', error);
        }
      };

      const clearAllNotifications = async () => {
        setNotifications([]);
        try {
          await window.storage.set(`notifications:${currentUserId}`, JSON.stringify([]));
        } catch (error) {
          console.error('Error clearing notifications:', error);
        }
      };

      // Session functions
      const startSession = async () => {
        const newSession = {
          id: Date.now(),
          startTime: new Date().toISOString(),
          problems: []
        };
        setActiveSession(newSession);
        setSessionProblems([]);

        try {
          await window.storage.set(`active-session:${currentUserId}`, JSON.stringify(newSession));
        } catch (error) {
          console.error('Error starting session:', error);
        }
      };

      const endSession = async () => {
        if (!activeSession) return;

        const completedSession = {
          ...activeSession,
          endTime: new Date().toISOString(),
          problems: sessionProblems
        };

        try {
          const historyResult = await window.storage.get(`session-history:${currentUserId}`);
          const history = historyResult ? JSON.parse(historyResult.value) : [];
          const updatedHistory = [completedSession, ...history].slice(0, 100);
          await window.storage.set(`session-history:${currentUserId}`, JSON.stringify(updatedHistory));
          setSessionHistory(updatedHistory);

          await window.storage.delete(`active-session:${currentUserId}`);
          setActiveSession(null);
          setSessionProblems([]);
        } catch (error) {
          console.error('Error ending session:', error);
        }
      };

      // Project functions
      const toggleProject = async (problemId) => {
        const isProject = projects.includes(problemId);
        const updatedProjects = isProject
          ? projects.filter(id => id !== problemId)
          : [...projects, problemId];

        setProjects(updatedProjects);
        try {
          await window.storage.set(`projects:${currentUserId}`, JSON.stringify(updatedProjects));
        } catch (error) {
          console.error('Error updating projects:', error);
        }
      };

      // Circuit functions
      const createCircuit = async (name) => {
        if (!name.trim()) return;
        const newCircuit = {
          id: Date.now(),
          name: name.trim(),
          problemIds: [],
          createdAt: new Date().toISOString(),
          color: ['#ea580c', '#2563eb', '#16a34a', '#9333ea', '#dc2626', '#0891b2'][circuits.length % 6]
        };
        const updatedCircuits = [newCircuit, ...circuits];
        setCircuits(updatedCircuits);
        try {
          await window.storage.set(`circuits:${currentUserId}`, JSON.stringify(updatedCircuits));
        } catch (error) {
          console.error('Error creating circuit:', error);
        }
        setNewCircuitName('');
        setShowCircuitModal(false);
        return newCircuit;
      };

      const updateCircuit = async (circuitId, updates) => {
        const updatedCircuits = circuits.map(c =>
          c.id === circuitId ? { ...c, ...updates } : c
        );
        setCircuits(updatedCircuits);
        try {
          await window.storage.set(`circuits:${currentUserId}`, JSON.stringify(updatedCircuits));
        } catch (error) {
          console.error('Error updating circuit:', error);
        }
      };

      const deleteCircuit = async (circuitId) => {
        const updatedCircuits = circuits.filter(c => c.id !== circuitId);
        setCircuits(updatedCircuits);
        if (activeCircuit?.id === circuitId) {
          setActiveCircuit(null);
        }
        try {
          await window.storage.set(`circuits:${currentUserId}`, JSON.stringify(updatedCircuits));
        } catch (error) {
          console.error('Error deleting circuit:', error);
        }
      };

      const addProblemToCircuit = async (circuitId, problemId) => {
        const circuit = circuits.find(c => c.id === circuitId);
        if (!circuit || circuit.problemIds.includes(problemId)) return;

        const updatedCircuits = circuits.map(c =>
          c.id === circuitId
            ? { ...c, problemIds: [...c.problemIds, problemId] }
            : c
        );
        setCircuits(updatedCircuits);
        try {
          await window.storage.set(`circuits:${currentUserId}`, JSON.stringify(updatedCircuits));
        } catch (error) {
          console.error('Error adding problem to circuit:', error);
        }
        setAddToCircuitProblem(null);
      };

      const removeProblemFromCircuit = async (circuitId, problemId) => {
        const updatedCircuits = circuits.map(c =>
          c.id === circuitId
            ? { ...c, problemIds: c.problemIds.filter(id => id !== problemId) }
            : c
        );
        setCircuits(updatedCircuits);
        if (activeCircuit?.id === circuitId) {
          setActiveCircuit(updatedCircuits.find(c => c.id === circuitId));
        }
        try {
          await window.storage.set(`circuits:${currentUserId}`, JSON.stringify(updatedCircuits));
        } catch (error) {
          console.error('Error removing problem from circuit:', error);
        }
      };

      // Personal notes functions
      const updatePersonalNote = async (problemId, note) => {
        const updatedNotes = { ...personalNotes, [problemId]: note };
        if (!note.trim()) {
          delete updatedNotes[problemId];
        }
        setPersonalNotes(updatedNotes);
        try {
          await window.storage.set(`personal-notes:${currentUserId}`, JSON.stringify(updatedNotes));
        } catch (error) {
          console.error('Error updating personal note:', error);
        }
      };

      // Share link function
      const getShareLink = (problemId) => {
        const baseUrl = window.location.href.split('?')[0];
        return `${baseUrl}?problem=${problemId}`;
      };

      const copyShareLink = (problemId) => {
        const link = getShareLink(problemId);
        navigator.clipboard.writeText(link).then(() => {
          alert('Link copied to clipboard!');
        }).catch(() => {
          prompt('Copy this link:', link);
        });
      };

      // Edit/Delete problem functions
      const deleteProblem = async (problemId) => {
        const problem = problems.find(p => p.id === problemId);
        if (!problem || problem.setterId !== currentUserId) return;

        try {
          await window.storage.delete(`problem:${problemId}`);
          setProblems(problems.filter(p => p.id !== problemId));
          if (selectedProblem?.id === problemId) {
            setSelectedProblem(null);
            setActiveTab('archive');
          }
        } catch (error) {
          console.error('Error deleting problem:', error);
        }
      };

      const updateProblem = async (problemId, updates) => {
        const problemIndex = problems.findIndex(p => p.id === problemId);
        if (problemIndex === -1) return;

        const problem = problems[problemIndex];
        if (problem.setterId !== currentUserId) return;

        const updatedProblem = { ...problem, ...updates, updatedAt: new Date().toISOString() };

        try {
          await window.storage.set(`problem:${problemId}`, JSON.stringify(updatedProblem));
          const newProblems = [...problems];
          newProblems[problemIndex] = updatedProblem;
          setProblems(newProblems);
          if (selectedProblem?.id === problemId) {
            setSelectedProblem(updatedProblem);
          }
          setEditingProblem(null);
        } catch (error) {
          console.error('Error updating problem:', error);
        }
      };

      // Profile picture function
      const updateProfilePicture = async (imageData) => {
        setProfilePicture(imageData);
        try {
          await window.storage.set(`profile-picture:${currentUserId}`, imageData);
        } catch (error) {
          console.error('Error updating profile picture:', error);
        }
      };

      // Export function
      const exportProblemImage = async (problem) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();

        return new Promise((resolve, reject) => {
          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            problem.holds.forEach(hold => {
              const x = (hold.x / 100) * img.width;
              const y = (hold.y / 100) * img.height;
              const radius = hold.type === 'foot' ? 8 : 12;

              ctx.beginPath();
              ctx.arc(x, y, radius, 0, 2 * Math.PI);
              ctx.fillStyle = getHoldColorByType(hold.type);
              ctx.fill();
              ctx.strokeStyle = 'white';
              ctx.lineWidth = 2;
              ctx.stroke();
            });

            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, img.height - 60, img.width, 60);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 24px sans-serif';
            ctx.fillText(`${problem.name} - ${problem.grade}`, 10, img.height - 25);
            ctx.font = '16px sans-serif';
            ctx.fillText(`Set by ${problem.setter}`, 10, img.height - 5);

            canvas.toBlob((blob) => {
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `${problem.name.replace(/\s+/g, '_')}_${problem.grade}.png`;
              a.click();
              URL.revokeObjectURL(url);
              resolve();
            }, 'image/png');
          };
          img.onerror = reject;
          img.src = problem.wallImage;
        });
      };

      const getSortedAndFilteredProblems = () => {
        let filtered = problems;

        if (climbFilter !== 'mine') {
          filtered = filtered.filter(p => !p.isRetired);
        }

        if (climbFilter === 'mine') {
          filtered = filtered.filter(p => p.setterId === currentUserId);
        } else if (climbFilter === 'friends') {
          filtered = filtered.filter(p =>
            p.setterId === currentUserId || friends.includes(p.setterId)
          );
        }

        const minIndex = grades.indexOf(filterGradeMin);
        const maxIndex = grades.indexOf(filterGradeMax);
        filtered = filtered.filter(p => {
          const gradeIndex = grades.indexOf(p.grade);
          return gradeIndex >= minIndex && gradeIndex <= maxIndex;
        });

        if (filterTags.length > 0) {
          filtered = filtered.filter(p =>
            p.tags && filterTags.some(tag => p.tags.includes(tag))
          );
        }

        if (searchTerm) {
          filtered = filtered.filter(p =>
            p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            p.setter.toLowerCase().includes(searchTerm.toLowerCase()) ||
            (p.tags && p.tags.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase())))
          );
        }

        const sorted = [...filtered].sort((a, b) => {
          switch (sortBy) {
            case 'rating':
              return b.averageRating - a.averageRating;
            case 'popularity':
              return b.sends - a.sends;
            case 'difficulty':
              return grades.indexOf(b.grade) - grades.indexOf(a.grade);
            case 'newest':
            default:
              return new Date(b.createdAt) - new Date(a.createdAt);
          }
        });

        return sorted;
      };

      const getLeaderboardData = () => {
        const gradeStats = {};
        grades.forEach(grade => {
          gradeStats[grade] = userSends.filter(send => (send.suggestedGrade || send.grade) === grade).length;
        });

        const topProblems = [...problems]
          .sort((a, b) => b.sends - a.sends)
          .slice(0, 10);

        const rankedUsers = [...allUsers]
          .filter(u => u.totalSends > 0 || u.problemsCreated > 0)
          .sort((a, b) => {
            if (b.totalSends !== a.totalSends) {
              return (b.totalSends || 0) - (a.totalSends || 0);
            }
            const aGradeIndex = grades.indexOf(a.highestGrade || 'V0');
            const bGradeIndex = grades.indexOf(b.highestGrade || 'V0');
            return bGradeIndex - aGradeIndex;
          });

        return { gradeStats, topProblems, rankedUsers };
      };

      const getHoldColorByType = (type) => {
        if (type === 'start') return '#22c55e';
        if (type === 'finish') return '#ef4444';
        if (type === 'foot') return '#ec4899';
        if (type === 'hand') return '#3b82f6';
        return '#3b82f6';
      };

      const getHoldBorderStyle = (type) => {
        // Start = double border, Hand = solid, Foot = dashed, Finish = thick
        if (type === 'start') return { border: '3px double white', outline: '2px solid white', outlineOffset: '1px' };
        if (type === 'finish') return { border: '4px solid white' };
        if (type === 'foot') return { border: '2px dashed white' };
        if (type === 'hand') return { border: '2px solid white' };
        return { border: '2px solid white' };
      };

      // Loading screen
      if (isLoading || authLoading) {
        return (
          <div className="min-h-screen bg-zinc-950 text-white flex items-center justify-center" style={{ fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", sans-serif' }}>
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-4 border-orange-600 border-t-transparent mx-auto mb-4"></div>
              <p className="text-zinc-400 uppercase tracking-wide text-sm">Loading The Lab...</p>
            </div>
          </div>
        );
      }

      // Login screen if not authenticated
      if (!authUser) {
        return (
          <div className="min-h-screen bg-zinc-950 text-white flex items-center justify-center" style={{ fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", sans-serif' }}>
            <div className="text-center p-8 max-w-md">
              <div className="w-24 h-24 bg-orange-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <Icon name="Mountain" size={48} />
              </div>
              <h1 className="text-4xl font-black uppercase tracking-wider mb-2">The Lab</h1>
              <p className="text-zinc-400 mb-8">Spray Wall Climbing App</p>

              <button
                onClick={signInWithGoogle}
                className="w-full bg-white text-zinc-900 hover:bg-zinc-200 px-6 py-4 rounded-lg font-bold flex items-center justify-center gap-3 transition"
              >
                <svg className="w-6 h-6" viewBox="0 0 24 24">
                  <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
              </button>

              <p className="text-zinc-500 text-sm mt-6">
                Sign in to track your sends, create problems, and connect with other climbers.
              </p>
            </div>
          </div>
        );
      }

      // Banned user screen
      if (bannedUsers.includes(currentUserId)) {
        return (
          <div className="min-h-screen bg-zinc-950 text-white flex items-center justify-center" style={{ fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", sans-serif' }}>
            <div className="text-center p-8 max-w-md">
              <div className="w-24 h-24 bg-red-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <Icon name="Ban" size={48} />
              </div>
              <h1 className="text-2xl font-black uppercase tracking-wider mb-4">Account Suspended</h1>
              <p className="text-zinc-400 mb-6">Your account has been suspended. If you believe this is an error, please contact the administrator.</p>
              <button
                onClick={signOut}
                className="bg-zinc-800 hover:bg-zinc-700 px-6 py-3 rounded font-bold uppercase text-sm transition"
              >
                Sign Out
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-zinc-950 text-white pb-20" style={{ fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", sans-serif' }}>
          {/* Saving indicator */}
          {isSaving && (
            <div className="fixed top-4 right-4 bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2 flex items-center gap-2 z-50 shadow-lg">
              <div className="animate-spin rounded-full h-4 w-4 border-2 border-orange-600 border-t-transparent"></div>
              <span className="text-sm">Saving...</span>
            </div>
          )}

          {/* Welcome Modal */}
          {showWelcomeModal && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
              <div className="bg-zinc-900 rounded-lg border-2 border-orange-600 shadow-2xl max-w-md w-full p-8">
                <div className="text-center mb-6">
                  <div className="w-20 h-20 bg-orange-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <Icon name="Mountain" size={40} />
                  </div>
                  <h2 className="text-3xl font-black uppercase tracking-wide mb-2">Welcome to The Lab</h2>
                  <p className="text-zinc-400">Set up your profile to start tracking climbs, setting problems, and connecting with other climbers.</p>
                </div>

                <div className="space-y-4">
                  <div>
                    <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Your Name *</label>
                    <input
                      type="text"
                      value={welcomeName}
                      onChange={(e) => setWelcomeName(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && completeWelcome()}
                      className="w-full bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded px-4 py-3 text-lg transition outline-none"
                      placeholder="Enter your name"
                      autoFocus
                    />
                    <p className="text-xs text-zinc-500 mt-1">This is how other climbers will see you</p>
                  </div>

                  <button
                    onClick={completeWelcome}
                    disabled={!welcomeName.trim()}
                    className={`w-full py-4 rounded font-black uppercase tracking-wide text-lg transition ${
                      welcomeName.trim()
                        ? 'bg-orange-600 hover:bg-orange-500'
                        : 'bg-zinc-800 text-zinc-500 cursor-not-allowed'
                    }`}
                  >
                    Start Climbing
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Send Modal */}
          {showSendModal && sendModalProblem && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
              <div className="bg-zinc-900 rounded-lg border-2 border-orange-600 shadow-2xl max-w-md w-full p-6">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-black uppercase tracking-wide">
                    {editingSend ? 'Edit Send' : 'Log Send'}
                  </h2>
                  <button
                    onClick={() => { setShowSendModal(false); setSendModalProblem(null); }}
                    className="text-zinc-500 hover:text-white"
                  >
                    <Icon name="X" size={24} />
                  </button>
                </div>

                <div className="mb-4 p-3 bg-zinc-950 rounded border border-zinc-800">
                  <h3 className="font-bold">{sendModalProblem.name}</h3>
                  <p className="text-sm text-zinc-500">Setter's grade: {sendModalProblem.grade}</p>
                </div>

                <div className="space-y-4">
                  {/* Rating */}
                  <div>
                    <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">
                      Rate this problem
                    </label>
                    <div className="flex gap-2">
                      {[1, 2, 3, 4, 5].map(star => (
                        <button
                          key={star}
                          onClick={() => setSendModalRating(star)}
                          className={`p-2 rounded transition ${
                            star <= sendModalRating ? 'text-yellow-500' : 'text-zinc-600 hover:text-zinc-400'
                          }`}
                        >
                          <Icon name="Star" size={28} />
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Attempts */}
                  <div>
                    <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">
                      How many attempts?
                    </label>
                    <div className="flex items-center gap-3">
                      <button
                        onClick={() => setSendModalAttempts(Math.max(1, sendModalAttempts - 1))}
                        className="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 w-12 h-12 rounded text-xl font-bold"
                      >
                        -
                      </button>
                      <div className="flex-1 text-center">
                        <span className="text-3xl font-black">{sendModalAttempts}</span>
                        {sendModalAttempts === 1 && (
                          <span className="block text-xs text-yellow-500 font-bold mt-1">FLASH!</span>
                        )}
                      </div>
                      <button
                        onClick={() => setSendModalAttempts(sendModalAttempts + 1)}
                        className="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 w-12 h-12 rounded text-xl font-bold"
                      >
                        +
                      </button>
                    </div>
                  </div>

                  {/* Grade suggestion */}
                  <div>
                    <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">
                      What grade do you think this is?
                    </label>
                    <select
                      value={sendModalGrade}
                      onChange={(e) => setSendModalGrade(e.target.value)}
                      className="w-full bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded px-3 py-2 outline-none transition"
                    >
                      {grades.map(grade => (
                        <option key={grade} value={grade}>{grade}</option>
                      ))}
                    </select>
                  </div>

                  {/* Notes */}
                  <div>
                    <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">
                      Notes (optional)
                    </label>
                    <textarea
                      value={sendModalNotes}
                      onChange={(e) => setSendModalNotes(e.target.value)}
                      className="w-full bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded px-3 py-2 outline-none transition text-sm"
                      placeholder="How did it feel? Any beta to remember?"
                      rows={2}
                    />
                  </div>

                  <div className="flex gap-3 pt-2">
                    <button
                      onClick={() => { setShowSendModal(false); setSendModalProblem(null); }}
                      className="flex-1 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 py-3 rounded font-bold uppercase text-sm transition"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={confirmSend}
                      className="flex-1 bg-orange-600 hover:bg-orange-500 py-3 rounded font-bold uppercase text-sm transition"
                    >
                      {editingSend ? 'Save Changes' : 'Confirm Send'}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Rating Details Modal */}
          {showRatingDetails && selectedProblem && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={() => setShowRatingDetails(false)}>
              <div className="bg-zinc-900 rounded-lg border-2 border-orange-600 shadow-2xl max-w-md w-full p-6" onClick={(e) => e.stopPropagation()}>
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-black uppercase tracking-wide">Rating Details</h2>
                  <button
                    onClick={() => setShowRatingDetails(false)}
                    className="text-zinc-500 hover:text-white transition"
                  >
                    <Icon name="X" size={24} />
                  </button>
                </div>

                <div className="mb-4 p-3 bg-zinc-950 rounded border border-zinc-800">
                  <h3 className="font-bold">{selectedProblem.name}</h3>
                  <div className="flex items-center gap-2 mt-1">
                    <div className="flex">
                      {[1, 2, 3, 4, 5].map(star => (
                        <Icon
                          key={star}
                          name="Star"
                          size={16}
                          className={star <= Math.round(selectedProblem.averageRating || 0) ? 'text-yellow-500' : 'text-zinc-700'}
                        />
                      ))}
                    </div>
                    <span className="text-sm text-zinc-400">
                      {selectedProblem.averageRating?.toFixed(1) || '0'} average ({selectedProblem.ratings?.length || 0} votes)
                    </span>
                  </div>
                </div>

                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {selectedProblem.ratings?.length > 0 ? (
                    selectedProblem.ratings.map((r, idx) => {
                      const rating = typeof r === 'object' ? r.rating : r;
                      const odataUserId = typeof r === 'object' ? r.userId : null;
                      const user = odataUserId ? allUsers.find(u => u.id === odataUserId) : null;
                      return (
                        <div key={idx} className="flex items-center justify-between p-3 bg-zinc-950 rounded border border-zinc-800">
                          <span className="font-bold text-sm">{user?.name || 'Anonymous'}</span>
                          <div className="flex">
                            {[1, 2, 3, 4, 5].map(star => (
                              <Icon
                                key={star}
                                name="Star"
                                size={16}
                                className={star <= rating ? 'text-yellow-500' : 'text-zinc-700'}
                              />
                            ))}
                          </div>
                        </div>
                      );
                    })
                  ) : (
                    <p className="text-zinc-500 text-center py-4">No ratings yet</p>
                  )}
                </div>

                <button
                  onClick={() => setShowRatingDetails(false)}
                  className="w-full mt-4 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 py-3 rounded font-bold uppercase text-sm transition"
                >
                  Close
                </button>
              </div>
            </div>
          )}

          {/* Sends Details Modal */}
          {showSendsDetails && selectedProblem && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={() => setShowSendsDetails(false)}>
              <div className="bg-zinc-900 rounded-lg border-2 border-orange-600 shadow-2xl max-w-md w-full p-6" onClick={(e) => e.stopPropagation()}>
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-black uppercase tracking-wide">Ascents</h2>
                  <button
                    onClick={() => setShowSendsDetails(false)}
                    className="text-zinc-500 hover:text-white transition"
                  >
                    <Icon name="X" size={24} />
                  </button>
                </div>

                <div className="mb-4 p-3 bg-zinc-950 rounded border border-zinc-800">
                  <h3 className="font-bold">{selectedProblem.name}</h3>
                  <p className="text-sm text-zinc-400">{selectedProblem.sends || 0} total sends</p>
                </div>

                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {(() => {
                    // Get sends for this problem from activity feed
                    const problemSends = activityFeed.filter(a =>
                      a.type === 'send' && a.problemId === selectedProblem.id
                    );

                    if (problemSends.length > 0) {
                      return problemSends.map((send, idx) => {
                        const user = allUsers.find(u => u.id === send.userId);
                        return (
                          <div key={idx} className="flex items-center justify-between p-3 bg-zinc-950 rounded border border-zinc-800">
                            <div className="flex items-center gap-3">
                              <div className="w-8 h-8 bg-zinc-700 rounded-full flex items-center justify-center text-sm font-bold">
                                {(user?.name || send.userName || '?').charAt(0).toUpperCase()}
                              </div>
                              <div>
                                <span className="font-bold text-sm">{user?.name || send.userName || 'Unknown'}</span>
                                {send.isFlash && <span className="ml-2 text-yellow-500 text-xs font-bold">FLASH</span>}
                                <p className="text-xs text-zinc-500">
                                  {new Date(send.timestamp).toLocaleDateString()}
                                </p>
                              </div>
                            </div>
                            <div className="text-right">
                              <span className="bg-zinc-800 px-2 py-1 rounded text-xs font-bold">
                                {send.suggestedGrade || send.grade}
                              </span>
                              {send.rating > 0 && (
                                <div className="flex items-center justify-end gap-1 mt-1">
                                  <span className="text-yellow-500 text-xs">{send.rating}</span>
                                  <Icon name="Star" size={12} className="text-yellow-500" />
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      });
                    } else {
                      return <p className="text-zinc-500 text-center py-4">No send data available</p>;
                    }
                  })()}
                </div>

                <button
                  onClick={() => setShowSendsDetails(false)}
                  className="w-full mt-4 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 py-3 rounded font-bold uppercase text-sm transition"
                >
                  Close
                </button>
              </div>
            </div>
          )}

          {/* Draft Viewing Modal */}
          {viewingDraft && (
            <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4">
              <div className="bg-zinc-900 rounded-lg border-2 border-orange-600 shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div className="flex items-center justify-between p-4 border-b border-zinc-800">
                  <div className="flex items-center gap-3">
                    <h2 className="text-xl font-black uppercase tracking-wide">{viewingDraft.name}</h2>
                    <span className="bg-zinc-700 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider">Draft</span>
                    <span className="bg-orange-600 px-3 py-1 rounded font-black text-sm">{viewingDraft.grade}</span>
                  </div>
                  <button
                    onClick={() => setViewingDraft(null)}
                    className="text-zinc-500 hover:text-white transition"
                  >
                    <Icon name="X" size={24} />
                  </button>
                </div>
                <div className="p-4">
                  <div className="relative mx-auto" style={{ maxWidth: '600px' }}>
                    {viewingDraft.wallImage && (
                      <div className="relative">
                        <img
                          src={viewingDraft.wallImage}
                          alt={viewingDraft.name}
                          className="w-full rounded-lg"
                        />
                        <svg
                          className="absolute inset-0 w-full h-full pointer-events-none"
                          viewBox="0 0 100 100"
                          preserveAspectRatio="none"
                        >
                          {viewingDraft.holds && viewingDraft.holds.map((hold, index) => (
                            <circle
                              key={index}
                              cx={hold.x}
                              cy={hold.y}
                              r={2}
                              fill="transparent"
                              stroke={hold.type === 'start' ? '#22c55e' : hold.type === 'top' ? '#ef4444' : '#3b82f6'}
                              strokeWidth={0.8}
                              style={{
                                filter: `drop-shadow(0 0 3px ${hold.type === 'start' ? '#22c55e' : hold.type === 'top' ? '#ef4444' : '#3b82f6'})`
                              }}
                            />
                          ))}
                        </svg>
                      </div>
                    )}
                  </div>
                  {viewingDraft.notes && (
                    <div className="mt-4 bg-zinc-950 rounded-lg p-4 border border-zinc-800">
                      <h3 className="text-sm font-bold uppercase tracking-wider text-zinc-400 mb-2">Notes</h3>
                      <p className="text-zinc-300">{viewingDraft.notes}</p>
                    </div>
                  )}
                  <div className="mt-4 flex items-center justify-between text-sm text-zinc-500">
                    <span>{viewingDraft.holds?.length || 0} holds marked</span>
                    <span>Created {new Date(viewingDraft.createdAt).toLocaleDateString()}</span>
                  </div>
                </div>
                <div className="p-4 border-t border-zinc-800 flex gap-3">
                  <button
                    onClick={() => {
                      editDraft(viewingDraft.id);
                      setViewingDraft(null);
                    }}
                    className="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded transition text-sm font-bold uppercase tracking-wide"
                  >
                    Edit Draft
                  </button>
                  <button
                    onClick={() => {
                      publishDraft(viewingDraft.id);
                      setViewingDraft(null);
                    }}
                    className="bg-orange-600 hover:bg-orange-500 px-4 py-2 rounded transition text-sm font-bold uppercase tracking-wide"
                  >
                    Publish Now
                  </button>
                  <button
                    onClick={() => setViewingDraft(null)}
                    className="bg-zinc-700 hover:bg-zinc-600 px-4 py-2 rounded transition text-sm font-bold uppercase tracking-wide ml-auto"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Circuit Create/Edit Modal */}
          {showCircuitModal && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
              <div className="bg-zinc-900 rounded-lg border-2 border-orange-600 shadow-2xl max-w-md w-full p-6">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-black uppercase tracking-wide">
                    {editingCircuit ? 'Edit Circuit' : 'New Circuit'}
                  </h2>
                  <button
                    onClick={() => { setShowCircuitModal(false); setEditingCircuit(null); setNewCircuitName(''); }}
                    className="text-zinc-500 hover:text-white transition"
                  >
                    <Icon name="X" size={24} />
                  </button>
                </div>

                <div className="mb-4">
                  <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Circuit Name</label>
                  <input
                    type="text"
                    value={newCircuitName}
                    onChange={(e) => setNewCircuitName(e.target.value)}
                    className="w-full bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded px-4 py-3 outline-none transition"
                    placeholder="e.g., 1/20 Circuit, Warmup Set, Project List"
                    autoFocus
                  />
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => { setShowCircuitModal(false); setEditingCircuit(null); setNewCircuitName(''); }}
                    className="flex-1 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 py-3 rounded font-bold uppercase text-sm transition"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={() => {
                      if (editingCircuit) {
                        updateCircuit(editingCircuit.id, { name: newCircuitName });
                        setShowCircuitModal(false);
                        setEditingCircuit(null);
                        setNewCircuitName('');
                      } else {
                        createCircuit(newCircuitName);
                      }
                    }}
                    disabled={!newCircuitName.trim()}
                    className="flex-1 bg-orange-600 hover:bg-orange-500 disabled:bg-zinc-700 disabled:cursor-not-allowed py-3 rounded font-bold uppercase text-sm transition"
                  >
                    {editingCircuit ? 'Save' : 'Create'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Add to Circuit Modal */}
          {addToCircuitProblem && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
              <div className="bg-zinc-900 rounded-lg border-2 border-orange-600 shadow-2xl max-w-md w-full p-6">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-black uppercase tracking-wide">Add to Circuit</h2>
                  <button
                    onClick={() => setAddToCircuitProblem(null)}
                    className="text-zinc-500 hover:text-white transition"
                  >
                    <Icon name="X" size={24} />
                  </button>
                </div>

                <p className="text-zinc-400 text-sm mb-4">
                  Adding "<span className="text-white font-bold">{addToCircuitProblem.name}</span>" to a circuit
                </p>

                {circuits.length === 0 ? (
                  <div className="text-center py-6">
                    <p className="text-zinc-500 mb-4">No circuits yet</p>
                    <button
                      onClick={() => {
                        setAddToCircuitProblem(null);
                        setShowCircuitModal(true);
                      }}
                      className="bg-orange-600 hover:bg-orange-500 px-4 py-2 rounded font-bold uppercase text-sm transition"
                    >
                      Create Your First Circuit
                    </button>
                  </div>
                ) : (
                  <div className="space-y-2 max-h-64 overflow-y-auto">
                    {circuits.map(circuit => {
                      const alreadyInCircuit = circuit.problemIds.includes(addToCircuitProblem.id);
                      return (
                        <button
                          key={circuit.id}
                          onClick={() => !alreadyInCircuit && addProblemToCircuit(circuit.id, addToCircuitProblem.id)}
                          disabled={alreadyInCircuit}
                          className={`w-full p-4 rounded-lg border text-left flex items-center gap-3 transition ${
                            alreadyInCircuit
                              ? 'bg-zinc-950 border-zinc-800 opacity-50 cursor-not-allowed'
                              : 'bg-zinc-950 border-zinc-800 hover:border-orange-600 cursor-pointer'
                          }`}
                        >
                          <div
                            className="w-4 h-4 rounded-full flex-shrink-0"
                            style={{ backgroundColor: circuit.color }}
                          />
                          <div className="flex-grow">
                            <div className="font-bold">{circuit.name}</div>
                            <div className="text-xs text-zinc-500">
                              {circuit.problemIds.length} problem{circuit.problemIds.length !== 1 ? 's' : ''}
                            </div>
                          </div>
                          {alreadyInCircuit ? (
                            <span className="text-xs text-zinc-500 uppercase">Already added</span>
                          ) : (
                            <Icon name="Plus" size={20} className="text-orange-500" />
                          )}
                        </button>
                      );
                    })}
                  </div>
                )}

                <div className="mt-4 pt-4 border-t border-zinc-800">
                  <button
                    onClick={() => {
                      setAddToCircuitProblem(null);
                      setShowCircuitModal(true);
                    }}
                    className="w-full bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 py-3 rounded font-bold uppercase text-sm transition flex items-center justify-center gap-2"
                  >
                    <Icon name="Plus" size={16} />
                    Create New Circuit
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Edit Problem Modal */}
          {editingProblem && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
              <div className="bg-zinc-900 rounded-lg border-2 border-orange-600 shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <div className="p-6">
                  <div className="flex items-center justify-between mb-6">
                    <h2 className="text-xl font-black uppercase tracking-wide">Edit Problem</h2>
                    <button
                      onClick={() => setEditingProblem(null)}
                      className="text-zinc-500 hover:text-white transition"
                    >
                      <Icon name="X" size={24} />
                    </button>
                  </div>

                  <div className="space-y-4">
                    <div>
                      <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Problem Name</label>
                      <input
                        type="text"
                        value={editingProblem.name}
                        onChange={(e) => setEditingProblem({ ...editingProblem, name: e.target.value })}
                        className="w-full bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded px-4 py-3 outline-none transition"
                      />
                    </div>

                    <div>
                      <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Grade</label>
                      <select
                        value={editingProblem.grade}
                        onChange={(e) => setEditingProblem({ ...editingProblem, grade: e.target.value })}
                        className="w-full bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded px-4 py-3 outline-none transition"
                      >
                        {grades.map(g => (
                          <option key={g} value={g}>{g}</option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Wall Section</label>
                      <input
                        type="text"
                        value={editingProblem.wallSection || ''}
                        onChange={(e) => setEditingProblem({ ...editingProblem, wallSection: e.target.value })}
                        className="w-full bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded px-4 py-3 outline-none transition"
                        placeholder="e.g., Left side, Cave, Slab area"
                      />
                    </div>

                    <div>
                      <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Tags</label>
                      <div className="flex flex-wrap gap-2">
                        {availableTags.map(tag => (
                          <button
                            key={tag}
                            onClick={() => {
                              const currentTags = editingProblem.tags || [];
                              const newTags = currentTags.includes(tag)
                                ? currentTags.filter(t => t !== tag)
                                : [...currentTags, tag];
                              setEditingProblem({ ...editingProblem, tags: newTags });
                            }}
                            className={`px-3 py-1 rounded text-xs font-bold uppercase transition ${
                              (editingProblem.tags || []).includes(tag)
                                ? 'bg-orange-600 text-white'
                                : 'bg-zinc-800 text-zinc-400 hover:bg-zinc-700'
                            }`}
                          >
                            {tag}
                          </button>
                        ))}
                      </div>
                    </div>

                    <div>
                      <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">
                        <input
                          type="checkbox"
                          checked={editingProblem.isRetired || false}
                          onChange={(e) => setEditingProblem({ ...editingProblem, isRetired: e.target.checked })}
                          className="mr-2"
                        />
                        Mark as Retired (climb no longer exists on wall)
                      </label>
                    </div>
                  </div>

                  <div className="flex gap-3 mt-6 pt-4 border-t border-zinc-800">
                    <button
                      onClick={() => setEditingProblem(null)}
                      className="flex-1 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 py-3 rounded font-bold uppercase text-sm transition"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={() => {
                        updateProblem(editingProblem.id, {
                          name: editingProblem.name,
                          grade: editingProblem.grade,
                          wallSection: editingProblem.wallSection,
                          tags: editingProblem.tags,
                          isRetired: editingProblem.isRetired
                        });
                      }}
                      className="flex-1 bg-orange-600 hover:bg-orange-500 py-3 rounded font-bold uppercase text-sm transition"
                    >
                      Save Changes
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Header */}
          <div className="bg-zinc-900 border-b-2 border-orange-600 p-4 shadow-lg">
            <div className="max-w-7xl mx-auto flex items-center justify-between">
              <h1
                className="text-3xl font-black tracking-tight uppercase cursor-pointer hover:text-orange-500 transition"
                style={{ letterSpacing: '0.05em' }}
                onClick={() => { setActiveTab('archive'); setSelectedProblem(null); }}
              >
                The Lab
              </h1>
              <div className="flex items-center gap-4">
                {/* User Profile Button */}
                <button
                  onClick={() => setActiveTab('user')}
                  className={`flex items-center gap-2 px-3 py-2 rounded transition ${
                    activeTab === 'user' ? 'bg-orange-600' : 'bg-zinc-800 hover:bg-zinc-700'
                  }`}
                >
                  <div className="w-6 h-6 bg-zinc-700 rounded-full flex items-center justify-center overflow-hidden">
                    {profilePicture ? (
                      <img src={profilePicture} alt="" className="w-full h-full object-cover" />
                    ) : (
                      <Icon name="User" size={14} />
                    )}
                  </div>
                  <span className="text-sm font-bold hidden sm:inline">{currentUserName || 'Profile'}</span>
                </button>
                <div className="relative">
                  <button
                    onClick={() => setShowNotifications(!showNotifications)}
                    className="relative p-2 hover:bg-zinc-800 rounded transition"
                  >
                    <Icon name="Bell" size={20} />
                    {notifications.filter(n => !n.read).length > 0 && (
                      <span className="absolute top-0 right-0 bg-orange-600 text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
                        {notifications.filter(n => !n.read).length}
                      </span>
                    )}
                  </button>
                  {showNotifications && (
                    <>
                      <div
                        className="fixed inset-0 z-40"
                        onClick={() => setShowNotifications(false)}
                      />
                      <div className="absolute right-0 top-12 w-80 bg-zinc-900 border border-zinc-800 rounded-lg shadow-xl z-50 max-h-96 overflow-y-auto">
                        <div className="p-3 border-b border-zinc-800 flex justify-between items-center">
                          <span className="font-bold uppercase text-sm">Notifications</span>
                          <button onClick={clearAllNotifications} className="text-xs text-zinc-500 hover:text-orange-500">
                            Clear All
                          </button>
                        </div>
                        {notifications.length === 0 ? (
                          <div className="p-4 text-center text-zinc-500 text-sm">No notifications</div>
                        ) : (
                          notifications.slice(0, 20).map(notif => (
                            <div
                              key={notif.id}
                              onClick={() => {
                                markNotificationRead(notif.id);
                                setShowNotifications(false);
                                // Navigate based on notification type
                                if (notif.type === 'friend_added' && notif.fromUserId) {
                                  const user = allUsers.find(u => u.id === notif.fromUserId);
                                  if (user) viewUserProfile(user);
                                } else if (notif.type === 'comment' && notif.problemId) {
                                  const problem = problems.find(p => p.id === notif.problemId);
                                  if (problem) viewProblemDetail(problem, 'archive');
                                } else if (notif.type === 'send' && notif.problemId) {
                                  const problem = problems.find(p => p.id === notif.problemId);
                                  if (problem) viewProblemDetail(problem, 'archive');
                                }
                              }}
                              className={`p-3 border-b border-zinc-800 cursor-pointer hover:bg-zinc-800 ${!notif.read ? 'bg-zinc-800/50' : ''}`}
                            >
                              <p className="text-sm">{notif.message}</p>
                              <p className="text-xs text-zinc-500 mt-1">
                                {new Date(notif.timestamp).toLocaleString()}
                              </p>
                              <p className="text-xs text-orange-500 mt-1">Tap to view</p>
                            </div>
                          ))
                        )}
                      </div>
                    </>
                  )}
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto p-4">
            {activeTab === 'create' ? (
              /* CREATE VIEW */
              <div className="space-y-6">
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <div className="flex items-center justify-between mb-4 pb-3 border-b-2 border-orange-600">
                    <h2 className="text-xl font-black uppercase tracking-wide">{editingDraftId ? 'Edit Draft' : 'Create New Problem'}</h2>
                    <button
                      onClick={() => {
                        setActiveTab('archive');
                        setHolds([]);
                        setWallImage(null);
                        setImageScale(1);
                        setImagePosition({ x: 0, y: 0 });
                        setProblemName('');
                        setProblemGrade('V2');
                        setSetterName('');
                        setProblemTags([]);
                        setWallSection('');
                        setEditingDraftId(null);
                      }}
                      className="text-zinc-400 hover:text-orange-500 transition font-bold uppercase text-sm"
                    >
                      Cancel
                    </button>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                      <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Problem Name</label>
                      <input
                        type="text"
                        value={problemName}
                        onChange={(e) => setProblemName(e.target.value)}
                        className="w-full bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded px-3 py-2 transition outline-none"
                        placeholder="e.g., The Crimper"
                      />
                    </div>

                    <div>
                      <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Grade</label>
                      <select
                        value={problemGrade}
                        onChange={(e) => setProblemGrade(e.target.value)}
                        className="w-full bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded px-3 py-2 transition outline-none"
                      >
                        {grades.map(grade => (
                          <option key={grade} value={grade}>{grade}</option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Setter Name (Optional)</label>
                      <input
                        type="text"
                        value={setterName}
                        onChange={(e) => setSetterName(e.target.value)}
                        className="w-full bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded px-3 py-2 transition outline-none"
                        placeholder="Your name"
                      />
                    </div>

                    <div className="md:col-span-2">
                      <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Comments (Optional)</label>
                      <textarea
                        value={wallSection}
                        onChange={(e) => setWallSection(e.target.value)}
                        className="w-full bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded px-3 py-2 transition outline-none"
                        placeholder="e.g., Yellow volumes are off, start matched on the jug"
                        rows={2}
                      />
                    </div>
                  </div>

                  {/* Tags */}
                  <div className="mb-6">
                    <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Style Tags</label>
                    <div className="flex flex-wrap gap-2">
                      {availableTags.map(tag => (
                        <button
                          key={tag}
                          onClick={() => {
                            if (problemTags.includes(tag)) {
                              setProblemTags(problemTags.filter(t => t !== tag));
                            } else {
                              setProblemTags([...problemTags, tag]);
                            }
                          }}
                          className={`px-3 py-1 rounded text-xs font-bold uppercase transition ${
                            problemTags.includes(tag)
                              ? 'bg-orange-600 border-orange-400'
                              : 'bg-zinc-800 border-zinc-700 hover:border-orange-600'
                          } border`}
                        >
                          {tag}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Save Buttons */}
                  <div className="flex gap-3 mb-6">
                    <button
                      onClick={() => saveProblem(true)}
                      className="flex-1 bg-zinc-800 hover:bg-zinc-700 border-2 border-zinc-700 px-4 py-2 rounded transition font-bold uppercase text-sm tracking-wide"
                    >
                      Save as Draft
                    </button>
                    <button
                      onClick={() => saveProblem(false)}
                      className="flex-1 bg-orange-600 hover:bg-orange-500 px-4 py-2 rounded transition font-bold uppercase text-sm tracking-wide shadow-lg"
                    >
                      Publish Problem
                    </button>
                  </div>

                  {/* Image Upload */}
                  <div className="mb-6">
                    <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Upload Wall Photo</label>
                    {!wallImage ? (
                      <label className="flex flex-col items-center justify-center w-full h-32 bg-zinc-950 border-2 border-dashed border-zinc-700 rounded cursor-pointer hover:border-orange-600 transition">
                        <Icon name="Upload" size={32} className="text-zinc-600 mb-2" />
                        <span className="text-sm text-zinc-500 uppercase tracking-wide font-bold">Click to upload wall photo</span>
                        <input
                          type="file"
                          accept="image/*"
                          onChange={handleImageUpload}
                          className="hidden"
                        />
                      </label>
                    ) : (
                      <div className="flex items-center gap-3">
                        <div className="text-sm text-orange-500 flex-grow font-bold">âœ“ Photo uploaded</div>
                        <button
                          onClick={clearWallImage}
                          className="bg-red-600 hover:bg-red-500 px-3 py-2 rounded text-sm font-bold uppercase"
                        >
                          Remove Photo
                        </button>
                      </div>
                    )}
                  </div>

                  {wallImage && (
                    <>
                      <div className="bg-zinc-950 rounded-lg p-4 mb-4 border border-zinc-800">
                        <h3 className="font-black mb-3 uppercase tracking-wide text-sm">Select Hold Type:</h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                          <button
                            onClick={() => setCurrentHoldType('start')}
                            className={`flex items-center gap-2 p-3 rounded transition border-2 ${
                              currentHoldType === 'start' ? 'bg-green-600 border-green-400' : 'bg-zinc-900 border-zinc-700 hover:border-green-600'
                            }`}
                          >
                            <div className="w-6 h-6 rounded-full bg-green-500 border-2 border-white"></div>
                            <span className="text-sm font-bold uppercase">Start</span>
                          </button>
                          <button
                            onClick={() => setCurrentHoldType('hand')}
                            className={`flex items-center gap-2 p-3 rounded transition border-2 ${
                              currentHoldType === 'hand' ? 'bg-blue-600 border-blue-400' : 'bg-zinc-900 border-zinc-700 hover:border-blue-600'
                            }`}
                          >
                            <div className="w-6 h-6 rounded-full bg-blue-500"></div>
                            <span className="text-sm font-bold uppercase">Hand</span>
                          </button>
                          <button
                            onClick={() => setCurrentHoldType('foot')}
                            className={`flex items-center gap-2 p-3 rounded transition border-2 ${
                              currentHoldType === 'foot' ? 'bg-pink-600 border-pink-400' : 'bg-zinc-900 border-zinc-700 hover:border-pink-600'
                            }`}
                          >
                            <div className="w-6 h-6 rounded-full bg-pink-500"></div>
                            <span className="text-sm font-bold uppercase">Foot</span>
                          </button>
                          <button
                            onClick={() => setCurrentHoldType('finish')}
                            className={`flex items-center gap-2 p-3 rounded transition border-2 ${
                              currentHoldType === 'finish' ? 'bg-red-600 border-red-400' : 'bg-zinc-900 border-zinc-700 hover:border-red-600'
                            }`}
                          >
                            <div className="w-6 h-6 rounded-full bg-red-500 border-2 border-white"></div>
                            <span className="text-sm font-bold uppercase">Finish</span>
                          </button>
                        </div>
                      </div>

                      <div className="bg-zinc-950 rounded-lg p-4 mb-4 border border-zinc-800">
                        <div className="flex items-center justify-between mb-3">
                          <h3 className="font-black uppercase tracking-wide text-sm">Holds placed: <span className="text-orange-500">{holds.length}</span></h3>
                          <div className="flex gap-2">
                            <div className="flex gap-1 bg-zinc-900 rounded p-1 border border-zinc-800">
                              <button
                                onClick={handleUndo}
                                disabled={holdHistory.length === 0}
                                className={`px-3 py-2 rounded transition ${holdHistory.length === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-zinc-700'}`}
                                title="Undo"
                              >
                                <Icon name="Undo" size={20} />
                              </button>
                              <button
                                onClick={handleRedo}
                                disabled={holdFuture.length === 0}
                                className={`px-3 py-2 rounded transition ${holdFuture.length === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-zinc-700'}`}
                                title="Redo"
                              >
                                <Icon name="Redo" size={20} />
                              </button>
                            </div>
                            <button
                              onClick={handleZoomOut}
                              className="bg-zinc-900 hover:bg-zinc-700 p-2 rounded border border-zinc-800"
                              title="Zoom Out"
                            >
                              <Icon name="ZoomOut" size={20} />
                            </button>
                            <button
                              onClick={handleZoomIn}
                              className="bg-zinc-900 hover:bg-zinc-700 p-2 rounded border border-zinc-800"
                              title="Zoom In"
                            >
                              <Icon name="ZoomIn" size={20} />
                            </button>
                          </div>
                        </div>
                        <p className="text-xs text-zinc-500 uppercase tracking-wide mb-3">
                          Tap to place holds. Drag to pan. Pinch or scroll to zoom. Tap hold to cycle: start â†’ hand â†’ foot â†’ finish â†’ remove.
                        </p>
                        <div className="flex flex-wrap gap-4 text-xs text-zinc-400">
                          <div className="flex items-center gap-2">
                            <div className="w-4 h-4 rounded-full bg-green-500" style={{ border: '2px double white', outline: '1px solid white', outlineOffset: '0px' }}></div>
                            <span>Start (double)</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <div className="w-4 h-4 rounded-full bg-blue-500 border-2 border-white"></div>
                            <span>Hand (solid)</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <div className="w-3 h-3 rounded-full bg-pink-500" style={{ border: '2px dashed white' }}></div>
                            <span>Foot (dashed)</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <div className="w-4 h-4 rounded-full bg-red-500" style={{ border: '3px solid white' }}></div>
                            <span>Finish (thick)</span>
                          </div>
                        </div>
                      </div>
                    </>
                  )}
                </div>

                {/* Interactive Wall */}
                {wallImage && (
                  <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                    <div
                      className="relative overflow-hidden bg-black rounded touch-none"
                      style={{ height: '70vh', maxHeight: '600px', minHeight: '300px', cursor: isDragging ? 'grabbing' : 'crosshair' }}
                      onMouseDown={handleMouseDown}
                      onMouseMove={handleMouseMove}
                      onMouseUp={handleMouseUp}
                      onMouseLeave={handleMouseUp}
                      onWheel={handleWheel}
                      onTouchStart={handleTouchStart}
                      onTouchMove={handleTouchMove}
                      onTouchEnd={handleTouchEnd}
                    >
                      <div
                        style={{
                          transform: `translate(${imagePosition.x}px, ${imagePosition.y}px) scale(${imageScale})`,
                          transformOrigin: 'center center',
                          transition: isDragging ? 'none' : 'transform 0.1s',
                          position: 'relative',
                          display: 'inline-block'
                        }}
                      >
                        <img
                          src={wallImage}
                          alt="Climbing wall"
                          className="max-w-none"
                          style={{
                            width: 'auto',
                            height: '600px',
                            userSelect: 'none',
                            pointerEvents: 'none'
                          }}
                          draggable={false}
                        />
                        <div
                          onClick={handleImageClick}
                          onContextMenu={(e) => e.preventDefault()}
                          style={{
                            position: 'absolute',
                            top: 0,
                            left: 0,
                            width: '100%',
                            height: '100%'
                          }}
                        >
                          {holds.map((hold, index) => {
                            const cycleHold = (e) => {
                              e.preventDefault();
                              e.stopPropagation();
                              // Cycle: start -> hand -> foot -> finish -> remove
                              const types = ['start', 'hand', 'foot', 'finish'];
                              const currentIndex = types.indexOf(hold.type);
                              if (currentIndex === types.length - 1) {
                                removeHold(hold.id);
                              } else {
                                const nextType = types[currentIndex + 1];
                                changeHoldType(hold.id, nextType);
                              }
                            };
                            return (
                              <div
                                key={hold.id}
                                onContextMenu={(e) => {
                                  e.preventDefault();
                                  e.stopPropagation();
                                  removeHold(hold.id);
                                }}
                                onClick={cycleHold}
                                onTouchEnd={(e) => {
                                  e.preventDefault();
                                  e.stopPropagation();
                                  cycleHold(e);
                                }}
                                style={{
                                  position: 'absolute',
                                  left: `${hold.x}%`,
                                  top: `${hold.y}%`,
                                  transform: 'translate(-50%, -50%)',
                                  width: hold.type === 'foot' ? '14px' : (hold.type === 'start' || hold.type === 'finish' ? '20px' : '16px'),
                                  height: hold.type === 'foot' ? '14px' : (hold.type === 'start' || hold.type === 'finish' ? '20px' : '16px'),
                                  borderRadius: '50%',
                                  backgroundColor: getHoldColorByType(hold.type),
                                  opacity: 0.7,
                                  cursor: 'pointer',
                                  boxShadow: `0 0 0 1px ${getHoldColorByType(hold.type)}, 0 0 8px ${getHoldColorByType(hold.type)}, 0 2px 6px rgba(0,0,0,0.8)`,
                                  zIndex: 10,
                                  touchAction: 'none',
                                  ...getHoldBorderStyle(hold.type)
                                }}
                                title={`${hold.type} hold - Tap to change type (removes after finish)`}
                              />
                            );
                          })}
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            ) : activeTab === 'detail' && selectedProblem ? (
              /* PROBLEM DETAIL VIEW */
              <div className="space-y-6">
                <div className="flex items-center justify-between">
                  <button
                    onClick={navigateBack}
                    className="flex items-center gap-2 text-zinc-400 hover:text-white transition"
                  >
                    <Icon name="ChevronLeft" size={24} />
                    <span className="font-bold uppercase text-sm">Back</span>
                  </button>
                  <div className="flex gap-2">
                    <button
                      onClick={() => setShowHolds(!showHolds)}
                      className={`p-2 rounded transition border ${showHolds ? 'bg-orange-600 border-orange-400' : 'bg-zinc-800 border-zinc-700'}`}
                      title={showHolds ? 'Hide Holds' : 'Show Holds'}
                    >
                      <Icon name={showHolds ? 'Eye' : 'EyeOff'} size={20} />
                    </button>
                    <button
                      onClick={() => exportProblemImage(selectedProblem)}
                      className="p-2 rounded bg-zinc-800 border border-zinc-700 hover:bg-zinc-700 transition"
                      title="Export/Share"
                    >
                      <Icon name="Share2" size={20} />
                    </button>
                    {(selectedProblem.setterId === currentUserId || isAdmin) && (
                      <>
                        <button
                          onClick={() => setEditingProblem(selectedProblem)}
                          className="p-2 rounded bg-blue-600 border border-blue-500 hover:bg-blue-500 transition"
                          title="Edit Problem"
                        >
                          <Icon name="Edit2" size={20} />
                        </button>
                        <button
                          onClick={() => {
                            if (confirm('Are you sure you want to delete this problem?')) {
                              isAdmin ? deleteProblemAsAdmin(selectedProblem.id) : deleteProblem(selectedProblem.id);
                            }
                          }}
                          className="p-2 rounded bg-red-900 border border-red-700 hover:bg-red-800 transition"
                          title="Delete Problem"
                        >
                          <Icon name="Trash2" size={20} />
                        </button>
                      </>
                    )}
                    {isAdmin && (
                      <button
                        onClick={() => featureProblem(selectedProblem.id)}
                        className={`p-2 rounded border transition ${
                          featuredProblems.includes(selectedProblem.id)
                            ? 'bg-yellow-600 border-yellow-500 hover:bg-yellow-500'
                            : 'bg-zinc-800 border-zinc-700 hover:bg-zinc-700'
                        }`}
                        title={featuredProblems.includes(selectedProblem.id) ? 'Unfeature Problem' : 'Feature Problem'}
                      >
                        <Icon name="Star" size={20} />
                      </button>
                    )}
                  </div>
                </div>

                {/* Problem Info Card */}
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <div className="flex items-start justify-between mb-4">
                    <div>
                      <h2 className="text-2xl font-black uppercase tracking-wide">{selectedProblem.name}</h2>
                      <p className="text-zinc-500 text-sm uppercase tracking-wider">Set by {selectedProblem.setter}</p>
                    </div>
                    <div className="text-right">
                      <span className="bg-orange-600 px-4 py-2 rounded font-black text-2xl border-2 border-orange-400">
                        {getConsensusGrade(selectedProblem.id)?.grade || selectedProblem.grade}
                      </span>
                      <p className="text-xs text-zinc-500 mt-2">Setter: {selectedProblem.grade}</p>
                    </div>
                  </div>

                  {selectedProblem.tags && selectedProblem.tags.length > 0 && (
                    <div className="flex flex-wrap gap-2 mb-4">
                      {selectedProblem.tags.map(tag => (
                        <span key={tag} className="bg-zinc-800 px-2 py-1 rounded text-xs font-bold uppercase text-zinc-400">
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}

                  <div className="flex gap-6 text-sm text-zinc-400">
                    <button
                      onClick={() => selectedProblem.sends > 0 && setShowSendsDetails(true)}
                      className={`flex items-center gap-2 ${selectedProblem.sends > 0 ? 'hover:text-orange-500 cursor-pointer' : ''}`}
                    >
                      <Icon name="Users" size={16} />
                      <span className="font-bold">{selectedProblem.sends} sends</span>
                    </button>
                    <button
                      onClick={() => selectedProblem.ratings?.length > 0 && setShowRatingDetails(true)}
                      className={`flex items-center gap-2 ${selectedProblem.ratings?.length > 0 ? 'hover:text-orange-500 cursor-pointer' : ''}`}
                    >
                      <Icon name="Star" size={16} className={selectedProblem.averageRating > 0 ? 'text-yellow-500' : ''} />
                      <span className="font-bold">
                        {selectedProblem.averageRating > 0
                          ? selectedProblem.averageRating.toFixed(1)
                          : 'Not rated'}
                      </span>
                    </button>
                    {attempts[selectedProblem.id] && (
                      <div className="flex items-center gap-2">
                        <Icon name="Target" size={16} />
                        <span className="font-bold">{attempts[selectedProblem.id].attempts} attempts</span>
                      </div>
                    )}
                  </div>
                </div>

                {/* Full-screen Wall Image */}
                <div
                  ref={detailImageRef}
                  className="bg-zinc-900 rounded-lg p-4 border border-zinc-800 shadow-xl relative"
                  onTouchStart={(e) => {
                    if (detailZoom === 1 && e.touches.length === 1) {
                      detailSwipeStartRef.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                    }
                  }}
                  onTouchEnd={(e) => {
                    if (detailSwipeStartRef.current && detailZoom === 1) {
                      const deltaX = e.changedTouches[0].clientX - detailSwipeStartRef.current.x;
                      const deltaY = Math.abs(e.changedTouches[0].clientY - detailSwipeStartRef.current.y);
                      // Only trigger swipe if horizontal movement is significant and vertical is minimal
                      if (Math.abs(deltaX) > 80 && deltaY < 100) {
                        if (deltaX > 0) {
                          navigateProblem('prev');
                        } else {
                          navigateProblem('next');
                        }
                      }
                      detailSwipeStartRef.current = null;
                    }
                  }}
                >
                  {/* Navigation arrows */}
                  {canNavigate('prev') && (
                    <button
                      onClick={() => navigateProblem('prev')}
                      className="absolute left-2 top-1/2 -translate-y-1/2 z-10 bg-black/60 hover:bg-black/80 p-2 rounded-full transition"
                      title="Previous climb"
                    >
                      <Icon name="ChevronLeft" size={24} />
                    </button>
                  )}
                  {canNavigate('next') && (
                    <button
                      onClick={() => navigateProblem('next')}
                      className="absolute right-2 top-1/2 -translate-y-1/2 z-10 bg-black/60 hover:bg-black/80 p-2 rounded-full transition"
                      title="Next climb"
                    >
                      <Icon name="ChevronRight" size={24} />
                    </button>
                  )}
                  <div className="flex justify-end gap-2 mb-3">
                    <button
                      onClick={() => {
                        setDetailZoom(prev => {
                          const newZoom = Math.max(1, prev - 0.25);
                          if (newZoom <= 1) setDetailPosition({ x: 0, y: 0 });
                          return newZoom;
                        });
                      }}
                      className="bg-zinc-800 hover:bg-zinc-700 p-2 rounded border border-zinc-700"
                      title="Zoom Out"
                    >
                      <Icon name="ZoomOut" size={18} />
                    </button>
                    <button
                      onClick={() => { setDetailZoom(1); setDetailPosition({ x: 0, y: 0 }); }}
                      className="bg-zinc-800 hover:bg-zinc-700 px-3 py-2 rounded border border-zinc-700 text-xs font-bold"
                      title="Reset View"
                    >
                      {Math.round(detailZoom * 100)}%
                    </button>
                    <button
                      onClick={() => setDetailZoom(prev => Math.min(3, prev + 0.25))}
                      className="bg-zinc-800 hover:bg-zinc-700 p-2 rounded border border-zinc-700"
                      title="Zoom In"
                    >
                      <Icon name="ZoomIn" size={18} />
                    </button>
                  </div>
                  <div
                    className="relative overflow-hidden rounded touch-none"
                    style={{ minHeight: '400px', cursor: detailZoom > 1 ? (detailDragging ? 'grabbing' : 'grab') : 'default' }}
                    onMouseDown={(e) => {
                      if (detailZoom > 1) {
                        setDetailDragging(true);
                        setDetailDragStart({ x: e.clientX - detailPosition.x, y: e.clientY - detailPosition.y });
                      }
                    }}
                    onMouseMove={(e) => {
                      if (detailDragging && detailZoom > 1) {
                        setDetailPosition({
                          x: e.clientX - detailDragStart.x,
                          y: e.clientY - detailDragStart.y
                        });
                      }
                    }}
                    onMouseUp={() => setDetailDragging(false)}
                    onMouseLeave={() => setDetailDragging(false)}
                    onTouchStart={(e) => {
                      if (e.touches.length === 1 && detailZoom > 1) {
                        setDetailDragging(true);
                        setDetailDragStart({
                          x: e.touches[0].clientX - detailPosition.x,
                          y: e.touches[0].clientY - detailPosition.y
                        });
                      } else if (e.touches.length === 2) {
                        const dist = Math.hypot(
                          e.touches[0].clientX - e.touches[1].clientX,
                          e.touches[0].clientY - e.touches[1].clientY
                        );
                        lastTouchDistance.current = dist;
                      }
                    }}
                    onTouchMove={(e) => {
                      if (e.touches.length === 1 && detailDragging && detailZoom > 1) {
                        setDetailPosition({
                          x: e.touches[0].clientX - detailDragStart.x,
                          y: e.touches[0].clientY - detailDragStart.y
                        });
                      } else if (e.touches.length === 2 && lastTouchDistance.current) {
                        const dist = Math.hypot(
                          e.touches[0].clientX - e.touches[1].clientX,
                          e.touches[0].clientY - e.touches[1].clientY
                        );
                        const delta = (dist - lastTouchDistance.current) * 0.01;
                        setDetailZoom(prev => {
                          const newZoom = Math.max(1, Math.min(3, prev + delta));
                          if (newZoom <= 1) setDetailPosition({ x: 0, y: 0 });
                          return newZoom;
                        });
                        lastTouchDistance.current = dist;
                      }
                    }}
                    onTouchEnd={() => {
                      setDetailDragging(false);
                      lastTouchDistance.current = null;
                      if (detailZoom <= 1) setDetailPosition({ x: 0, y: 0 });
                    }}
                    onWheel={(e) => {
                      const delta = e.deltaY > 0 ? -0.1 : 0.1;
                      setDetailZoom(prev => {
                        const newZoom = Math.max(1, Math.min(3, prev + delta));
                        if (newZoom <= 1) setDetailPosition({ x: 0, y: 0 });
                        return newZoom;
                      });
                    }}
                  >
                    <div
                      style={{
                        transform: `translate(${detailPosition.x}px, ${detailPosition.y}px) scale(${detailZoom})`,
                        transformOrigin: 'center center',
                        transition: detailDragging ? 'none' : 'transform 0.1s'
                      }}
                    >
                      <img
                        src={selectedProblem.wallImage}
                        alt={selectedProblem.name}
                        className="w-full h-auto rounded"
                        draggable={false}
                        style={{ userSelect: 'none' }}
                      />
                      {showHolds && (
                        <div className="absolute inset-0">
                          {selectedProblem.holds?.map((hold, index) => (
                            <div
                              key={hold.id}
                              style={{
                                position: 'absolute',
                                left: `${hold.x}%`,
                                top: `${hold.y}%`,
                                transform: 'translate(-50%, -50%)',
                                width: hold.type === 'foot' ? '12px' : (hold.type === 'start' || hold.type === 'finish' ? '22px' : '16px'),
                                height: hold.type === 'foot' ? '12px' : (hold.type === 'start' || hold.type === 'finish' ? '22px' : '16px'),
                                borderRadius: '50%',
                                backgroundColor: getHoldColorByType(hold.type),
                                opacity: 0.7,
                                boxShadow: `0 0 0 1px ${getHoldColorByType(hold.type)}, 0 0 8px ${getHoldColorByType(hold.type)}, 0 2px 6px rgba(0,0,0,0.8)`,
                                ...getHoldBorderStyle(hold.type)
                              }}
                            />
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                  <p className="text-xs text-zinc-500 mt-2 text-center">Drag to pan â€¢ Scroll to zoom</p>
                </div>

                {/* Comments */}
                {selectedProblem.wallSection && (
                  <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                    <h3 className="text-sm font-black uppercase tracking-wide mb-2 text-zinc-400">Comments</h3>
                    <p className="text-zinc-300">{selectedProblem.wallSection}</p>
                  </div>
                )}

                {/* Actions */}
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                    <button
                      onClick={() => logAttempt(selectedProblem.id)}
                      className="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 p-4 rounded transition text-center active:scale-95 active:bg-zinc-600"
                    >
                      <Icon name="Target" size={24} className="mx-auto mb-2" />
                      <span className="font-bold uppercase text-sm">Log Attempt</span>
                      {attempts[selectedProblem.id]?.attempts > 0 && (
                        <span className="block text-orange-500 text-xs mt-1">
                          {attempts[selectedProblem.id].attempts} attempt{attempts[selectedProblem.id].attempts !== 1 ? 's' : ''}
                        </span>
                      )}
                    </button>
                    <button
                      onClick={() => openSendModal(selectedProblem.id)}
                      className="bg-orange-600 hover:bg-orange-500 p-4 rounded transition text-center"
                    >
                      <Icon name="Trophy" size={24} className="mx-auto mb-2" />
                      <span className="font-bold uppercase text-sm">Log Send</span>
                    </button>
                    <button
                      onClick={() => toggleProject(selectedProblem.id)}
                      className={`p-4 rounded transition text-center ${
                        projects.includes(selectedProblem.id)
                          ? 'bg-purple-600 hover:bg-purple-500'
                          : 'bg-zinc-800 hover:bg-zinc-700 border border-zinc-700'
                      }`}
                    >
                      <Icon name="Bookmark" size={24} className="mx-auto mb-2" />
                      <span className="font-bold uppercase text-sm">
                        {projects.includes(selectedProblem.id) ? 'Projecting' : 'Add to Projects'}
                      </span>
                    </button>
                    <button
                      onClick={() => setAddToCircuitProblem(selectedProblem)}
                      className={`p-4 rounded transition text-center ${
                        circuits.some(c => c.problemIds.includes(selectedProblem.id))
                          ? 'bg-blue-600 hover:bg-blue-500'
                          : 'bg-zinc-800 hover:bg-zinc-700 border border-zinc-700'
                      }`}
                    >
                      <Icon name="Folder" size={24} className="mx-auto mb-2" />
                      <span className="font-bold uppercase text-sm">
                        {circuits.some(c => c.problemIds.includes(selectedProblem.id)) ? 'In Circuit' : 'Add to Circuit'}
                      </span>
                    </button>
                  </div>

                  <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div className="bg-zinc-800 border border-zinc-700 p-4 rounded">
                      <p className="text-xs text-zinc-500 uppercase mb-2">
                        Rate {userRatings[selectedProblem.id] ? `(${userRatings[selectedProblem.id]}â˜…)` : ''}
                      </p>
                      <div className="flex gap-1 justify-center">
                        {[1, 2, 3, 4, 5].map(starNum => (
                          <button
                            key={starNum}
                            onClick={() => rateProblem(selectedProblem.id, starNum)}
                            className="hover:scale-110 transition"
                            title={userRatings[selectedProblem.id] === starNum ? 'Click to remove rating' : `Rate ${starNum} star${starNum > 1 ? 's' : ''}`}
                          >
                            <Icon name="Star" size={20} className={starNum <= (userRatings[selectedProblem.id] || 0) ? 'fill-orange-500 text-orange-500' : 'text-zinc-600'} />
                          </button>
                        ))}
                      </div>
                    </div>
                    <div className="bg-zinc-800 border border-zinc-700 p-4 rounded">
                      <p className="text-xs text-zinc-500 uppercase mb-2">Suggest Grade</p>
                      <select
                        onChange={(e) => suggestGrade(selectedProblem.id, e.target.value)}
                        defaultValue=""
                        className="w-full bg-zinc-900 border border-zinc-700 rounded px-2 py-1 text-sm"
                      >
                        <option value="" disabled>Select grade</option>
                        {grades.map(grade => (
                          <option key={grade} value={grade}>{grade}</option>
                        ))}
                      </select>
                    </div>
                    <button
                      onClick={() => copyShareLink(selectedProblem.id)}
                      className="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 p-4 rounded transition text-center"
                    >
                      <Icon name="Link" size={24} className="mx-auto mb-2" />
                      <span className="font-bold uppercase text-sm">Share Link</span>
                    </button>
                  </div>

                  <div className="mt-4">
                    <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">My Notes (Private)</label>
                    <textarea
                      value={personalNotes[selectedProblem.id] || ''}
                      onChange={(e) => updatePersonalNote(selectedProblem.id, e.target.value)}
                      placeholder="Add your beta notes, what worked, what didn't..."
                      className="w-full bg-zinc-950 border border-zinc-700 focus:border-orange-600 rounded p-3 transition outline-none text-sm"
                      rows={3}
                    />
                  </div>
                </div>

                {/* Video Beta Section */}
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <h3 className="text-lg font-black uppercase tracking-wide mb-4 pb-2 border-b border-zinc-800">
                    <Icon name="Video" size={20} className="inline mr-2" />
                    Video Beta ({(videoBeta[selectedProblem.id] || []).length})
                  </h3>

                  {/* Upload Video */}
                  <div className="mb-4">
                    <label className="flex items-center justify-center gap-2 bg-zinc-950 border-2 border-dashed border-zinc-700 hover:border-purple-600 rounded-lg p-4 cursor-pointer transition">
                      <Icon name="Upload" size={20} className="text-purple-500" />
                      <span className="text-sm font-bold uppercase tracking-wider">Upload Video Beta</span>
                      <input
                        type="file"
                        accept="video/*"
                        className="hidden"
                        onChange={(e) => {
                          const file = e.target.files[0];
                          if (file) {
                            if (file.size > 50 * 1024 * 1024) {
                              alert('Video must be under 50MB');
                              return;
                            }
                            const reader = new FileReader();
                            reader.onload = (ev) => addVideoBeta(selectedProblem.id, ev.target.result);
                            reader.readAsDataURL(file);
                          }
                        }}
                      />
                    </label>
                    <p className="text-xs text-zinc-500 text-center mt-2">Max 50MB. Share your send or show the beta!</p>
                  </div>

                  {/* Video List */}
                  {(videoBeta[selectedProblem.id] || []).length > 0 && (
                    <div className="space-y-4">
                      {(videoBeta[selectedProblem.id] || []).map(video => (
                        <div key={video.id} className="bg-zinc-950 rounded-lg overflow-hidden border border-zinc-800">
                          <video
                            src={video.videoUrl}
                            controls
                            className="w-full max-h-64 object-contain bg-black"
                          />
                          <div className="p-3 flex items-center justify-between">
                            <div>
                              <span className="font-bold text-sm">{video.userName}</span>
                              <span className="text-zinc-500 text-xs ml-2">
                                {new Date(video.timestamp).toLocaleDateString()}
                              </span>
                            </div>
                            {video.userId === currentUserId && (
                              <button
                                onClick={() => deleteVideoBeta(selectedProblem.id, video.id)}
                                className="text-red-500 hover:text-red-400 text-xs flex items-center gap-1"
                              >
                                <Icon name="Trash2" size={14} />
                                Delete
                              </button>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}

                  {(videoBeta[selectedProblem.id] || []).length === 0 && (
                    <p className="text-center text-zinc-500 py-4">No video beta yet. Be the first to share!</p>
                  )}
                </div>

                {/* Comments Section */}
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <h3 className="text-lg font-black uppercase tracking-wide mb-4 pb-2 border-b border-zinc-800">
                    <Icon name="MessageCircle" size={20} className="inline mr-2" />
                    Beta & Comments ({(comments[selectedProblem.id] || []).length})
                  </h3>

                  <div className="mb-6">
                    <textarea
                      value={newComment}
                      onChange={(e) => setNewComment(e.target.value)}
                      placeholder="Share beta or ask a question..."
                      className="w-full bg-zinc-950 border border-zinc-700 focus:border-orange-600 rounded p-3 transition outline-none text-sm mb-2"
                      rows={2}
                    />
                    <div className="flex items-center justify-between">
                      <label className="flex items-center gap-2 text-sm text-zinc-500">
                        <input
                          type="checkbox"
                          checked={isSpoiler}
                          onChange={(e) => setIsSpoiler(e.target.checked)}
                          className="rounded"
                        />
                        Mark as beta spoiler
                      </label>
                      <button
                        onClick={() => addComment(selectedProblem.id, newComment, isSpoiler)}
                        disabled={!newComment.trim()}
                        className="bg-orange-600 hover:bg-orange-500 disabled:opacity-50 px-4 py-2 rounded font-bold uppercase text-sm transition"
                      >
                        Post
                      </button>
                    </div>
                  </div>

                  <div className="space-y-4">
                    {(comments[selectedProblem.id] || []).map((comment, commentIndex) => (
                      <div key={comment.id} className="bg-zinc-950 rounded p-4 border border-zinc-800">
                        <div className="flex items-start justify-between mb-2">
                          <div className="flex items-center gap-2">
                            <span
                              className="font-bold text-sm hover:text-orange-500 cursor-pointer transition"
                              onClick={() => {
                                const user = allUsers.find(u => u.id === comment.userId);
                                if (user) viewUserProfile(user);
                              }}
                            >{comment.userName}</span>
                            {comment.userId && comment.userId !== currentUserId && !friends.includes(comment.userId) && (
                              <button
                                onClick={() => addFriend(comment.userId)}
                                className="text-xs text-orange-500 hover:text-orange-400 flex items-center gap-1"
                                title="Add friend"
                              >
                                <Icon name="UserPlus" size={12} />
                              </button>
                            )}
                            <span className="text-zinc-500 text-xs">
                              {new Date(comment.timestamp).toLocaleDateString()}
                            </span>
                          </div>
                          <div className="flex items-center gap-2">
                            {isAdmin && (
                              <button
                                onClick={() => {
                                  if (confirm('Delete this comment?')) {
                                    deleteCommentAsAdmin(selectedProblem.id, commentIndex);
                                  }
                                }}
                                className="text-red-500 hover:text-red-400"
                                title="Delete comment (Admin)"
                              >
                                <Icon name="Trash2" size={14} />
                              </button>
                            )}
                            <button
                              onClick={() => likeComment(selectedProblem.id, comment.id)}
                              className={`flex items-center gap-1 text-xs ${comment.likes?.includes(currentUserId) ? 'text-orange-500' : 'text-zinc-500'}`}
                            >
                              <Icon name="ThumbsUp" size={14} />
                              {comment.likes?.length || 0}
                            </button>
                          </div>
                        </div>
                        {comment.isSpoiler ? (
                          <details className="text-sm">
                            <summary className="cursor-pointer text-orange-500 font-bold uppercase text-xs">
                              Beta Spoiler - Click to reveal
                            </summary>
                            <p className="mt-2 text-zinc-300">{comment.text}</p>
                          </details>
                        ) : (
                          <p className="text-sm text-zinc-300">{comment.text}</p>
                        )}
                      </div>
                    ))}
                    {(comments[selectedProblem.id] || []).length === 0 && (
                      <p className="text-center text-zinc-500 py-4">No comments yet. Be the first to share beta!</p>
                    )}
                  </div>
                </div>
              </div>
            ) : activeTab === 'archive' ? (
              /* ARCHIVE VIEW */
              <div className="space-y-6">
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                      <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Search</label>
                      <div className="relative">
                        <input
                          type="text"
                          value={searchTerm}
                          onChange={(e) => setSearchTerm(e.target.value)}
                          className="w-full bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded pl-10 pr-3 py-2 outline-none transition"
                          placeholder="Search problems..."
                        />
                      </div>
                    </div>

                    <div>
                      <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Sort By</label>
                      <select
                        value={sortBy}
                        onChange={(e) => setSortBy(e.target.value)}
                        className="w-full bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded px-3 py-2 outline-none transition"
                      >
                        <option value="newest">Newest First</option>
                        <option value="rating">Highest Rated</option>
                        <option value="popularity">Most Popular</option>
                        <option value="difficulty">Hardest First</option>
                      </select>
                    </div>

                    <div>
                      <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Min Grade</label>
                      <select
                        value={filterGradeMin}
                        onChange={(e) => setFilterGradeMin(e.target.value)}
                        className="w-full bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded px-3 py-2 outline-none transition"
                      >
                        {grades.map(grade => (
                          <option key={grade} value={grade}>{grade}</option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Max Grade</label>
                      <select
                        value={filterGradeMax}
                        onChange={(e) => setFilterGradeMax(e.target.value)}
                        className="w-full bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded px-3 py-2 outline-none transition"
                      >
                        {grades.map(grade => (
                          <option key={grade} value={grade}>{grade}</option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Filter</label>
                      <button
                        onClick={() => {
                          if (climbFilter === 'all') setClimbFilter('friends');
                          else if (climbFilter === 'friends') setClimbFilter('mine');
                          else setClimbFilter('all');
                        }}
                        className={`w-full px-3 py-2 rounded font-bold uppercase text-sm tracking-wide transition border-2 ${
                          climbFilter !== 'all'
                            ? 'bg-orange-600 border-orange-400'
                            : 'bg-zinc-950 border-zinc-700 hover:border-orange-600'
                        }`}
                      >
                        {climbFilter === 'all' && 'All Climbs'}
                        {climbFilter === 'friends' && 'Friends Only'}
                        {climbFilter === 'mine' && 'My Climbs'}
                      </button>
                    </div>
                  </div>

                  <div className="mt-4 flex justify-end">
                    <button
                      onClick={() => setViewDrafts(!viewDrafts)}
                      className={`px-4 py-2 rounded font-bold uppercase text-xs tracking-wide transition border-2 ${
                        viewDrafts
                          ? 'bg-orange-600 border-orange-400'
                          : 'bg-zinc-950 border-zinc-700 hover:border-orange-600'
                      }`}
                    >
                      {viewDrafts ? `View Published (${problems.length})` : `View Drafts (${drafts.filter(d => d.setterId === currentUserId).length})`}
                    </button>
                  </div>
                </div>

                <div className="space-y-4">
                  {viewDrafts ? (
                    drafts.filter(d => d.setterId === currentUserId).length === 0 ? (
                      <div className="bg-zinc-900 rounded-lg p-12 text-center border border-zinc-800">
                        <p className="text-zinc-500 text-lg font-bold uppercase tracking-wide">No drafts saved. Create a draft to work on later!</p>
                      </div>
                    ) : (
                      drafts.filter(d => d.setterId === currentUserId).map(draft => (
                        <div key={draft.id} className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl hover:border-orange-600 transition">
                          <div className="flex flex-col md:flex-row gap-6">
                            <div className="flex-shrink-0">
                              <div className="bg-black rounded p-2 relative border-2 border-zinc-800" style={{ width: '200px', height: '200px' }}>
                                {draft.wallImage && (
                                  <img
                                    src={draft.wallImage}
                                    alt={draft.name}
                                    className="w-full h-full object-cover rounded"
                                  />
                                )}
                              </div>
                            </div>
                            <div className="flex-grow">
                              <div className="flex items-start justify-between mb-3">
                                <div>
                                  <div className="flex items-center gap-3">
                                    <h3 className="text-xl font-black uppercase tracking-wide">{draft.name}</h3>
                                    <span className="bg-zinc-700 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider">Draft</span>
                                  </div>
                                  <p className="text-zinc-500 text-sm uppercase tracking-wider">Set by {draft.setter}</p>
                                </div>
                                <span className="bg-orange-600 px-3 py-1 rounded font-black text-lg border-2 border-orange-400">
                                  {draft.grade}
                                </span>
                              </div>
                              {draft.setterId === currentUserId ? (
                                <div className="flex flex-wrap gap-2">
                                  <button
                                    onClick={() => setViewingDraft(draft)}
                                    className="bg-zinc-700 hover:bg-zinc-600 px-4 py-2 rounded transition text-sm font-bold uppercase tracking-wide"
                                  >
                                    <Icon name="Eye" size={14} className="inline mr-1" />
                                    View
                                  </button>
                                  <button
                                    onClick={() => editDraft(draft.id)}
                                    className="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded transition text-sm font-bold uppercase tracking-wide"
                                  >
                                    Edit Draft
                                  </button>
                                  <button
                                    onClick={() => publishDraft(draft.id)}
                                    className="bg-orange-600 hover:bg-orange-500 px-4 py-2 rounded transition text-sm font-bold uppercase tracking-wide"
                                  >
                                    Publish Now
                                  </button>
                                  <button
                                    onClick={() => deleteDraft(draft.id)}
                                    className="bg-red-900 hover:bg-red-800 border border-red-700 px-4 py-2 rounded transition text-sm font-bold uppercase tracking-wide"
                                  >
                                    Delete Draft
                                  </button>
                                </div>
                              ) : (
                                <p className="text-zinc-500 text-sm italic">Created by another user</p>
                              )}
                            </div>
                          </div>
                        </div>
                      ))
                    )
                  ) : (
                    getSortedAndFilteredProblems().length === 0 ? (
                      <div className="bg-zinc-900 rounded-lg p-12 text-center border border-zinc-800">
                        <p className="text-zinc-500 text-lg font-bold uppercase tracking-wide">No problems found. Create your first one!</p>
                      </div>
                    ) : (
                      <>
                        {/* Mobile vertical scroll view */}
                        <div className="md:hidden">
                          <div className="space-y-4">
                            {getSortedAndFilteredProblems().map(problem => (
                              <div
                                key={problem.id}
                                className="bg-zinc-900 rounded-lg p-4 border border-zinc-800 shadow-xl"
                                onClick={() => viewProblemDetail(problem, 'archive')}
                              >
                                <div className="relative mb-3">
                                  <div className="bg-black rounded border-2 border-zinc-800 overflow-hidden relative" style={{ aspectRatio: '3/4' }}>
                                    {problem.wallImage && (
                                      <>
                                        <img
                                          src={problem.wallImage}
                                          alt=""
                                          className="w-full h-full"
                                          style={{ objectFit: 'fill' }}
                                        />
                                        <div className="absolute inset-0 pointer-events-none">
                                          {problem.holds?.slice(0, 15).map(hold => (
                                            <div
                                              key={hold.id}
                                              className="absolute rounded-full"
                                              style={{
                                                left: `${hold.x}%`,
                                                top: `${hold.y}%`,
                                                transform: 'translate(-50%, -50%)',
                                                width: hold.type === 'foot' ? '8px' : (hold.type === 'start' || hold.type === 'finish' ? '14px' : '10px'),
                                                height: hold.type === 'foot' ? '8px' : (hold.type === 'start' || hold.type === 'finish' ? '14px' : '10px'),
                                                backgroundColor: getHoldColorByType(hold.type),
                                                opacity: 0.85,
                                                border: '1.5px solid white',
                                                boxShadow: `0 0 4px ${getHoldColorByType(hold.type)}`
                                              }}
                                            />
                                          ))}
                                        </div>
                                      </>
                                    )}
                                  </div>
                                  {userSends.some(s => s.problemId === problem.id) && (
                                    <div className="absolute -top-2 -right-2 bg-green-500 rounded-full p-1 border-2 border-zinc-900 shadow-lg">
                                      <Icon name="Check" size={14} className="text-white" />
                                    </div>
                                  )}
                                </div>
                                <div className="flex items-start justify-between mb-2">
                                  <div className="min-w-0 flex-1 mr-2">
                                    <h3 className="font-black uppercase tracking-wide truncate">{problem.name}</h3>
                                    <p className="text-zinc-500 text-xs uppercase tracking-wider truncate">by {problem.setter}</p>
                                  </div>
                                  <span className="bg-orange-600 px-2 py-1 rounded font-black text-sm border border-orange-400 flex-shrink-0">
                                    {getConsensusGrade(problem.id)?.grade || problem.grade}
                                  </span>
                                </div>
                                <div className="flex gap-3 text-xs text-zinc-400 mb-3">
                                  <span>{problem.sends || 0} sends</span>
                                  {(problem.averageRating || 0) > 0 && (
                                    <span className="flex items-center gap-1">
                                      <Icon name="Star" size={12} className="text-yellow-500" />
                                      {problem.averageRating.toFixed(1)}
                                    </span>
                                  )}
                                </div>
                                <div className="flex gap-2" onClick={(e) => e.stopPropagation()}>
                                  <button
                                    onClick={(e) => { e.stopPropagation(); logAttempt(problem.id); }}
                                    className="flex-1 bg-zinc-800 border border-zinc-700 px-2 py-2 rounded text-xs font-bold uppercase active:scale-95"
                                  >
                                    Attempt
                                  </button>
                                  <button
                                    onClick={(e) => { e.stopPropagation(); openSendModal(problem.id); }}
                                    className="flex-1 bg-orange-600 px-2 py-2 rounded text-xs font-bold uppercase"
                                  >
                                    Send
                                  </button>
                                  <button
                                    onClick={(e) => { e.stopPropagation(); setAddToCircuitProblem(problem); }}
                                    className="bg-zinc-800 border border-zinc-700 p-2 rounded text-xs font-bold uppercase"
                                    title="Add to circuit"
                                  >
                                    <Icon name="Folder" size={14} />
                                  </button>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Desktop list view */}
                        <div className="hidden md:block space-y-4">
                          {getSortedAndFilteredProblems().map(problem => (
                            <div
                              key={problem.id}
                              className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl hover:border-orange-600 transition cursor-pointer"
                              onClick={() => viewProblemDetail(problem, 'archive')}
                            >
                              <div className="flex flex-col md:flex-row gap-6">
                                <div className="flex-shrink-0 relative">
                                  <div className="bg-black rounded border-2 border-zinc-800 overflow-hidden relative" style={{ width: '180px', aspectRatio: '3/4' }}>
                                    {problem.wallImage && (
                                      <>
                                        <img
                                          src={problem.wallImage}
                                          alt=""
                                          className="w-full h-full"
                                          style={{ objectFit: 'fill' }}
                                        />
                                        <div className="absolute inset-0 pointer-events-none">
                                          {problem.holds?.slice(0, 15).map(hold => (
                                            <div
                                              key={hold.id}
                                              className="absolute rounded-full"
                                              style={{
                                                left: `${hold.x}%`,
                                                top: `${hold.y}%`,
                                                transform: 'translate(-50%, -50%)',
                                                width: hold.type === 'foot' ? '8px' : (hold.type === 'start' || hold.type === 'finish' ? '14px' : '10px'),
                                                height: hold.type === 'foot' ? '8px' : (hold.type === 'start' || hold.type === 'finish' ? '14px' : '10px'),
                                                backgroundColor: getHoldColorByType(hold.type),
                                                opacity: 0.85,
                                                border: '1.5px solid white',
                                                boxShadow: `0 0 4px ${getHoldColorByType(hold.type)}`
                                              }}
                                            />
                                          ))}
                                        </div>
                                      </>
                                    )}
                                  </div>
                                  {userSends.some(s => s.problemId === problem.id) && (
                                    <div className="absolute -top-2 -right-2 bg-green-500 rounded-full p-1 border-2 border-zinc-900 shadow-lg">
                                      <Icon name="Check" size={16} className="text-white" />
                                    </div>
                                  )}
                                </div>

                                <div className="flex-grow">
                                  <div className="flex items-start justify-between mb-3">
                                    <div>
                                      <h3 className="text-xl font-black uppercase tracking-wide">{problem.name}</h3>
                                      <p className="text-zinc-500 text-sm uppercase tracking-wider">Set by {problem.setter}</p>
                                      {problem.tags && problem.tags.length > 0 && (
                                        <div className="flex flex-wrap gap-1 mt-2">
                                          {problem.tags.slice(0, 3).map(tag => (
                                            <span key={tag} className="bg-zinc-800 px-2 py-0.5 rounded text-xs text-zinc-400">
                                              {tag}
                                            </span>
                                          ))}
                                        </div>
                                      )}
                                    </div>
                                    <span className="bg-orange-600 px-3 py-1 rounded font-black text-lg border-2 border-orange-400">
                                      {getConsensusGrade(problem.id)?.grade || problem.grade}
                                    </span>
                                  </div>

                                  <div className="flex gap-6 mb-4 text-sm text-zinc-400">
                                    {userSends.some(s => s.problemId === problem.id) && (
                                      <div className="flex items-center gap-2 text-green-500">
                                        <Icon name="CheckCircle" size={16} />
                                        <span className="font-bold">Sent</span>
                                      </div>
                                    )}
                                    <div className="flex items-center gap-2">
                                      <Icon name="Users" size={16} />
                                      <span className="font-bold">{problem.sends || 0} sends</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                      <Icon name="Star" size={16} className={(problem.averageRating || 0) > 0 ? 'text-yellow-500' : ''} />
                                      <span className="font-bold">
                                        {(problem.averageRating || 0) > 0
                                          ? problem.averageRating.toFixed(1)
                                          : 'Not rated yet'}
                                      </span>
                                    </div>
                                  </div>

                                  <div className="flex gap-2" onClick={(e) => e.stopPropagation()}>
                                    <button
                                      onClick={(e) => { e.stopPropagation(); logAttempt(problem.id); }}
                                      className="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 px-4 py-2 rounded transition text-sm font-bold uppercase tracking-wide active:scale-95 active:bg-zinc-600"
                                    >
                                      <Icon name="Target" size={16} className="inline mr-1" />
                                      Attempt {attempts[problem.id]?.attempts > 0 ? `(${attempts[problem.id].attempts})` : ''}
                                    </button>
                                    <button
                                      onClick={(e) => { e.stopPropagation(); openSendModal(problem.id); }}
                                      className="bg-orange-600 hover:bg-orange-500 px-4 py-2 rounded transition text-sm font-bold uppercase tracking-wide"
                                    >
                                      Log Send
                                    </button>
                                    <button
                                      onClick={(e) => { e.stopPropagation(); setAddToCircuitProblem(problem); }}
                                      className={`px-3 py-2 rounded transition text-sm font-bold uppercase tracking-wide ${
                                        circuits.some(c => c.problemIds.includes(problem.id))
                                          ? 'bg-blue-600 hover:bg-blue-500'
                                          : 'bg-zinc-800 hover:bg-zinc-700 border border-zinc-700'
                                      }`}
                                      title="Add to circuit"
                                    >
                                      <Icon name="Folder" size={16} />
                                    </button>
                                  </div>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </>
                    )
                  )}
                </div>
              </div>
            ) : activeTab === 'logbook' ? (
              /* LOGBOOK VIEW */
              <div className="space-y-6">
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800">
                  <h2 className="text-xl font-black uppercase mb-4 pb-3 border-b-2 border-orange-600">Your Sends</h2>
                  {userSends.length === 0 ? (
                    <p className="text-zinc-400 text-center py-8">No sends logged yet. Start climbing!</p>
                  ) : (
                    <div className="space-y-3">
                      {Object.entries(
                        userSends.reduce((groups, send) => {
                          const date = new Date(send.timestamp).toLocaleDateString('en-US', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                          });
                          if (!groups[date]) groups[date] = [];
                          groups[date].push(send);
                          return groups;
                        }, {})
                      ).map(([date, sends]) => {
                        const highestGrade = sends.reduce((max, s) => {
                          const grade = s.suggestedGrade || s.grade;
                          const idx = grades.indexOf(grade);
                          const maxIdx = grades.indexOf(max);
                          return idx > maxIdx ? grade : max;
                        }, 'V0');
                        const flashCount = sends.filter(s => s.isFlash).length;
                        return (
                          <details key={date} className="group bg-zinc-950 rounded-lg border border-zinc-800 overflow-hidden">
                            <summary className="flex items-center gap-4 p-4 cursor-pointer hover:bg-zinc-900 transition list-none">
                              <div className="w-10 h-10 rounded-full bg-orange-600 flex items-center justify-center font-bold">
                                {sends.length}
                              </div>
                              <div className="flex-grow">
                                <h3 className="font-bold">{date}</h3>
                                <p className="text-sm text-zinc-500">
                                  {sends.length} send{sends.length !== 1 ? 's' : ''}
                                  {flashCount > 0 && <span className="text-yellow-500 ml-2">{flashCount} flash{flashCount !== 1 ? 'es' : ''}</span>}
                                  <span className="text-zinc-600 ml-2">| Hardest: {highestGrade}</span>
                                </p>
                              </div>
                              <Icon name="ChevronDown" size={20} className="text-zinc-500 transition-transform group-open:rotate-180" />
                            </summary>
                            <div className="border-t border-zinc-800 p-3 space-y-2 bg-zinc-900/50">
                              {sends.map((send, index) => {
                                const problem = problems.find(p => p.id === send.problemId);
                                return (
                                  <div
                                    key={`${date}-${index}`}
                                    className="bg-zinc-950 rounded p-3 flex gap-3 items-center border border-zinc-800 hover:border-orange-600 transition cursor-pointer"
                                    onClick={() => problem && viewProblemDetail(problem, 'logbook')}
                                  >
                                    {problem?.wallImage && (
                                      <div className="flex-shrink-0 w-12 h-12 rounded overflow-hidden border border-zinc-700">
                                        <img
                                          src={problem.wallImage}
                                          alt={send.problemName}
                                          className="w-full h-full object-cover"
                                        />
                                      </div>
                                    )}
                                    <div className="flex-grow min-w-0">
                                      <h4 className="font-bold text-sm truncate">{send.problemName}</h4>
                                      <p className="text-xs text-zinc-500">
                                        {new Date(send.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                                        {send.isFlash && <span className="ml-2 text-yellow-500 font-bold">FLASH</span>}
                                        {send.attempts > 1 && <span className="ml-2 text-zinc-600">({send.attempts} attempts)</span>}
                                        {send.rating > 0 && <span className="ml-2 text-yellow-500">{send.rating}â˜…</span>}
                                      </p>
                                    </div>
                                    <span className="bg-orange-600 px-2 py-1 rounded font-bold text-sm flex-shrink-0">
                                      {send.suggestedGrade || send.grade}
                                    </span>
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        openEditSendModal(send);
                                      }}
                                      className="p-2 text-zinc-500 hover:text-orange-500 transition"
                                      title="Edit send"
                                    >
                                      <Icon name="Edit2" size={16} />
                                    </button>
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        deleteSend(send);
                                      }}
                                      className="p-2 text-zinc-500 hover:text-red-500 transition"
                                      title="Delete send"
                                    >
                                      <Icon name="Trash2" size={16} />
                                    </button>
                                  </div>
                                );
                              })}
                            </div>
                          </details>
                        );
                      })}
                    </div>
                  )}
                </div>

                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800">
                  <h2 className="text-xl font-black uppercase mb-4 pb-3 border-b-2 border-orange-600">Stats</h2>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-zinc-950 rounded p-4 text-center border border-zinc-800">
                      <div className="text-3xl font-bold text-orange-500">{userSends.length}</div>
                      <div className="text-sm text-zinc-400">Total Sends</div>
                    </div>
                    <div className="bg-zinc-950 rounded p-4 text-center border border-zinc-800">
                      <div className="text-3xl font-bold text-orange-500">
                        {userSends.length > 0 ? (userSends[0].suggestedGrade || userSends[0].grade) : '--'}
                      </div>
                      <div className="text-sm text-zinc-400">Latest Send</div>
                    </div>
                    <div className="bg-zinc-950 rounded p-4 text-center border border-zinc-800">
                      <div className="text-3xl font-bold text-orange-500">
                        {userSends.filter(s => s.isFlash).length}
                      </div>
                      <div className="text-sm text-zinc-400">Flashes</div>
                    </div>
                    <div className="bg-zinc-950 rounded p-4 text-center border border-zinc-800">
                      <div className="text-3xl font-bold text-orange-500">
                        {userSends.length > 0
                          ? grades[Math.max(...userSends.map(s => grades.indexOf(s.suggestedGrade || s.grade)))] || '--'
                          : '--'}
                      </div>
                      <div className="text-sm text-zinc-400">Hardest Send</div>
                    </div>
                  </div>
                </div>
              </div>
            ) : activeTab === 'leaderboard' ? (
              /* LEADERBOARD VIEW */
              <div className="space-y-6">
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <h2 className="text-xl font-black uppercase tracking-wide mb-4 pb-3 border-b-2 border-orange-600">User Rankings</h2>
                  {getLeaderboardData().rankedUsers.length === 0 ? (
                    <p className="text-zinc-500 text-center py-8 uppercase tracking-wide">No climbers yet</p>
                  ) : (
                    <div className="space-y-3">
                      {getLeaderboardData().rankedUsers.map((user, index) => (
                        <div key={user.id} className="bg-zinc-950 rounded p-4 flex items-center gap-4 border border-zinc-800 hover:border-orange-600 transition">
                          <div className={`text-2xl font-black w-10 text-center ${
                            index === 0 ? 'text-orange-500' :
                            index === 1 ? 'text-zinc-300' :
                            index === 2 ? 'text-orange-700' :
                            'text-zinc-600'
                          }`}>
                            {index + 1}
                          </div>
                          <div
                            className="flex-grow cursor-pointer"
                            onClick={() => viewUserProfile(user)}
                          >
                            <h3 className="font-black uppercase tracking-wide hover:text-orange-500 transition">{user.name}</h3>
                            <p className="text-xs text-zinc-500 uppercase tracking-wider">
                              {user.problemsCreated || 0} problems created â€¢ Tap to view
                            </p>
                          </div>
                          <div className="text-right">
                            <div className="font-black text-xl text-orange-500">{user.totalSends || 0}</div>
                            <div className="text-xs text-zinc-500 uppercase">sends</div>
                          </div>
                          <div className="text-right">
                            <div className="font-black text-lg">{user.highestGrade || 'V0'}</div>
                            <div className="text-xs text-zinc-500 uppercase">peak</div>
                          </div>
                          {user.id !== currentUserId && (
                            <button
                              onClick={(e) => { e.stopPropagation(); friends.includes(user.id) ? removeFriend(user.id) : addFriend(user.id); }}
                              className={`px-3 py-2 rounded font-bold uppercase text-xs transition ${
                                friends.includes(user.id)
                                  ? 'bg-zinc-800 hover:bg-zinc-700 border border-zinc-700'
                                  : 'bg-orange-600 hover:bg-orange-500 border border-orange-400'
                              }`}
                            >
                              {friends.includes(user.id) ? 'Remove' : 'Add Friend'}
                            </button>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <h2 className="text-xl font-black uppercase tracking-wide mb-4 pb-3 border-b-2 border-orange-600">Most Popular Problems</h2>
                  {getLeaderboardData().topProblems.length === 0 ? (
                    <p className="text-zinc-500 text-center py-8 uppercase tracking-wide">No problems yet</p>
                  ) : (
                    <div className="space-y-3">
                      {getLeaderboardData().topProblems.map((problem, index) => (
                        <div
                          key={problem.id}
                          onClick={() => {
                            const fullProblem = problems.find(p => p.id === problem.id);
                            if (fullProblem) viewProblemDetail(fullProblem, 'leaderboard');
                          }}
                          className="bg-zinc-950 rounded p-4 flex items-center gap-4 border border-zinc-800 hover:border-orange-600 cursor-pointer transition"
                        >
                          <div className={`text-2xl font-black w-8 ${
                            index === 0 ? 'text-orange-500' :
                            index === 1 ? 'text-zinc-300' :
                            index === 2 ? 'text-orange-700' :
                            'text-zinc-600'
                          }`}>
                            {index + 1}
                          </div>
                          <div className="flex-grow">
                            <h3 className="font-black uppercase tracking-wide hover:text-orange-500 transition">{problem.name}</h3>
                            <p className="text-xs text-zinc-500 uppercase tracking-wider">Set by {problem.setter} â€¢ Tap to view</p>
                          </div>
                          <div className="text-right">
                            <div className="font-black text-lg">{problem.sends} sends</div>
                            <div className="text-sm text-orange-500 font-bold">{problem.grade}</div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            ) : activeTab === 'profile' && viewingProfile ? (
              /* PROFILE VIEW - Full page profile for viewing other users */
              <div className="space-y-6">
                {/* Back Button */}
                <button
                  onClick={navigateBack}
                  className="flex items-center gap-2 text-zinc-400 hover:text-orange-500 transition font-bold uppercase text-sm"
                >
                  <Icon name="ArrowLeft" size={18} />
                  Back
                </button>

                {/* Profile Header */}
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <div className="flex flex-col md:flex-row items-center md:items-start gap-6">
                    <div className="w-28 h-28 bg-zinc-700 rounded-full flex items-center justify-center text-4xl font-black border-4 border-orange-600 flex-shrink-0">
                      {viewingProfile.name?.charAt(0)?.toUpperCase() || '?'}
                    </div>
                    <div className="flex-grow text-center md:text-left">
                      <h1 className="text-3xl font-black uppercase tracking-wide mb-2">{viewingProfile.name}</h1>
                      <p className="text-zinc-500 uppercase tracking-wider mb-4">
                        Climber since {new Date(viewingProfile.joinedAt || Date.now()).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                      </p>
                      {viewingProfile.id !== currentUserId && (
                        <div className="flex gap-2 flex-wrap justify-center md:justify-start">
                          <button
                            onClick={() => {
                              if (friends.includes(viewingProfile.id)) {
                                removeFriend(viewingProfile.id);
                              } else {
                                addFriend(viewingProfile.id);
                              }
                            }}
                            className={`px-6 py-3 rounded font-bold uppercase text-sm transition ${
                              friends.includes(viewingProfile.id)
                                ? 'bg-zinc-800 hover:bg-zinc-700 border border-zinc-700'
                                : 'bg-orange-600 hover:bg-orange-500'
                            }`}
                          >
                            <Icon name={friends.includes(viewingProfile.id) ? 'UserMinus' : 'UserPlus'} size={16} className="inline mr-2" />
                            {friends.includes(viewingProfile.id) ? 'Remove Friend' : 'Add Friend'}
                          </button>
                          {isAdmin && (
                            <button
                              onClick={() => {
                                if (bannedUsers.includes(viewingProfile.id)) {
                                  unbanUser(viewingProfile.id);
                                } else {
                                  if (confirm(`Ban ${viewingProfile.name}? They will not be able to use the app.`)) {
                                    banUser(viewingProfile.id);
                                  }
                                }
                              }}
                              className={`px-6 py-3 rounded font-bold uppercase text-sm transition ${
                                bannedUsers.includes(viewingProfile.id)
                                  ? 'bg-green-600 hover:bg-green-500'
                                  : 'bg-red-600 hover:bg-red-500'
                              }`}
                            >
                              <Icon name={bannedUsers.includes(viewingProfile.id) ? 'UserCheck' : 'Ban'} size={16} className="inline mr-2" />
                              {bannedUsers.includes(viewingProfile.id) ? 'Unban User' : 'Ban User'}
                            </button>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Stats Grid */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="bg-zinc-900 rounded-lg p-5 text-center border border-zinc-800 shadow-xl">
                    <div className="text-3xl font-black text-orange-500">{viewingProfile.totalSends || 0}</div>
                    <div className="text-xs text-zinc-500 uppercase tracking-wider mt-1">Total Sends</div>
                  </div>
                  <div className="bg-zinc-900 rounded-lg p-5 text-center border border-zinc-800 shadow-xl">
                    <div className="text-3xl font-black text-orange-500">
                      {problems.filter(p => p.setterId === viewingProfile.id).length}
                    </div>
                    <div className="text-xs text-zinc-500 uppercase tracking-wider mt-1">Problems Set</div>
                  </div>
                  <div className="bg-zinc-900 rounded-lg p-5 text-center border border-zinc-800 shadow-xl">
                    <div className="text-3xl font-black text-orange-500">
                      {viewingProfile.highestGrade || '--'}
                    </div>
                    <div className="text-xs text-zinc-500 uppercase tracking-wider mt-1">Highest Send</div>
                  </div>
                  <div className="bg-zinc-900 rounded-lg p-5 text-center border border-zinc-800 shadow-xl">
                    <div className="text-3xl font-black text-orange-500">
                      {(() => {
                        const userSendsForProfile = activityFeed.filter(a => a.userId === viewingProfile.id && a.type === 'send' && a.isFlash);
                        return userSendsForProfile.length;
                      })()}
                    </div>
                    <div className="text-xs text-zinc-500 uppercase tracking-wider mt-1">Flashes</div>
                  </div>
                </div>

                {/* Grade Pyramid */}
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <h2 className="text-xl font-black uppercase tracking-wide mb-4 pb-3 border-b-2 border-orange-600">
                    <Icon name="BarChart2" size={20} className="inline mr-2" />
                    Grade Pyramid
                  </h2>
                  {(() => {
                    const userSendsData = activityFeed.filter(a => a.userId === viewingProfile.id && a.type === 'send');
                    const gradeCounts = {};
                    userSendsData.forEach(send => {
                      const grade = send.suggestedGrade || send.grade || 'V?';
                      gradeCounts[grade] = (gradeCounts[grade] || 0) + 1;
                    });
                    const sortedGrades = grades.filter(g => gradeCounts[g]);
                    const maxCount = Math.max(...Object.values(gradeCounts), 1);

                    if (sortedGrades.length === 0) {
                      return <p className="text-zinc-500 text-center py-8 uppercase tracking-wide">No sends recorded yet</p>;
                    }

                    return (
                      <div className="space-y-2">
                        {sortedGrades.map(grade => (
                          <div key={grade} className="flex items-center gap-3">
                            <span className="w-12 text-right font-bold text-sm">{grade}</span>
                            <div className="flex-grow bg-zinc-950 rounded h-8 overflow-hidden border border-zinc-800">
                              <div
                                className="h-full bg-gradient-to-r from-orange-600 to-orange-500 flex items-center justify-end pr-2 transition-all duration-500"
                                style={{ width: `${(gradeCounts[grade] / maxCount) * 100}%`, minWidth: gradeCounts[grade] > 0 ? '30px' : '0' }}
                              >
                                <span className="text-xs font-bold">{gradeCounts[grade]}</span>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    );
                  })()}
                </div>

                {/* Mutual Friends */}
                {viewingProfile.id !== currentUserId && (
                  <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                    <h2 className="text-xl font-black uppercase tracking-wide mb-4 pb-3 border-b-2 border-orange-600">
                      <Icon name="Users" size={20} className="inline mr-2" />
                      Mutual Friends
                    </h2>
                    {(() => {
                      // This would require storing friends per user - for now show a placeholder
                      const mutualCount = 0; // Placeholder
                      if (mutualCount === 0) {
                        return <p className="text-zinc-500 text-center py-4 uppercase tracking-wide text-sm">No mutual friends yet</p>;
                      }
                      return <p className="text-zinc-400">{mutualCount} mutual friends</p>;
                    })()}
                  </div>
                )}

                {/* Problems Set by User */}
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <h2 className="text-xl font-black uppercase tracking-wide mb-4 pb-3 border-b-2 border-orange-600">
                    <Icon name="Edit3" size={20} className="inline mr-2" />
                    Problems Set ({problems.filter(p => p.setterId === viewingProfile.id).length})
                  </h2>
                  {problems.filter(p => p.setterId === viewingProfile.id).length === 0 ? (
                    <p className="text-zinc-500 text-center py-8 uppercase tracking-wide">No problems set yet</p>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {problems
                        .filter(p => p.setterId === viewingProfile.id)
                        .slice(0, 10)
                        .map(problem => (
                          <div
                            key={problem.id}
                            onClick={() => viewProblemDetail(problem, 'archive')}
                            className="bg-zinc-950 rounded-lg p-4 border border-zinc-800 hover:border-orange-600 cursor-pointer transition flex items-center gap-4"
                          >
                            {problem.wallImage && (
                              <div className="w-16 h-16 rounded overflow-hidden flex-shrink-0 border border-zinc-700">
                                <img src={problem.wallImage} alt={problem.name} className="w-full h-full object-cover" />
                              </div>
                            )}
                            <div className="flex-grow min-w-0">
                              <div className="font-bold truncate">{problem.name}</div>
                              <div className="text-xs text-zinc-500">{problem.sends} sends</div>
                            </div>
                            <span className="bg-orange-600 px-3 py-1 rounded font-black text-sm flex-shrink-0">{problem.grade}</span>
                          </div>
                        ))}
                    </div>
                  )}
                  {problems.filter(p => p.setterId === viewingProfile.id).length > 10 && (
                    <p className="text-center text-zinc-500 text-sm mt-4 uppercase tracking-wide">
                      Showing 10 of {problems.filter(p => p.setterId === viewingProfile.id).length} problems
                    </p>
                  )}
                </div>

                {/* Recent Activity */}
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <h2 className="text-xl font-black uppercase tracking-wide mb-4 pb-3 border-b-2 border-orange-600">
                    <Icon name="Activity" size={20} className="inline mr-2" />
                    Recent Activity
                  </h2>
                  {activityFeed.filter(a => a.userId === viewingProfile.id).length === 0 ? (
                    <p className="text-zinc-500 text-center py-8 uppercase tracking-wide">No activity yet</p>
                  ) : (
                    <div className="space-y-3">
                      {activityFeed
                        .filter(a => a.userId === viewingProfile.id)
                        .slice(0, 15)
                        .map(activity => (
                          <div
                            key={activity.id}
                            onClick={() => {
                              if (activity.problemId) {
                                const problem = problems.find(p => p.id === activity.problemId);
                                if (problem) viewProblemDetail(problem, 'archive');
                              }
                            }}
                            className="bg-zinc-950 rounded p-4 border border-zinc-800 hover:border-zinc-700 transition cursor-pointer flex items-center gap-4"
                          >
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ${
                              activity.type === 'send' ? (activity.isFlash ? 'bg-yellow-600' : 'bg-green-600') :
                              activity.type === 'set' ? 'bg-blue-600' :
                              activity.type === 'video' ? 'bg-purple-600' : 'bg-zinc-700'
                            }`}>
                              <Icon
                                name={
                                  activity.type === 'send' ? (activity.isFlash ? 'Zap' : 'Check') :
                                  activity.type === 'set' ? 'Edit3' :
                                  activity.type === 'video' ? 'Video' : 'Activity'
                                }
                                size={18}
                              />
                            </div>
                            <div className="flex-grow min-w-0">
                              <p className="text-sm truncate">{activity.message}</p>
                              <p className="text-xs text-zinc-500">
                                {new Date(activity.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                {' at '}
                                {new Date(activity.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                              </p>
                            </div>
                            {activity.grade && (
                              <span className={`px-2 py-1 rounded text-xs font-bold flex-shrink-0 ${
                                activity.type === 'send' ? 'bg-green-600' : 'bg-blue-600'
                              }`}>
                                {activity.grade}
                              </span>
                            )}
                          </div>
                        ))}
                    </div>
                  )}
                </div>
              </div>
            ) : (
              /* USER VIEW */
              <div className="space-y-6">
                {/* Profile Card */}
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <div className="flex items-center justify-between mb-4 pb-3 border-b-2 border-orange-600">
                    <h2 className="text-xl font-black uppercase tracking-wide">
                      <Icon name="User" size={20} className="inline mr-2" />
                      My Profile
                      {isAdmin && (
                        <span className="ml-2 text-xs bg-red-600 text-white px-2 py-1 rounded uppercase">Admin</span>
                      )}
                    </h2>
                    <button
                      onClick={signOut}
                      className="text-sm text-zinc-400 hover:text-white flex items-center gap-1 transition"
                    >
                      <Icon name="LogOut" size={16} />
                      Sign Out
                    </button>
                  </div>
                  <div className="flex items-center gap-6 mb-6">
                    <div className="relative">
                      <div className="w-24 h-24 bg-zinc-800 rounded-full flex items-center justify-center border-2 border-orange-600 overflow-hidden">
                        {authUser?.photoURL ? (
                          <img src={authUser.photoURL} alt="Profile" className="w-full h-full object-cover" />
                        ) : profilePicture ? (
                          <img src={profilePicture} alt="Profile" className="w-full h-full object-cover" />
                        ) : (
                          <Icon name="User" size={48} className="text-orange-500" />
                        )}
                      </div>
                      <label className="absolute bottom-0 right-0 bg-orange-600 rounded-full p-2 cursor-pointer hover:bg-orange-500 transition" title="Change photo">
                        <Icon name="Camera" size={14} />
                        <input
                          type="file"
                          accept="image/*"
                          className="hidden"
                          onChange={(e) => {
                            const file = e.target.files[0];
                            if (file) {
                              const reader = new FileReader();
                              reader.onload = (ev) => updateProfilePicture(ev.target.result);
                              reader.readAsDataURL(file);
                            }
                          }}
                        />
                      </label>
                    </div>
                    <div className="flex-grow">
                      <div className="mb-2">
                        <label className="block text-xs text-zinc-500 uppercase tracking-wider mb-1">Display Name</label>
                        <input
                          type="text"
                          value={currentUserName}
                          onChange={(e) => updateUserName(e.target.value)}
                          className="text-2xl font-black bg-zinc-950 border-2 border-zinc-700 focus:border-orange-600 rounded px-3 py-2 outline-none transition w-full"
                          placeholder="Enter your name"
                        />
                      </div>
                      <p className="text-zinc-600 text-xs">Your name is visible to other climbers on the leaderboard and your problems</p>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div className="bg-zinc-950 rounded p-4 border border-zinc-800">
                      <div className="text-2xl font-black text-orange-500">{userSends.length}</div>
                      <div className="text-xs text-zinc-500 uppercase tracking-wider">Total Sends</div>
                    </div>
                    <div className="bg-zinc-950 rounded p-4 border border-zinc-800">
                      <div className="text-2xl font-black text-orange-500">{problems.filter(p => p.setterId === currentUserId).length}</div>
                      <div className="text-xs text-zinc-500 uppercase tracking-wider">Problems Set</div>
                    </div>
                    <div className="bg-zinc-950 rounded p-4 border border-zinc-800">
                      <div className="text-2xl font-black text-orange-500">{userSends.filter(s => s.isFlash).length}</div>
                      <div className="text-xs text-zinc-500 uppercase tracking-wider">Flashes</div>
                    </div>
                    <div className="bg-zinc-950 rounded p-4 border border-zinc-800">
                      <div className="text-2xl font-black text-orange-500">
                        {userSends.length > 0
                          ? grades[Math.max(...userSends.map(s => grades.indexOf(s.suggestedGrade || s.grade)))] || '--'
                          : '--'}
                      </div>
                      <div className="text-xs text-zinc-500 uppercase tracking-wider">Highest Grade</div>
                    </div>
                  </div>
                </div>

                {/* My Problems Set */}
                {problems.filter(p => p.setterId === currentUserId).length > 0 && (
                  <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                    <h2 className="text-xl font-black uppercase tracking-wide mb-4 pb-3 border-b-2 border-orange-600">
                      <Icon name="Edit3" size={20} className="inline mr-2" />
                      My Problems ({problems.filter(p => p.setterId === currentUserId).length})
                    </h2>
                    <div className="space-y-3 max-h-80 overflow-y-auto">
                      {problems
                        .filter(p => p.setterId === currentUserId)
                        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                        .map(problem => (
                          <div
                            key={problem.id}
                            onClick={() => viewProblemDetail(problem, 'archive')}
                            className="bg-zinc-950 rounded-lg p-4 border border-zinc-800 hover:border-orange-600 cursor-pointer transition flex items-center gap-4"
                          >
                            {problem.wallImage && (
                              <div className="w-16 h-16 rounded overflow-hidden flex-shrink-0 border border-zinc-700">
                                <img src={problem.wallImage} alt={problem.name} className="w-full h-full object-cover" />
                              </div>
                            )}
                            <div className="flex-grow min-w-0">
                              <div className="font-bold truncate">{problem.name}</div>
                              <div className="text-xs text-zinc-500">{problem.sends} sends â€¢ {new Date(problem.createdAt).toLocaleDateString()}</div>
                            </div>
                            <span className="bg-orange-600 px-3 py-1 rounded font-black text-sm flex-shrink-0">{problem.grade}</span>
                          </div>
                        ))}
                    </div>
                  </div>
                )}

                {/* Circuits / Folders */}
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <div className="flex items-center justify-between mb-4 pb-3 border-b-2 border-orange-600">
                    <h2 className="text-xl font-black uppercase tracking-wide">
                      <Icon name="Folder" size={20} className="inline mr-2" />
                      My Circuits ({circuits.length})
                    </h2>
                    <button
                      onClick={() => setShowCircuitModal(true)}
                      className="bg-orange-600 hover:bg-orange-500 px-4 py-2 rounded font-bold uppercase text-sm transition flex items-center gap-2"
                    >
                      <Icon name="Plus" size={16} />
                      New Circuit
                    </button>
                  </div>

                  {circuits.length === 0 ? (
                    <div className="text-center py-8">
                      <Icon name="Folder" size={48} className="mx-auto text-zinc-700 mb-3" />
                      <p className="text-zinc-500 uppercase tracking-wide text-sm">No circuits yet</p>
                      <p className="text-zinc-600 text-xs mt-1">Create circuits to group problems for your sessions</p>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {circuits.map(circuit => (
                        <div
                          key={circuit.id}
                          className="bg-zinc-950 rounded-lg border border-zinc-800 overflow-hidden"
                        >
                          <div
                            className="p-4 flex items-center justify-between cursor-pointer hover:bg-zinc-900 transition"
                            onClick={() => setActiveCircuit(activeCircuit?.id === circuit.id ? null : circuit)}
                          >
                            <div className="flex items-center gap-3">
                              <div
                                className="w-4 h-4 rounded-full flex-shrink-0"
                                style={{ backgroundColor: circuit.color }}
                              />
                              <div>
                                <h3 className="font-bold">{circuit.name}</h3>
                                <p className="text-xs text-zinc-500">
                                  {circuit.problemIds.length} problem{circuit.problemIds.length !== 1 ? 's' : ''}
                                </p>
                              </div>
                            </div>
                            <div className="flex items-center gap-2">
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setEditingCircuit(circuit);
                                  setNewCircuitName(circuit.name);
                                  setShowCircuitModal(true);
                                }}
                                className="p-2 text-zinc-500 hover:text-orange-500 transition"
                                title="Edit circuit"
                              >
                                <Icon name="Edit2" size={16} />
                              </button>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  if (confirm(`Delete "${circuit.name}"?`)) {
                                    deleteCircuit(circuit.id);
                                  }
                                }}
                                className="p-2 text-zinc-500 hover:text-red-500 transition"
                                title="Delete circuit"
                              >
                                <Icon name="Trash2" size={16} />
                              </button>
                              <Icon
                                name="ChevronDown"
                                size={20}
                                className={`text-zinc-500 transition-transform ${activeCircuit?.id === circuit.id ? 'rotate-180' : ''}`}
                              />
                            </div>
                          </div>

                          {activeCircuit?.id === circuit.id && (
                            <div className="border-t border-zinc-800 p-4 bg-zinc-900/50">
                              {circuit.problemIds.length === 0 ? (
                                <p className="text-zinc-500 text-sm text-center py-4">
                                  No problems in this circuit yet. Add problems from the archive or problem detail view.
                                </p>
                              ) : (
                                <div className="space-y-2">
                                  {circuit.problemIds.map((problemId, index) => {
                                    const problem = problems.find(p => p.id === problemId);
                                    if (!problem) return null;
                                    return (
                                      <div
                                        key={problemId}
                                        className="bg-zinc-950 rounded p-3 flex items-center gap-3 border border-zinc-800 hover:border-orange-600 transition"
                                      >
                                        <span
                                          className="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0"
                                          style={{ backgroundColor: circuit.color }}
                                        >
                                          {index + 1}
                                        </span>
                                        {problem.wallImage && (
                                          <div className="w-10 h-10 rounded overflow-hidden flex-shrink-0 border border-zinc-700">
                                            <img src={problem.wallImage} alt={problem.name} className="w-full h-full object-cover" />
                                          </div>
                                        )}
                                        <div
                                          className="flex-grow min-w-0 cursor-pointer"
                                          onClick={() => {
                                            saveNavigationHistory();
                                            setCameFromCircuit(circuit);
                                            setProblemListSource('circuit');
                                            setSelectedProblem(problem);
                                            setActiveTab('detail');
                                          }}
                                        >
                                          <div className="font-bold text-sm truncate hover:text-orange-500 transition">{problem.name}</div>
                                          <div className="text-xs text-zinc-500">{problem.grade}</div>
                                        </div>
                                        {userSends.some(s => s.problemId === problemId) && (
                                          <div className="bg-green-600 rounded-full p-1 flex-shrink-0">
                                            <Icon name="Check" size={12} />
                                          </div>
                                        )}
                                        <button
                                          onClick={() => removeProblemFromCircuit(circuit.id, problemId)}
                                          className="p-1 text-zinc-500 hover:text-red-500 transition flex-shrink-0"
                                          title="Remove from circuit"
                                        >
                                          <Icon name="X" size={16} />
                                        </button>
                                      </div>
                                    );
                                  })}
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Admin Panel */}
                {isAdmin && (
                  <div className="bg-zinc-900 rounded-lg p-6 border border-red-800 shadow-xl">
                    <h2 className="text-xl font-black uppercase tracking-wide mb-4 pb-3 border-b-2 border-red-600">
                      <Icon name="Shield" size={20} className="inline mr-2" />
                      Admin Panel
                    </h2>

                    {/* Merge Users Tool */}
                    <div className="mb-6">
                      <h3 className="text-sm font-bold uppercase tracking-wider text-zinc-400 mb-3">Merge Users</h3>
                      <p className="text-xs text-zinc-500 mb-3">Transfer all data from an old user account to a new one (for migrating users to Google auth).</p>

                      {/* Dropdown selection */}
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                          <label className="block text-xs text-zinc-500 mb-1">Old User (to merge FROM)</label>
                          <select
                            id="mergeOldUser"
                            className="w-full bg-zinc-950 border border-zinc-700 rounded px-3 py-2 text-sm"
                          >
                            <option value="">Select old user...</option>
                            {allUsers.map(u => (
                              <option key={u.id} value={u.id}>{u.name} ({u.id.substring(0, 8)}...)</option>
                            ))}
                          </select>
                        </div>
                        <div>
                          <label className="block text-xs text-zinc-500 mb-1">New User (to merge INTO)</label>
                          <select
                            id="mergeNewUser"
                            className="w-full bg-zinc-950 border border-zinc-700 rounded px-3 py-2 text-sm"
                          >
                            <option value="">Select new user...</option>
                            {allUsers.map(u => (
                              <option key={u.id} value={u.id}>{u.name} ({u.id.substring(0, 8)}...)</option>
                            ))}
                          </select>
                        </div>
                      </div>

                      {/* Manual ID input (for users not in dropdown) */}
                      <details className="mb-3">
                        <summary className="text-xs text-amber-500 cursor-pointer hover:text-amber-400">
                          Or enter user IDs manually (for users not in dropdown)
                        </summary>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 p-3 bg-zinc-950 rounded border border-zinc-800">
                          <div>
                            <label className="block text-xs text-zinc-500 mb-1">Old User ID</label>
                            <input
                              type="text"
                              id="mergeOldUserManual"
                              placeholder="Paste old user ID..."
                              className="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm font-mono"
                            />
                          </div>
                          <div>
                            <label className="block text-xs text-zinc-500 mb-1">New User ID</label>
                            <input
                              type="text"
                              id="mergeNewUserManual"
                              placeholder="Paste new user ID..."
                              className="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm font-mono"
                            />
                          </div>
                        </div>
                      </details>

                      <button
                        onClick={() => {
                          // Check manual inputs first, then dropdowns
                          const oldUserManual = document.getElementById('mergeOldUserManual')?.value?.trim();
                          const newUserManual = document.getElementById('mergeNewUserManual')?.value?.trim();
                          const oldUserDropdown = document.getElementById('mergeOldUser').value;
                          const newUserDropdown = document.getElementById('mergeNewUser').value;

                          const oldUser = oldUserManual || oldUserDropdown;
                          const newUser = newUserManual || newUserDropdown;

                          if (oldUser && newUser && oldUser !== newUser) {
                            if (confirm(`Merge user ${oldUser.substring(0, 12)}... INTO ${newUser.substring(0, 12)}...?\n\nThis will transfer all problems, sends, and comments from the old user to the new user, then delete the old user account.`)) {
                              mergeUsers(oldUser, newUser);
                            }
                          } else {
                            alert('Please select or enter two different users');
                          }
                        }}
                        className="bg-red-600 hover:bg-red-500 px-4 py-2 rounded font-bold uppercase text-sm transition"
                      >
                        Merge Users
                      </button>
                    </div>

                    {/* Banned Users List */}
                    <div className="mb-6">
                      <h3 className="text-sm font-bold uppercase tracking-wider text-zinc-400 mb-3">Banned Users ({bannedUsers.length})</h3>
                      {bannedUsers.length === 0 ? (
                        <p className="text-xs text-zinc-500">No banned users</p>
                      ) : (
                        <div className="space-y-2">
                          {bannedUsers.map(userId => {
                            const user = allUsers.find(u => u.id === userId);
                            return (
                              <div key={userId} className="flex items-center justify-between bg-zinc-950 p-3 rounded border border-zinc-800">
                                <span className="text-sm">{user?.name || userId}</span>
                                <button
                                  onClick={() => unbanUser(userId)}
                                  className="text-xs bg-green-600 hover:bg-green-500 px-3 py-1 rounded font-bold uppercase"
                                >
                                  Unban
                                </button>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>

                    {/* Featured Problems List */}
                    <div>
                      <h3 className="text-sm font-bold uppercase tracking-wider text-zinc-400 mb-3">Featured Problems ({featuredProblems.length})</h3>
                      {featuredProblems.length === 0 ? (
                        <p className="text-xs text-zinc-500">No featured problems. Feature problems from the problem detail view.</p>
                      ) : (
                        <div className="space-y-2">
                          {featuredProblems.map(problemId => {
                            const problem = problems.find(p => p.id === problemId);
                            return (
                              <div key={problemId} className="flex items-center justify-between bg-zinc-950 p-3 rounded border border-zinc-800">
                                <span className="text-sm">{problem?.name || problemId} ({problem?.grade})</span>
                                <button
                                  onClick={() => featureProblem(problemId)}
                                  className="text-xs bg-zinc-700 hover:bg-zinc-600 px-3 py-1 rounded font-bold uppercase"
                                >
                                  Unfeature
                                </button>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* Achievements */}
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <h2 className="text-xl font-black uppercase tracking-wide mb-4 pb-3 border-b-2 border-orange-600">
                    <Icon name="Award" size={20} className="inline mr-2" />
                    Achievements ({getEarnedAchievements().length}/{achievementDefs.length})
                  </h2>
                  <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                    {achievementDefs.map(achievement => {
                      const earned = getEarnedAchievements().some(a => a.id === achievement.id);
                      return (
                        <div
                          key={achievement.id}
                          className={`p-4 rounded-lg border text-center transition ${
                            earned
                              ? 'bg-gradient-to-b from-orange-900/30 to-zinc-900 border-orange-600'
                              : 'bg-zinc-950 border-zinc-800 opacity-40'
                          }`}
                          title={achievement.description}
                        >
                          <div className={`mb-2 ${earned ? 'text-orange-500' : 'text-zinc-600'}`}>
                            <Icon name={achievement.icon} size={28} />
                          </div>
                          <p className={`text-xs font-bold uppercase tracking-wider ${earned ? 'text-white' : 'text-zinc-600'}`}>
                            {achievement.name}
                          </p>
                          <p className="text-xs text-zinc-500 mt-1">{achievement.description}</p>
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Friend Activity Feed */}
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <h2 className="text-xl font-black uppercase tracking-wide mb-4 pb-3 border-b-2 border-orange-600">
                    <Icon name="Activity" size={20} className="inline mr-2" />
                    Activity Feed
                  </h2>
                  {activityFeed.filter(a => friends.includes(a.userId) || a.userId === currentUserId).length === 0 ? (
                    <p className="text-zinc-500 text-center py-8 uppercase tracking-wide">No activity yet. Add friends to see their sends!</p>
                  ) : (
                    <div className="space-y-3 max-h-96 overflow-y-auto">
                      {activityFeed
                        .filter(a => friends.includes(a.userId) || a.userId === currentUserId)
                        .slice(0, 20)
                        .map(activity => (
                          <div
                            key={activity.id}
                            className="bg-zinc-950 rounded p-4 border border-zinc-800 hover:border-zinc-700 transition cursor-pointer"
                            onClick={() => {
                              if (activity.problemId) {
                                const problem = problems.find(p => p.id === activity.problemId);
                                if (problem) viewProblemDetail(problem, 'archive');
                              }
                            }}
                          >
                            <div className="flex items-center gap-3">
                              <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                activity.type === 'send' ? (activity.isFlash ? 'bg-yellow-600' : 'bg-green-600') :
                                activity.type === 'set' ? 'bg-blue-600' :
                                activity.type === 'video' ? 'bg-purple-600' : 'bg-zinc-700'
                              }`}>
                                <Icon
                                  name={
                                    activity.type === 'send' ? (activity.isFlash ? 'Zap' : 'Check') :
                                    activity.type === 'set' ? 'Edit3' :
                                    activity.type === 'video' ? 'Video' : 'Activity'
                                  }
                                  size={16}
                                />
                              </div>
                              <div className="flex-grow">
                                <p className="text-sm">
                                  <span
                                    className="font-bold text-orange-500 hover:underline cursor-pointer"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      const user = allUsers.find(u => u.id === activity.userId);
                                      if (user) viewUserProfile(user);
                                    }}
                                  >{activity.userName}</span>
                                  {' '}{activity.message}
                                </p>
                                <p className="text-xs text-zinc-500">
                                  {new Date(activity.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                  {' at '}
                                  {new Date(activity.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                                </p>
                              </div>
                              {activity.grade && (
                                <span className={`px-2 py-1 rounded text-xs font-bold ${
                                  activity.type === 'send' ? 'bg-green-600' : 'bg-blue-600'
                                }`}>
                                  {activity.grade}
                                </span>
                              )}
                            </div>
                          </div>
                        ))}
                    </div>
                  )}
                </div>

                {/* Grade Distribution Chart */}
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <h2 className="text-xl font-black uppercase tracking-wide mb-4 pb-3 border-b-2 border-orange-600">
                    <Icon name="BarChart2" size={20} className="inline mr-2" />
                    Grade Distribution
                  </h2>
                  {userSends.length === 0 ? (
                    <p className="text-zinc-500 text-center py-8 uppercase tracking-wide">Log some sends to see your grade distribution!</p>
                  ) : (
                    <div className="space-y-2">
                      {grades.map(grade => {
                        const count = userSends.filter(s => (s.suggestedGrade || s.grade) === grade).length;
                        const maxCount = Math.max(...grades.map(g => userSends.filter(s => (s.suggestedGrade || s.grade) === g).length));
                        const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
                        if (count === 0) return null;
                        return (
                          <div key={grade} className="flex items-center gap-3">
                            <span className="w-10 text-sm font-bold text-zinc-400">{grade}</span>
                            <div className="flex-grow h-6 bg-zinc-950 rounded overflow-hidden border border-zinc-800">
                              <div
                                className="h-full bg-gradient-to-r from-orange-600 to-orange-400 transition-all duration-500"
                                style={{ width: `${percentage}%` }}
                              />
                            </div>
                            <span className="w-8 text-sm font-bold text-orange-500">{count}</span>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>

                {/* Projects */}
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <h2 className="text-xl font-black uppercase tracking-wide mb-4 pb-3 border-b-2 border-orange-600">
                    <Icon name="Bookmark" size={20} className="inline mr-2" />
                    My Projects ({projects.length})
                  </h2>
                  {projects.length === 0 ? (
                    <p className="text-zinc-500 text-center py-8 uppercase tracking-wide">No projects yet. Mark problems as projects to track them here!</p>
                  ) : (
                    <div className="space-y-3">
                      {projects.map(projectId => {
                        const problem = problems.find(p => p.id === projectId);
                        if (!problem) return null;
                        const problemAttempts = attempts[projectId]?.attempts || 0;
                        return (
                          <div
                            key={projectId}
                            className="bg-zinc-950 rounded p-4 flex items-center gap-4 border border-zinc-800 hover:border-purple-600 transition cursor-pointer"
                            onClick={() => viewProblemDetail(problem, 'archive')}
                          >
                            {problem.wallImage && (
                              <div className="w-12 h-12 rounded overflow-hidden border border-zinc-700 flex-shrink-0">
                                <img src={problem.wallImage} alt={problem.name} className="w-full h-full object-cover" />
                              </div>
                            )}
                            <div className="flex-grow">
                              <h3 className="font-bold">{problem.name}</h3>
                              <p className="text-xs text-zinc-500">{problemAttempts} attempts</p>
                            </div>
                            <span className="bg-purple-600 px-3 py-1 rounded font-bold text-sm">
                              {getConsensusGrade(problem.id)?.grade || problem.grade}
                            </span>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>

                {/* Session History */}
                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <h2 className="text-xl font-black uppercase tracking-wide mb-4 pb-3 border-b-2 border-orange-600">
                    <Icon name="Calendar" size={20} className="inline mr-2" />
                    Session History
                  </h2>
                  {sessionHistory.length === 0 ? (
                    <p className="text-zinc-500 text-center py-8 uppercase tracking-wide">No completed sessions yet. Start a session to track your climbing!</p>
                  ) : (
                    <div className="space-y-3">
                      {sessionHistory.slice(0, 10).map((session, index) => {
                        const duration = session.endTime
                          ? Math.round((new Date(session.endTime) - new Date(session.startTime)) / 60000)
                          : 0;
                        const sends = session.problems?.filter(p => p.type === 'send').length || 0;
                        const sessionAttempts = session.problems?.filter(p => p.type === 'attempt').length || 0;
                        return (
                          <div key={session.id || index} className="bg-zinc-950 rounded p-4 border border-zinc-800">
                            <div className="flex justify-between items-start mb-2">
                              <div>
                                <h3 className="font-bold">{new Date(session.startTime).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</h3>
                                <p className="text-xs text-zinc-500">{new Date(session.startTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</p>
                              </div>
                              <span className="text-xs text-zinc-500">{duration}m</span>
                            </div>
                            <div className="flex gap-4 text-sm">
                              <span className="text-green-500 font-bold">{sends} sends</span>
                              <span className="text-zinc-400">{sessionAttempts} attempts</span>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>

                <div className="bg-zinc-900 rounded-lg p-6 border border-zinc-800 shadow-xl">
                  <h2 className="text-xl font-black uppercase tracking-wide mb-4 pb-3 border-b-2 border-orange-600">
                    <Icon name="Users" size={20} className="inline mr-2" />
                    Friends ({friends.length})
                  </h2>

                  {/* Add Friend Search */}
                  <div className="mb-4">
                    <label className="block text-xs font-bold mb-2 uppercase tracking-wider text-zinc-400">Add Friend by Name</label>
                    <div className="relative">
                      <Icon name="Search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500" />
                      <input
                        type="text"
                        value={friendSearch}
                        onChange={(e) => setFriendSearch(e.target.value)}
                        className="w-full bg-zinc-950 border border-zinc-700 focus:border-orange-600 rounded pl-10 pr-4 py-3 transition outline-none"
                        placeholder="Search for climbers..."
                      />
                    </div>
                    {friendSearch.trim() && (
                      <div className="mt-2 bg-zinc-950 border border-zinc-700 rounded max-h-48 overflow-y-auto">
                        {allUsers
                          .filter(u =>
                            u.id !== currentUserId &&
                            !friends.includes(u.id) &&
                            u.name.toLowerCase().includes(friendSearch.toLowerCase())
                          )
                          .slice(0, 5)
                          .map(user => (
                            <div
                              key={user.id}
                              className="p-3 flex items-center justify-between hover:bg-zinc-900 border-b border-zinc-800 last:border-b-0"
                            >
                              <div>
                                <span className="font-bold">{user.name}</span>
                                <span className="text-xs text-zinc-500 ml-2">{user.totalSends || 0} sends</span>
                              </div>
                              <button
                                onClick={() => { addFriend(user.id); setFriendSearch(''); }}
                                className="bg-orange-600 hover:bg-orange-500 px-3 py-1 rounded text-xs font-bold uppercase transition"
                              >
                                Add
                              </button>
                            </div>
                          ))
                        }
                        {allUsers.filter(u =>
                          u.id !== currentUserId &&
                          !friends.includes(u.id) &&
                          u.name.toLowerCase().includes(friendSearch.toLowerCase())
                        ).length === 0 && (
                          <p className="p-3 text-zinc-500 text-sm text-center">No climbers found</p>
                        )}
                      </div>
                    )}
                  </div>

                  {/* Friends List */}
                  {friends.length === 0 ? (
                    <p className="text-zinc-500 text-center py-6 uppercase tracking-wide text-sm">No friends yet. Search above or add friends from comments!</p>
                  ) : (
                    <div className="space-y-3">
                      {friends.map(friendId => {
                        const friend = allUsers.find(u => u.id === friendId);
                        if (!friend) return null;
                        return (
                          <div key={friendId} className="bg-zinc-950 rounded p-4 flex items-center justify-between border border-zinc-800 hover:border-orange-600 transition">
                            <div
                              onClick={() => viewUserProfile(friend)}
                              className="cursor-pointer flex-1"
                            >
                              <h3 className="font-black uppercase tracking-wide hover:text-orange-500 transition">{friend.name}</h3>
                              <p className="text-xs text-zinc-500 uppercase tracking-wider">
                                {friend.totalSends || 0} sends â€¢ Tap to view profile
                              </p>
                            </div>
                            <button
                              onClick={(e) => { e.stopPropagation(); removeFriend(friendId); }}
                              className="bg-zinc-800 hover:bg-zinc-700 px-3 py-2 rounded font-bold uppercase text-xs transition border border-zinc-700 ml-2"
                            >
                              Remove
                            </button>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>

          {/* Bottom Navigation */}
          <div className="fixed bottom-0 left-0 right-0 bg-zinc-900 border-t-2 border-orange-600 shadow-2xl safe-area-bottom">
            <div className="max-w-7xl mx-auto flex items-center justify-around relative">
              <button
                onClick={() => setActiveTab('archive')}
                className={`flex flex-col items-center py-2 px-2 sm:px-4 transition flex-1 ${
                  activeTab === 'archive' || activeTab === 'detail' ? 'text-orange-500' : 'text-zinc-500 hover:text-white'
                }`}
              >
                <Icon name="Archive" size={22} />
                <span className="text-[10px] sm:text-xs mt-1 font-bold uppercase tracking-wide">Archive</span>
              </button>

              <button
                onClick={() => setActiveTab('logbook')}
                className={`flex flex-col items-center py-2 px-2 sm:px-4 transition flex-1 ${
                  activeTab === 'logbook' ? 'text-orange-500' : 'text-zinc-500 hover:text-white'
                }`}
              >
                <Icon name="BookOpen" size={22} />
                <span className="text-[10px] sm:text-xs mt-1 font-bold uppercase tracking-wide">Logbook</span>
              </button>

              <button
                onClick={() => setActiveTab('create')}
                className="absolute left-1/2 transform -translate-x-1/2 -translate-y-5 bg-orange-600 hover:bg-orange-500 rounded-full p-3 sm:p-4 shadow-2xl transition border-4 border-zinc-950"
              >
                <Icon name="Plus" size={28} />
              </button>

              <button
                onClick={() => setActiveTab('leaderboard')}
                className={`flex flex-col items-center py-2 px-2 sm:px-4 transition flex-1 ${
                  activeTab === 'leaderboard' ? 'text-orange-500' : 'text-zinc-500 hover:text-white'
                }`}
              >
                <Icon name="Trophy" size={22} />
                <span className="text-[10px] sm:text-xs mt-1 font-bold uppercase tracking-wide">Leaders</span>
              </button>

              <button
                onClick={() => setActiveTab('user')}
                className={`flex flex-col items-center py-2 px-2 sm:px-4 transition flex-1 ${
                  activeTab === 'user' ? 'text-orange-500' : 'text-zinc-500 hover:text-white'
                }`}
              >
                <Icon name="User" size={22} />
                <span className="text-[10px] sm:text-xs mt-1 font-bold uppercase tracking-wide">Profile</span>
              </button>
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<SprayWallApp />);
  </script>
</body>
</html>
